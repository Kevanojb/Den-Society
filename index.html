<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Den Society Game Analyser</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
      :root{
        --bg:#0b1020;
        --bg2:#131a30;
        --card:#181f3a;
        --accent:#4fd1c5;
        --accent-soft:rgba(79,209,197,0.15);
        --accent-soft2:rgba(79,209,197,0.07);
        --border:#2a3358;
        --text:#f7fafc;
        --muted:#a0aec0;
        --danger:#fc8181;
        --win:#9ae6b4;
        --shadow:0 18px 45px rgba(0,0,0,0.55);
        --shadow-soft:0 10px 30px rgba(0,0,0,0.35);
        --radius-lg:18px;
        --radius-xl:26px;
      }
      *{box-sizing:border-box;}
      body{
        margin:0;
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
        background:radial-gradient(circle at top, #243b53 0, #0b1020 52%);
        color:var(--text);
        min-height:100vh;
        display:flex;
        justify-content:center;
        padding:24px;
      }
      .app-shell{
        width:100%;
        max-width:1200px;
      }
      .header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        margin-bottom:16px;
        gap:16px;
      }
      .title-wrap{
        display:flex;
        align-items:center;
        gap:12px;
      }
      .logo-pill{
        width:42px;
        height:42px;
        border-radius:18px;
        background:radial-gradient(circle at 30% 20%,#a0aec0,#4fd1c5);
        box-shadow:0 10px 25px rgba(0,0,0,0.6);
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:800;
        color:#0b1020;
        letter-spacing:0.04em;
        font-size:18px;
      }
      .title{
        font-size:20px;
        font-weight:700;
        letter-spacing:0.03em;
        text-transform:uppercase;
      }
      .subtitle{
        font-size:13px;
        color:var(--muted);
      }
      .header-right{
        display:flex;
        gap:8px;
        align-items:center;
        flex-wrap:wrap;
        justify-content:flex-end;
      }
      .badge{
        font-size:11px;
        letter-spacing:0.08em;
        text-transform:uppercase;
        padding:4px 10px;
        border-radius:999px;
        border:1px solid var(--border);
        background:linear-gradient(135deg,rgba(15,23,42,0.7),rgba(30,64,175,0.7));
        color:var(--muted);
        display:inline-flex;
        align-items:center;
        gap:6px;
      }
      .badge-dot{
        width:8px;
        height:8px;
        border-radius:999px;
        background:radial-gradient(circle at 30% 30%,#f6e05e,#ecc94b);
        box-shadow:0 0 12px rgba(236,201,75,0.7);
      }
      .layout{
        display:grid;
        grid-template-columns:minmax(0,1.15fr) minmax(0,0.85fr);
        gap:18px;
      }
      @media(max-width:960px){
        body{padding:16px;}
        .layout{grid-template-columns:1fr;}
      }
      .card{
        border-radius:var(--radius-xl);
        background:radial-gradient(circle at top left,rgba(79,209,197,0.12),transparent 55%),radial-gradient(circle at bottom,rgba(45,55,72,0.9),#0b1020);
        border:1px solid rgba(148,163,184,0.18);
        box-shadow:var(--shadow);
        padding:18px 18px 16px;
        position:relative;
        overflow:hidden;
      }
      .card::before{
        content:"";
        position:absolute;
        inset:0;
        background:radial-gradient(circle at top,rgba(79,209,197,0.08),transparent 55%);
        opacity:0.6;
        pointer-events:none;
      }
      .card-inner{
        position:relative;
        z-index:1;
      }
      .card-header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:10px;
        gap:8px;
      }
      .card-title{
        font-size:15px;
        font-weight:600;
        letter-spacing:0.05em;
        text-transform:uppercase;
        color:#e2e8f0;
      }
      .card-title span{
        font-size:11px;
        font-weight:500;
        color:var(--muted);
        margin-left:6px;
      }
      .card-actions{
        display:flex;
        gap:6px;
        flex-wrap:wrap;
      }
      .pill-btn{
        font-size:11px;
        padding:4px 9px;
        border-radius:999px;
        border:1px solid var(--border);
        background:rgba(15,23,42,0.7);
        color:var(--muted);
        cursor:pointer;
        display:inline-flex;
        align-items:center;
        gap:6px;
        backdrop-filter:blur(10px);
      }
      .pill-btn.primary{
        border-color:rgba(79,209,197,0.5);
        background:radial-gradient(circle at 10% 0,rgba(79,209,197,0.24),rgba(15,23,42,0.9));
        color:#e6fffa;
      }
      .pill-btn.danger{
        border-color:rgba(252,129,129,0.5);
        color:var(--danger);
      }
      .pill-btn:disabled{
        opacity:0.45;
        cursor:default;
      }
      .pill-btn-label{
        text-transform:uppercase;
        letter-spacing:0.08em;
      }
      .pill-dot{
        width:7px;
        height:7px;
        border-radius:999px;
        background:var(--accent);
      }
      .dropzone{
        border-radius:16px;
        border:1px dashed rgba(148,163,184,0.45);
        background:linear-gradient(135deg,rgba(15,23,42,0.5),rgba(30,64,175,0.55));
        padding:16px;
        display:flex;
        align-items:flex-start;
        gap:14px;
        cursor:pointer;
        transition:all 0.18s ease-out;
      }
      .dropzone.dragover{
        border-style:solid;
        border-color:var(--accent);
        box-shadow:0 0 0 1px rgba(79,209,197,0.5),0 20px 40px rgba(15,118,110,0.6);
        transform:translateY(-1px);
      }
      .dropzone-icon{
        width:32px;
        height:32px;
        border-radius:14px;
        background:radial-gradient(circle at 30% 10%,#e6fffa,#4fd1c5);
        display:flex;
        align-items:center;
        justify-content:center;
        color:#1a202c;
        box-shadow:0 12px 30px rgba(0,0,0,0.7);
        flex-shrink:0;
      }
      .dropzone-content{
        flex:1;
      }
      .dropzone-title{
        font-size:14px;
        font-weight:600;
        margin-bottom:2px;
      }
      .dropzone-sub{
        font-size:12px;
        color:var(--muted);
      }
      .dropzone-meta{
        font-size:11px;
        color:#a3bffa;
        margin-top:6px;
      }
      .file-meta{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-top:10px;
        font-size:12px;
        color:var(--muted);
      }
      .file-meta strong{color:#e2e8f0;font-weight:500;}
      .file-tag{
        padding:2px 8px;
        border-radius:999px;
        background:rgba(15,118,110,0.2);
        border:1px solid rgba(34,197,178,0.6);
        color:#a7f3d0;
        font-size:11px;
        letter-spacing:0.06em;
        text-transform:uppercase;
      }
      .grid-two{
        display:grid;
        grid-template-columns:1.15fr 0.85fr;
        gap:10px;
      }
      @media(max-width:800px){
        .grid-two{grid-template-columns:1fr;}
      }
      .summary-card{
        border-radius:18px;
        border:1px solid rgba(148,163,184,0.2);
        background:linear-gradient(135deg,rgba(15,23,42,0.9),rgba(30,64,175,0.7));
        padding:12px 13px 11px;
        box-shadow:var(--shadow-soft);
      }
      .summary-row{
        display:flex;
        justify-content:space-between;
        align-items:center;
        font-size:12px;
        margin-bottom:4px;
      }
      .summary-label{
        color:var(--muted);
      }
      .summary-value{
        font-weight:600;
        color:#e2e8f0;
      }
      .summary-sub{
        font-size:11px;
        color:var(--muted);
        margin-top:4px;
      }
      .summary-main-number{
        font-size:24px;
        font-weight:700;
        letter-spacing:0.04em;
      }
      .summary-main-label{
        font-size:11px;
        text-transform:uppercase;
        letter-spacing:0.12em;
        color:var(--muted);
      }
      .summary-main{
        display:flex;
        align-items:flex-end;
        justify-content:space-between;
        margin-bottom:6px;
      }
      .summary-chip{
        font-size:11px;
        padding:2px 8px;
        border-radius:999px;
        background:rgba(15,23,42,0.7);
        border:1px solid rgba(148,163,184,0.4);
        color:var(--muted);
        text-transform:uppercase;
        letter-spacing:0.08em;
      }
      .summary-chip strong{color:#e2e8f0;font-weight:600;}
      .flex-row{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
      }
      .pill-small{
        font-size:11px;
        padding:3px 8px;
        border-radius:999px;
        border:1px solid var(--border);
        background:rgba(15,23,42,0.7);
        color:var(--muted);
      }
      .pill-small.good{
        border-color:rgba(56,161,105,0.7);
        color:#9ae6b4;
        background:rgba(22,101,52,0.25);
      }
      .pill-small.bad{
        border-color:rgba(229,62,62,0.7);
        color:var(--danger);
        background:rgba(153,27,27,0.3);
      }
      .table-wrap{
        border-radius:16px;
        border:1px solid rgba(148,163,184,0.2);
        background:radial-gradient(circle at top left,rgba(79,209,197,0.08),transparent 50%),rgba(15,23,42,0.92);
        overflow:hidden;
        margin-top:10px;
      }
      table{
        width:100%;
        border-collapse:collapse;
        font-size:12px;
      }
      thead{
        background:linear-gradient(135deg,rgba(15,23,42,0.9),rgba(30,64,175,0.8));
      }
      th,td{
        padding:6px 9px;
        text-align:left;
        border-bottom:1px solid rgba(55,65,81,0.7);
        white-space:nowrap;
      }
      th{
        font-size:11px;
        text-transform:uppercase;
        letter-spacing:0.08em;
        color:#a0aec0;
      }
      tbody tr:nth-child(even){
        background:rgba(15,23,42,0.85);
      }
      tbody tr:nth-child(odd){
        background:rgba(15,23,42,0.9);
      }
      tbody tr.highlight{
        background:rgba(22,163,74,0.2);
      }
      tbody tr:hover{
        background:rgba(79,209,197,0.18);
      }
      .pos-badge{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        min-width:24px;
        padding:2px 6px;
        border-radius:999px;
        font-size:11px;
        border:1px solid rgba(148,163,184,0.5);
      }
      .pos-badge.win{
        border-color:rgba(72,187,120,0.9);
        background:rgba(22,101,52,0.5);
        color:#c6f6d5;
      }
      .pos-badge.cut{
        border-color:rgba(239,68,68,0.8);
        background:rgba(127,29,29,0.55);
        color:#fed7d7;
      }
      .chip{
        font-size:11px;
        padding:2px 7px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,0.6);
        background:rgba(15,23,42,0.8);
      }
      .chip.win{
        border-color:rgba(72,187,120,0.9);
        color:#c6f6d5;
      }
      .chip.cut{
        border-color:rgba(239,68,68,0.8);
        color:#fed7d7;
      }
      .chip.csi-bad{
        border-color:rgba(251,191,36,0.9);
        color:#fefcbf;
      }
      .tag-pill{
        font-size:10px;
        padding:2px 6px;
        border-radius:999px;
        background:rgba(15,23,42,0.8);
        border:1px solid rgba(148,163,184,0.6);
        text-transform:uppercase;
        letter-spacing:0.08em;
        color:var(--muted);
      }
      .tag-pill.strong{
        border-color:rgba(79,209,197,0.9);
        color:#e6fffa;
      }
      .section-title{
        font-size:13px;
        text-transform:uppercase;
        letter-spacing:0.12em;
        color:#a0aec0;
        margin-bottom:6px;
      }
      .section-sub{
        font-size:11px;
        color:var(--muted);
        margin-bottom:8px;
      }
      .list-compact{
        list-style:none;
        margin:0;
        padding:0;
        font-size:12px;
      }
      .list-compact li{
        display:flex;
        justify-content:space-between;
        margin-bottom:3px;
        color:var(--muted);
      }
      .list-compact strong{color:#e2e8f0;font-weight:500;}
      .pill-mini{
        font-size:10px;
        padding:1px 6px;
        border-radius:999px;
        border:1px solid var(--border);
        background:rgba(15,23,42,0.9);
        color:var(--muted);
        text-transform:uppercase;
        letter-spacing:0.08em;
      }
      .footer-note{
        margin-top:14px;
        font-size:11px;
        color:var(--muted);
        opacity:0.9;
      }
      .footer-note span{
        color:#e2e8f0;
      }
      .score-badge{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        min-width:30px;
        padding:2px 6px;
        border-radius:999px;
        font-size:11px;
        border:1px solid rgba(148,163,184,0.5);
        background:rgba(15,23,42,0.9);
      }
      .score-badge.good{
        border-color:rgba(56,161,105,0.9);
        background:rgba(22,101,52,0.6);
        color:#c6f6d5;
      }
      .score-badge.bad{
        border-color:rgba(229,62,62,0.9);
        background:rgba(127,29,29,0.7);
        color:#fed7d7;
      }
      .hole-grid{
        display:grid;
        grid-template-columns:repeat(9,1fr);
        gap:2px;
        margin-top:4px;
      }
      .hole-cell{
        font-size:10px;
        padding:3px 0;
        border-radius:999px;
        background:rgba(15,23,42,0.9);
        border:1px solid rgba(55,65,81,0.9);
        text-align:center;
        color:#e2e8f0;
      }
      .hole-cell.good{
        border-color:rgba(56,161,105,0.9);
        background:rgba(22,101,52,0.7);
      }
      .hole-cell.bad{
        border-color:rgba(229,62,62,0.9);
        background:rgba(127,29,29,0.8);
      }
      .tag-row{
        display:flex;
        flex-wrap:wrap;
        gap:5px;
        margin-top:4px;
      }
      .empty-state{
        padding:12px;
        border-radius:14px;
        border:1px dashed rgba(148,163,184,0.4);
        background:rgba(15,23,42,0.85);
        font-size:12px;
        color:var(--muted);
      }
      .error{
        margin-top:8px;
        font-size:12px;
        color:var(--danger);
      }
      .spinner{
        border-radius:999px;
        width:14px;
        height:14px;
        border:2px solid rgba(148,163,184,0.5);
        border-top-color:var(--accent);
        animation:spin 0.7s linear infinite;
      }
      @keyframes spin{
        to{transform:rotate(360deg);}
      }
    </style>
  </head>
  <body>
    <div id="root" class="app-shell"></div>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script>
      const {useState,useCallback,useMemo,useEffect} = React;

      function splitSafe(line){
        const parts=[];
        let current='',inQuotes=false;
        for(let i=0;i<line.length;i++){
          const ch=line[i];
          if(ch==='"'){
            if(inQuotes && line[i+1]==='"'){
              current+='"'; i++;
            }else{
              inQuotes=!inQuotes;
            }
          }else if(ch===',' && !inQuotes){
            parts.push(current); current='';
          }else{
            current+=ch;
          }
        }
        parts.push(current);
        return parts;
      }

      function cleanNumberCell(str){
        if(str==null) return null;
        const raw=String(str).trim();
        if(!raw) return null;
        if(/^P$/i.test(raw)) return 0;
        const cleaned=raw.replace(/£/g,'').replace(/,/g,'').replace(/[^\d.\-]/g,'');
        if(cleaned===''||cleaned==='.'||cleaned==='-') return null;
        const n=parseFloat(cleaned);
        if(Number.isNaN(n)) return null;
        return n;
      }

      function findRowIndex(rows,predicate){
        for(let i=0;i<rows.length;i++){
          if(predicate(rows[i],i)) return i;
        }
        return -1;
      }

      function isLikelyPlayerRow(row){
        if(row.length<4) return false;
        const name=row[0]||'';
        const hdcp=row[1]||'';
        if(!name || !/[a-z]/i.test(name)) return false;
        const n=parseFloat(String(hdcp).replace(/[^0-9.\-]/g,''));
        if(!Number.isFinite(n)) return false;
        if(n<-10 || n>40) return false;
        return true;
      }

      function readPlayersSection(rows){
        const idx=findRowIndex(rows,row=>String(row[0]||'').trim().toLowerCase()==='players');
        if(idx<0 || idx+1>=rows.length) return null;
        const header=rows[idx+1];
        const data=[];
        for(let i=idx+2;i<rows.length;i++){
          const row=rows[i];
          if(!row || row.length===0) break;
          if(!row[0] || !row[0].trim()) break;
          if(String(row[0]).trim().toLowerCase()==='stableford') break;
          if(row.every(cell=>String(cell).trim()==='')) break;
          data.push(row);
        }
        const col=header.reduce((acc,name,i)=>{acc[String(name||'').trim().toLowerCase()] = i; return acc;}, {});
        const players=[];
        for(const row of data){
          const name=row[col['name'] ?? 0] || '';
          const hdcpCell=row[col['hdcp'] ?? 1] || '';
          const role=row[col['role'] ?? 2] || '';
          const gender=row[col['gender'] ?? 7] || '';
          const tee=row[col['tee'] ?? 8] || '';
          const totalFees=row[col['total fees'] ?? 10] || '';
          const paid=row[col['paid'] ?? 11] || '';
          const won=row[col['won'] ?? 12] || '';
          const paidOut=row[col['paid out'] ?? 13] || '';
          const owes=row[col['owes'] ?? 14] || '';
          const hdcp=cleanNumberCell(hdcpCell);
          players.push({
            name:String(name).trim(),
            role:String(role).trim(),
            gender:String(gender).trim() || 'M',
            tee:String(tee).trim(),
            exactHandicap:hdcp,
            money:{
              totalFees:cleanNumberCell(totalFees) ?? 0,
              paid:cleanNumberCell(paid) ?? 0,
              won:cleanNumberCell(won) ?? 0,
              paidOut:cleanNumberCell(paidOut) ?? 0,
              owes:cleanNumberCell(owes) ?? 0
            }
          });
        }
        return players;
      }

      function readStablefordSummary(rows){
        const idx=findRowIndex(rows,row=>String(row[0]||'').trim().toLowerCase()==='stableford');
        if(idx<0 || idx+1>=rows.length) return null;
        const header=rows[idx+1];
        const data=[];
        for(let i=idx+2;i<rows.length;i++){
          const row=rows[i];
          if(!row || row.length===0) break;
          if(!row[0] || !row[0].trim()) break;
          if(String(row[0]).trim().toLowerCase()==='round 1') break;
          if(row.every(cell=>String(cell).trim()==='')) break;
          data.push(row);
        }
        const col=header.reduce((acc,name,i)=>{acc[String(name||'').trim().toLowerCase()] = i; return acc;}, {});
        const out=[];
        for(const row of data){
          const name=row[col['player'] ?? 0] || '';
          const r1=row[col['round 1'] ?? 1] || row[col['round1'] ?? 1] || row[1];
          const total=row[col['total'] ?? 2] || row[2];
          const nR1=cleanNumberCell(r1);
          const nTotal=cleanNumberCell(total);
          if(!name || !Number.isFinite(nTotal)) continue;
          out.push({
            name:String(name).trim(),
            round1:nR1 ?? nTotal,
            total: nTotal
          });
        }
        return out;
      }

      function findCourseSectionIndex(rows){
        return findRowIndex(rows,row => {
          const joined=row.map(c=>String(c||'').trim()).join(' ').toLowerCase();
          return joined.includes('golf club');
        });
      }

      function readCourseAndScores(rows){
        const idx=findCourseSectionIndex(rows);
        if(idx<0 || idx+1>=rows.length) return null;
        const headerRow=rows[idx+1] || [];
        const sIndex=headerRow.findIndex(cell => String(cell||'').trim().toLowerCase()==='s.i.' || String(cell||'').trim().toLowerCase()==='si');
        const parIndex=headerRow.findIndex(cell => String(cell||'').trim().toLowerCase()==='par');
        if(sIndex<0 || parIndex<0){
          let siRowIdx = idx+1;
          let parRowIdx=-1;
          for(let i=idx+1;i<rows.length;i++){
            const row=rows[i];
            const first=String(row[0]||'').trim().toLowerCase();
            if(first==='s.i.' || first==='si') {siRowIdx=i;}
            if(first==='par') {parRowIdx=i; break;}
          }
          if(parRowIdx<0) return null;
          const siRow=rows[siRowIdx];
          const parRow=rows[parRowIdx];
          const offset=3;
          const holes=[];
          for(let i=offset;i<parRow.length;i++){
            const si=cleanNumberCell(siRow[i]);
            const par=cleanNumberCell(parRow[i]);
            if(!Number.isFinite(par) || !Number.isFinite(si)) continue;
            holes.push({
              index: holes.length+1,
              par,
              si
            });
          }
          const players=[];
          const usedStablefordRows=new Set();
          for(let i=parRowIdx+1;i<rows.length;i++){
            const row=rows[i];
            const first=String(row[0]||'').trim();
            if(!first) break;
            if(/stableford/i.test(first)) continue;
            const tee=String(row[1]||'').trim();
            const hdcp=cleanNumberCell(row[2]);
            if(!Number.isFinite(hdcp)) continue;
            const name=first.trim();
            const strokes=[];
            for(let j=3;j<row.length;j++){
              const n=cleanNumberCell(row[j]);
              if(n==null) strokes.push(null);
              else strokes.push(n);
            }
            while(strokes.length<holes.length) strokes.push(null);
            let sdRowIdx=-1;
            for(let k=i+1;k<rows.length;k++){
              const r=rows[k];
              if(!r || !r.length) break;
              const f0=String(r[0]||'').trim();
              const f1=String(r[1]||'').trim().toLowerCase();
              if(!f0 && f1==='stableford'){
                sdRowIdx=k; break;
              }
              if(!f0){
                break;
              }
            }
            let stablefordTotal=null;
            let stablefordPerHole=null;
            if(sdRowIdx>=0){
              usedStablefordRows.add(sdRowIdx);
              const rowSd=rows[sdRowIdx];
              stablefordTotal=cleanNumberCell(rowSd[rowSd.length-1]);
              stablefordPerHole=readStablefordPerHole(rowSd);
            }
            players.push({
              name,
              tee,
              handicap:hdcp,
              strokes,
              stablefordTotal,
              stablefordPerHole
            });
          }
          return {holes,players};
        }else{
          const offset = Math.min(sIndex,parIndex);
          const siRow = rows.find(r => String(r[0]||'').trim().toLowerCase()==='s.i.' || String(r[0]||'').trim().toLowerCase()==='si') || rows[idx+2];
          const parRow = rows.find(r => String(r[0]||'').trim().toLowerCase()==='par') || rows[idx+3];
          const holes=[];
          for(let i=offset;i<parRow.length;i++){
            const si=cleanNumberCell(siRow[i]);
            const par=cleanNumberCell(parRow[i]);
            if(!Number.isFinite(par) || !Number.isFinite(si)) continue;
            holes.push({
              index:holes.length+1,
              par,
              si
            });
          }
          const startIdx=rows.indexOf(parRow)+1;
          const players=[];
          for(let i=startIdx;i<rows.length;i++){
            const row=rows[i];
            if(!row || row.length<4) break;
            const name=row[0]||'';
            if(!name || !/[a-z]/i.test(name)) break;
            const tee=row[1]||'';
            const hdcp=cleanNumberCell(row[2]);
            const strokes=[];
            for(let j=offset;j<row.length;j++){
              const n=cleanNumberCell(row[j]);
              strokes.push(Number.isFinite(n) ? n : null);
            }
            while(strokes.length<holes.length) strokes.push(null);
            players.push({
              name:String(name).trim(),
              tee:String(tee).trim(),
              handicap:hdcp,
              strokes,
              stablefordTotal:null,
              stablefordPerHole:null
            });
          }
          return {holes,players};
        }
      }

      function readStablefordPerHole(row){
        let start = -1;

        // Find the "Stableford" cell in the row
        for (let i = 0; i < row.length; i++) {
          if (String(row[i]).trim().toLowerCase() === 'stableford') {
            start = i;
            break;
          }
        }
        if (start < 0) return null;

        const vals = [];

        // Skip the next cell after "Stableford" – this is the playing handicap
        let j = start + 2;

        // Collect per-hole Stableford for 18 holes
        for (; j < row.length && vals.length < 18; j++) {
          const raw = String(row[j] || '').trim();
          if (raw === '') continue;

          // P / p / "\" = pick-up → treat as 0 points
          if (raw === 'P' || raw === 'p' || raw === '\\') {
            vals.push(0);
            continue;
          }

          const n = parseFloat(raw.replace(/[^0-9.\-]/g, ''));

          // Per-hole Stableford scores are small ints; ignore big totals like 16/17/33
          if (Number.isFinite(n) && n >= 0 && n <= 6) {
            vals.push(n);
          }
        }

        // Pad to 18 holes if needed
        while (vals.length < 18) vals.push(0);

        return vals.slice(0, 18);
      }

      function parseSquabbitCSV(text){
        const rows=text.replace(/\r/g,'').split('\n');
        const lines=rows.map(splitSafe);
        const gameMetaLines=lines.filter(r => r.length>=2 && /game\s*\d/i.test(String(r[0]||'')));
        let gameName=null, gameDate=null;
        if(gameMetaLines.length){
          const first=gameMetaLines[0];
          gameName=String(first[0]||'').trim();
          gameDate=String(first[1]||'').trim();
        }else{
          const titleRow=lines.find(r => r.length>=2 && /\bgolf club\b/i.test(r.join(' ')));
          if(titleRow){
            const maybeDate = titleRow.find(c => /\d{4}/.test(String(c)));
            gameName=String(titleRow[0]||'').trim();
            gameDate=maybeDate ? String(maybeDate).trim() : null;
          }
        }
        const players=readPlayersSection(lines) || [];
        const summary=readStablefordSummary(lines) || [];
        const courseData=readCourseAndScores(lines);
        return {
          gameName,
          gameDate,
          players,
          summary,
          courseData
        };
      }

      function buildPerPlayerSummary(parsed){
        const {players,summary,courseData}=parsed;
        const byNameSummary = new Map();
        for(const s of summary){
          byNameSummary.set(s.name.toLowerCase(),s);
        }
        const byNameScores = new Map();
        if(courseData){
          for(const p of courseData.players){
            byNameScores.set(p.name.toLowerCase(),p);
          }
        }
        const out=[];
        const allNamesSet=new Set();
        for(const p of players){
          allNamesSet.add(p.name);
        }
        for(const s of summary){
          allNamesSet.add(s.name);
        }
        if(courseData){
          for(const p of courseData.players){
            allNamesSet.add(p.name);
          }
        }
        for(const name of allNamesSet){
          const key=name.toLowerCase();
          const p=players.find(x=>x.name.toLowerCase()===key);
          const s=byNameSummary.get(key);
          const sc=byNameScores.get(key);
          const points=s?.total ?? sc?.stablefordTotal ?? s?.round1 ?? null;
          let front9=null,back9=null;
          let perHole=null;
          if(sc && sc.stablefordPerHole){
            perHole=sc.stablefordPerHole.slice(0,18);
            const f=perHole.slice(0,9).reduce((a,b)=>a+(b||0),0);
            const b=perHole.slice(9,18).reduce((a,b)=>a+(b||0),0);
            front9=f; back9=b;
          }
          out.push({
            name,
            role:p?.role || '',
            gender:p?.gender || 'M',
            tee:p?.tee || sc?.tee || '',
            startExact:p?.exactHandicap ?? sc?.handicap ?? null,
            money:p?.money || {totalFees:0,paid:0,won:0,paidOut:0,owes:0},
            points,
            front9,
            back9,
            perHole,
            strokes:sc?.strokes || null
          });
        }
        return out.filter(r=>r.points!=null);
      }

      function computeCourseParAndRating(courseData){
        if(!courseData || !courseData.holes || !courseData.holes.length) return null;
        const coursePar = courseData.holes.reduce((a,h)=>a+(h.par||0),0);
        const holesByPar = {3:[],4:[],5:[]};
        for(const h of courseData.holes){
          if(holesByPar[h.par]) holesByPar[h.par].push(h);
        }
        return { coursePar, holesByPar };
      }

      function computeCSI(allScores,coursePar){
        if(!allScores.length || !Number.isFinite(coursePar)) return null;
        const n=allScores.length;
        const sum=allScores.reduce((a,b)=>a+b,0);
        const mean=sum/n;
        let variance=0;
        for(const s of allScores){
          variance+=Math.pow(s-mean,2);
        }
        variance/=n;
        const sd=Math.sqrt(variance);
        const csi = sd ? (coursePar - mean)*10/sd : 0;
        return { mean, sd, csi };
      }

      function approximateStrokeScoreFromPoints(points,coursePar=72){
        if(points==null) return null;
        const diff = 36 - points;
        return coursePar + diff;
      }

      function computeNewExactHandicap(startExact,gender,points,back9,isWinner){
        let exact=startExact;
        if(!Number.isFinite(exact)) return { newExact:null, movement:0 };
        const target=gender==='F'?'F':'M';
        const s = points ?? 36;
        let movement=0;
        if(isWinner && s>=36){
          movement -= 1.0;
        }
        if(s>36){
          movement -= (s-36)*0.1;
        }else if(s<36){
          movement += Math.min(36-s,4)*0.1;
        }
        let newExact=exact+movement;
        newExact=Math.round(newExact*10)/10;
        movement=Math.round(movement*10)/10;
        return { newExact, movement };
      }

      function compareByCountback(a,b){
        if(a.points!=null && b.points!=null){
          if(a.points!==b.points) return b.points-a.points;
          if(a.back9!=null && b.back9!=null && a.back9!==b.back9){
            return b.back9-a.back9;
          }
          if(a.perHole && b.perHole){
            for(let i=a.perHole.length-1;i>=0;i--){
              const av=a.perHole[i]||0;
              const bv=b.perHole[i]||0;
              if(av!==bv) return bv-av;
            }
          }
        }
        return a.name.localeCompare(b.name);
      }

      function buildFinalReport(parsed){
        const {gameName,gameDate,courseData}=parsed;
        const perPlayer=buildPerPlayerSummary(parsed);
        const courseInfo=computeCourseParAndRating(courseData);
        const coursePar=courseInfo?.coursePar ?? 72;
        for(const p of perPlayer){
          p.strokeScore=approximateStrokeScoreFromPoints(p.points,coursePar);
        }
        const validForCSI=perPlayer.filter(p=>p.strokeScore!=null);
        const allScores=validForCSI.map(p=>p.strokeScore);
        const csi=computeCSI(allScores,coursePar);
        const sorted=[...perPlayer].sort(compareByCountback);
        const winner=sorted[0] || null;
        const withHandicapAdj=[];
        for(let i=0;i<sorted.length;i++){
          const p=sorted[i];
          const isWinner = (winner && p.name===winner.name);
          const res=computeNewExactHandicap(p.startExact,p.gender,p.points,p.back9,isWinner);
          withHandicapAdj.push({
            ...p,
            position:i+1,
            newExact:res.newExact,
            handicapMovement:res.movement
          });
        }
        const positions=withHandicapAdj;
        return {
          gameName,
          gameDate,
          coursePar,
          csi,
          positions,
          winner,
          courseData
        };
      }

      function Dropzone({onFileSelected}){
        const [dragOver,setDragOver]=useState(false);

        const onChange=(e)=>{
          const file=e.target.files[0];
          if(file) onFileSelected(file);
        };

        const handleDrop=(e)=>{
          e.preventDefault();
          e.stopPropagation();
          setDragOver(false);
          const file=e.dataTransfer.files[0];
          if(file) onFileSelected(file);
        };

        const handleDragOver=(e)=>{
          e.preventDefault();
          e.stopPropagation();
          if(!dragOver) setDragOver(true);
        };

        const handleDragLeave=(e)=>{
          e.preventDefault();
          e.stopPropagation();
          setDragOver(false);
        };

        return (
          React.createElement("label",{
            className:"dropzone"+(dragOver?" dragover":""),
            onDrop:handleDrop,
            onDragOver:handleDragOver,
            onDragLeave:handleDragLeave
          },
            React.createElement("div",{className:"dropzone-icon"},
              React.createElement("span",null,"\u21e9")
            ),
            React.createElement("div",{className:"dropzone-content"},
              React.createElement("div",{className:"dropzone-title"},"Drop Squabbit CSV here or click to browse"),
              React.createElement("div",{className:"dropzone-sub"},"We\u2019ll parse players, Stableford points, and hole-by-hole scores."),
              React.createElement("div",{className:"dropzone-meta"},"Expected: the raw Squabbit CSV export for a single Den Society game.")
            ),
            React.createElement("input",{
              type:"file",
              accept:".csv,text/csv",
              style:{display:"none"},
              onChange
            })
          )
        );
      }

      function SummaryCard({report,fileName}){
        if(!report){
          return (
            React.createElement("div",{className:"empty-state"},
              "Upload a Squabbit game CSV to see Den Society analysis: winner, CSI, handicap changes, and par-type performance for everyone."
            )
          );
        }
        const {gameName,gameDate,coursePar,csi,winner,positions}=report;
        const numPlayers = positions.length;
        const fieldAvg = csi?.mean ?? null;
        return (
          React.createElement("div",{className:"summary-card"},
            React.createElement("div",{className:"summary-main"},
              React.createElement("div",null,
                React.createElement("div",{className:"summary-main-label"},"Game"),
                React.createElement("div",{style:{fontSize:"16px",fontWeight:600}},
                  gameName || (fileName || "Game from CSV")
                ),
                gameDate && React.createElement("div",{style:{fontSize:"11px",color:"#a0aec0",marginTop:2}},gameDate)
              ),
              React.createElement("div",{style:{textAlign:"right"}},
                React.createElement("div",{className:"summary-main-label"},"Winner"),
                winner ? (
                  React.createElement("div",{className:"summary-main-number"},
                    winner.name
                  )
                ): (
                  React.createElement("div",{className:"summary-main-number"},"\u2014")
                ),
                winner && React.createElement("div",{style:{fontSize:"11px",color:"#9ae6b4",marginTop:2}},
                  winner.points!=null ? `${winner.points} pts` : "Stableford"
                )
              )
            ),
            React.createElement("div",{className:"flex-row"},
              React.createElement("div",{className:"pill-small"},
                React.createElement("strong",null,numPlayers || "\u2014")," players \u2022 Course par ",coursePar || "?"
              ),
              csi && React.createElement("div",{className:"pill-small"},
                "CSI ",
                csi.csi.toFixed(1),
                csi.csi < -2 ? " (tough day)" : csi.csi > 2 ? " (easy day)" : " (normal)"
              ),
              fieldAvg!=null && React.createElement("div",{className:"pill-small"},
                "Field avg ",
                fieldAvg.toFixed(1)," strokes"
              )
            ),
            React.createElement("div",{className:"summary-sub"},
              "CSI is a rough difficulty index: negative = course playing ",React.createElement("strong",null,"harder"),", positive = playing ",React.createElement("strong",null,"easier"),
              " than par for the field."
            )
          )
        );
      }

      function PositionsTable({report}){
        if(!report || !report.positions.length){
          return (
            React.createElement("div",{className:"empty-state"},
              "No positions to show yet. Once you upload a game CSV, we\u2019ll list everyone, their Stableford, stroke score, countback and handicap movement."
            )
          );
        }
        const {positions,coursePar}=report;
        return (
          React.createElement("div",{className:"table-wrap"},
            React.createElement("table",null,
              React.createElement("thead",null,
                React.createElement("tr",null,
                  React.createElement("th",null,"Pos"),
                  React.createElement("th",null,"Player"),
                  React.createElement("th",null,"Pts"),
                  React.createElement("th",null,"Front"),
                  React.createElement("th",null,"Back"),
                  React.createElement("th",null,"Stroke"),
                  React.createElement("th",null,"Start Hcp"),
                  React.createElement("th",null,"New Hcp"),
                  React.createElement("th",null,"\u0394"),
                  React.createElement("th",null,"Notes")
                )
              ),
              React.createElement("tbody",null,
                positions.map(p=>{
                  const isWinner=p.position===1;
                  const cut = p.points!=null && p.points<30;
                  const strokeBadgeClass =
                    p.strokeScore!=null
                      ? (p.strokeScore<=coursePar-2 ? "score-badge good"
                         : p.strokeScore>=coursePar+4 ? "score-badge bad"
                         : "score-badge")
                      : "";
                  const movementTag =
                    p.handicapMovement<0 ? "chip win"
                    : p.handicapMovement>0 ? "chip cut"
                    : "chip";
                  const movementText =
                    p.handicapMovement<0 ? `${p.handicapMovement.toFixed(1)} (cuts)`
                    : p.handicapMovement>0 ? `+${p.handicapMovement.toFixed(1)} (goes up)`
                    : "No change";
                  return React.createElement("tr",{key:p.name, className: isWinner?"highlight":""},
                    React.createElement("td",null,
                      React.createElement("span",{className:"pos-badge"+(isWinner?" win":cut?" cut":"")},
                        p.position
                      )
                    ),
                    React.createElement("td",null,
                      React.createElement("div",null,p.name),
                      React.createElement("div",{style:{fontSize:"10px",color:"#a0aec0",marginTop:1}},
                        p.role ? p.role : p.gender==='F' ? "Lady" : "Gent",
                        p.tee ? ` \u2022 ${p.tee}` : ""
                      )
                    ),
                    React.createElement("td",null,
                      p.points!=null
                        ? React.createElement("span",{className:"score-badge"+(p.points>=36?" good":p.points<=30?" bad":"")},p.points)
                        : "\u2014"
                    ),
                    React.createElement("td",null,
                      p.front9!=null ? p.front9 : "\u2014"
                    ),
                    React.createElement("td",null,
                      p.back9!=null ? p.back9 : "\u2014"
                    ),
                    React.createElement("td",null,
                      p.strokeScore!=null
                        ? React.createElement("span",{className:strokeBadgeClass},p.strokeScore)
                        : "\u2014"
                    ),
                    React.createElement("td",null,
                      p.startExact!=null ? p.startExact.toFixed(1) : "\u2014"
                    ),
                    React.createElement("td",null,
                      p.newExact!=null ? p.newExact.toFixed(1) : "\u2014"
                    ),
                    React.createElement("td",null,
                      React.createElement("span",{className:movementTag},movementText)
                    ),
                    React.createElement("td",null,
                      React.createElement("div",{className:"tag-row"},
                        isWinner && React.createElement("span",{className:"tag-pill strong"},"Winner"),
                        p.points>=36 && React.createElement("span",{className:"tag-pill strong"},"Played well"),
                        cut && React.createElement("span",{className:"tag-pill"},"Below 30 pts"),
                        p.back9!=null && p.front9!=null && p.back9>p.front9 && React.createElement("span",{className:"tag-pill"},"Stronger home")
                      )
                    )
                  );
                })
              )
            )
          )
        );
      }

      function CourseInsight({report}){
        if(!report || !report.courseData || !report.courseData.holes.length){
          return (
            React.createElement("div",{className:"empty-state"},
              "Course insight will appear here if the CSV contains hole-by-hole strokes and Stableford for each player."
            )
          );
        }
        const {courseData,positions,coursePar}=report;
        const parCounts={3:0,4:0,5:0};
        for(const h of courseData.holes){
          if(parCounts[h.par]!=null) parCounts[h.par]++;
        }
        const allPerHole = positions
          .filter(p=>Array.isArray(p.perHole) && p.perHole.length>=18)
          .map(p=>p.perHole);
        const holeTotals = courseData.holes.map((h,i)=>{
          const pts = allPerHole.map(row=>row[i]||0);
          const playedPar = pts.reduce((a,b)=>a+(b||0),0) / Math.max(pts.length || 1,1);
          return {
            index:h.index,
            par:h.par,
            si:h.si,
            avgStableford:playedPar
          };
        });
        const parTypeSummary = {3:{points:0,count:0},4:{points:0,count:0},5:{points:0,count:0}};
        for(const hs of allPerHole){
          courseData.holes.forEach((h,idx)=>{
            const pts = hs[idx] || 0;
            if(parTypeSummary[h.par]){
              parTypeSummary[h.par].points += pts;
              parTypeSummary[h.par].count++;
            }
          });
        }
        const parTypeAvg = {};
        [3,4,5].forEach(par=>{
          const s=parTypeSummary[par];
          parTypeAvg[par] = s.count ? (s.points/s.count) : null;
        });
        const worstHole = holeTotals
          .filter(h=>h.avgStableford!=null)
          .slice()
          .sort((a,b)=>a.avgStableford-b.avgStableford)[0];
        const bestHole = holeTotals
          .filter(h=>h.avgStableford!=null)
          .slice()
          .sort((a,b)=>b.avgStableford-a.avgStableford)[0];

        return (
          React.createElement("div",null,
            React.createElement("div",{className:"section-title"},"Course Insight"),
            React.createElement("div",{className:"section-sub"},
              "How Den played this course by par type and stroke index."
            ),
            React.createElement("div",{className:"flex-row"},
              React.createElement("div",{className:"pill-small"},
                "Par breakdown: ",
                parCounts[3],"x Par 3 \u2022 ",
                parCounts[4],"x Par 4 \u2022 ",
                parCounts[5],"x Par 5"
              ),
              React.createElement("div",{className:"pill-small"},
                "Field size for hole stats: ",
                allPerHole.length," cards"
              )
            ),
            React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:"8px",marginTop:"8px"}},
              [3,4,5].map(par => (
                React.createElement("div",{key:par,className:"summary-card",style:{padding:"8px 9px"}},
                  React.createElement("div",{style:{fontSize:"11px",textTransform:"uppercase",letterSpacing:"0.08em",color:"#a0aec0",marginBottom:4}},
                    `Par ${par}s`
                  ),
                  React.createElement("div",{style:{fontSize:"18px",fontWeight:700}},
                    parTypeAvg[par]!=null ? parTypeAvg[par].toFixed(2) : "\u2014"
                  ),
                  React.createElement("div",{style:{fontSize:"11px",color:"#a0aec0",marginTop:2}},
                    "Avg Stableford per hole"
                  )
                )
              ))
            ),
            React.createElement("div",{style:{marginTop:"10px"}},
              React.createElement("div",{className:"section-title"},"Toughest & Easiest Holes"),
              React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"8px"}},
                React.createElement("div",{className:"summary-card",style:{padding:"8px 9px"}},
                  React.createElement("div",{style:{fontSize:"11px",textTransform:"uppercase",letterSpacing:"0.08em",color:"#fbd38d",marginBottom:4}},"Toughest hole"),
                  worstHole ? (
                    React.createElement("div",null,
                      React.createElement("div",{style:{fontSize:"17px",fontWeight:700}},
                        `Hole ${worstHole.index} (Par ${worstHole.par}, SI ${worstHole.si})`
                      ),
                      React.createElement("div",{style:{fontSize:"11px",color:"#a0aec0",marginTop:2}},
                        "Avg Stableford ",
                        worstHole.avgStableford.toFixed(2),
                        worstHole.avgStableford<1.5 ? " (beating everyone up)" : worstHole.avgStableford<2 ? " (playing tough)" : ""
                      )
                    )
                  ): "\u2014"
                ),
                React.createElement("div",{className:"summary-card",style:{padding:"8px 9px"}},
                  React.createElement("div",{style:{fontSize:"11px",textTransform:"uppercase",letterSpacing:"0.08em",color:"#9ae6b4",marginBottom:4}},"Easiest hole"),
                  bestHole ? (
                    React.createElement("div",null,
                      React.createElement("div",{style:{fontSize:"17px",fontWeight:700}},
                        `Hole ${bestHole.index} (Par ${bestHole.par}, SI ${bestHole.si})`
                      ),
                      React.createElement("div",{style:{fontSize:"11px",color:"#a0aec0",marginTop:2}},
                        "Avg Stableford ",
                        bestHole.avgStableford.toFixed(2),
                        bestHole.avgStableford>3.2 ? " (birdie fest)" : bestHole.avgStableford>2.7 ? " (playing soft)" : ""
                      )
                    )
                  ): "\u2014"
                )
              )
            )
          )
        );
      }

      function App(){
        const [file,setFile]=useState(null);
        const [report,setReport]=useState(null);
        const [error,setError]=useState(null);
        const [loading,setLoading]=useState(false);

        const handleFileSelected=useCallback((f)=>{
          setFile(f);
          setError(null);
          setReport(null);
          if(!f) return;
          const reader=new FileReader();
          reader.onload = (e)=>{
            try{
              setLoading(true);
              const text=e.target.result;
              const parsed=parseSquabbitCSV(text);
              const finalReport=buildFinalReport(parsed);
              setReport(finalReport);
            }catch(err){
              console.error(err);
              setError("Could not parse this CSV. Check it is the raw Squabbit export for a single game.");
            }finally{
              setLoading(false);
            }
          };
          reader.onerror = ()=>{
            setError("Failed to read file");
          };
          reader.readAsText(f);
        },[]);

        const handleClear=()=>{
          setFile(null);
          setReport(null);
          setError(null);
        };

        return (
          React.createElement("div",null,
            React.createElement("div",{className:"header"},
              React.createElement("div",{className:"title-wrap"},
                React.createElement("div",{className:"logo-pill"},"DS"),
                React.createElement("div",null,
                  React.createElement("div",{className:"title"},"Den Society Game Analyser"),
                  React.createElement("div",{className:"subtitle"},"Upload a Squabbit CSV, get full Den-style breakdown.")
                )
              ),
              React.createElement("div",{className:"header-right"},
                React.createElement("div",{className:"badge"},
                  React.createElement("span",{className:"badge-dot"}),
                  "Stableford \u2022 WHS-ish \u2022 Countback"
                )
              )
            ),
            React.createElement("div",{className:"layout"},
              React.createElement("div",{className:"card"},
                React.createElement("div",{className:"card-inner"},
                  React.createElement("div",{className:"card-header"},
                    React.createElement("div",{className:"card-title"},
                      "1. Upload Squabbit CSV",
                      " ",
                      React.createElement("span",null,file ? file.name : "")
                    ),
                    React.createElement("div",{className:"card-actions"},
                      file && React.createElement("button",{
                        className:"pill-btn",
                        onClick:handleClear
                      },
                        React.createElement("span",{className:"pill-btn-label"},"Clear")
                      ),
                      React.createElement("button",{
                        className:"pill-btn primary",
                        disabled:!file
                      },
                        loading
                          ? React.createElement("span",{style:{display:"flex",alignItems:"center",gap:6}},
                              React.createElement("span",{className:"spinner"}),
                              React.createElement("span",{className:"pill-btn-label"},"Analysing...")
                            )
                          : React.createElement("span",{className:"pill-btn-label"},"Ready to Analyse")
                      )
                    )
                  ),
                  React.createElement(Dropzone,{onFileSelected:handleFileSelected}),
                  file && React.createElement("div",{className:"file-meta"},
                    React.createElement("div",null,
                      React.createElement("div",null,
                        React.createElement("strong",null,"Selected: "),
                        file.name
                      ),
                      React.createElement("div",{style:{fontSize:"11px",color:"#a0aec0",marginTop:2}},
                        (file.size/1024).toFixed(1)," KB \u2022 ",
                        "Last modified ",
                        new Date(file.lastModified).toLocaleDateString()
                      )
                    ),
                    React.createElement("div",null,
                      React.createElement("span",{className:"file-tag"},"Squabbit CSV")
                    )
                  ),
                  error && React.createElement("div",{className:"error"},error),
                  React.createElement("div",{className:"footer-note"},
                    "Built for ",
                    React.createElement("span",null,"Den Society"),
                    ". This does not talk to WHS directly \u2013 it\u2019s a helper to sanity-check scores, CSI feel and handicap changes."
                  )
                )
              ),
              React.createElement("div",{className:"card"},
                React.createElement("div",{className:"card-inner"},
                  React.createElement("div",{className:"card-header"},
                    React.createElement("div",{className:"card-title"},"2. Game Summary"),
                    React.createElement("div",{className:"card-actions"},
                      React.createElement("span",{className:"pill-mini"},"Snapshot")
                    )
                  ),
                  React.createElement(SummaryCard,{report,fileName:file?.name})
                )
              )
            ),
            React.createElement("div",{className:"layout",style:{marginTop:"18px"}},
              React.createElement("div",{className:"card"},
                React.createElement("div",{className:"card-inner"},
                  React.createElement("div",{className:"card-header"},
                    React.createElement("div",{className:"card-title"},"3. Positions & Handicap Movement"),
                    React.createElement("div",{className:"card-actions"},
                      React.createElement("span",{className:"pill-mini"},"Countback applied")
                    )
                  ),
                  React.createElement(PositionsTable,{report})
                )
              ),
              React.createElement("div",{className:"card"},
                React.createElement("div",{className:"card-inner"},
                  React.createElement(CourseInsight,{report})
                )
              )
            )
          )
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(
        React.createElement(App,null)
      );
    </script>
  </body>
</html>
