<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Den Society — League & Eclectic</title>
    <link rel="icon" href="./favicon.ico" />
    <meta name="theme-color" content="#199f57" />
    <meta property="og:title" content="Den Society — League & Eclectic" />
    <meta
      property="og:description"
      content="Event results, ratings, standings and eclectic leaderboard."
    />

    <script>
      tailwind = window.tailwind || {};
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              squab: {
                50: "#eefbf2",
                100: "#d8f5e3",
                200: "#b4eac9",
                300: "#86dbab",
                400: "#55c787",
                500: "#2fb66a",
                600: "#199f57",
                700: "#147f47",
                800: "#12663b",
                900: "#0f5232"
              }
            }
          }
        }
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React + Babel + Supabase (UMD) -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

    <!-- QR for in-app Help -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial;
      }
      .panel-mint {
        background: #eefbf2;
        border: 1px solid #b4eac9;
      }
      .btn {
        padding: 0.5rem 0.75rem;
        border-radius: 0.75rem;
        transition: all 0.15s ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
      }
      .chip {
        padding: 0.15rem 0.5rem;
        border-radius: 0.5rem;
        border: 1px solid #e5e5e5;
        background: #fafafa;
      }
      @media print {
        .hide-print {
          display: none !important;
        }
      }
    </style>
  </head>
  <body class="bg-neutral-50 text-neutral-900">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
      /* global React, ReactDOM, supabase */
      const { useState, useMemo, useEffect, useRef } = React;

      // ---------- small utils ----------
      const POINTS_TABLE = [20,17,15,13,11,9,8,7,6,5,4,3,2,1];
      const clamp=(n,lo,hi)=>Math.max(lo,Math.min(hi,n));
      const csvEscape=s=>{ if(s==null) return ""; const str=String(s); return /[",\n]/.test(str) ? '"'+str.replace(/"/g,'""')+'"' : str; };
      const downloadCSV=(filename, rows)=>{ const csv=rows.map(r=>r.map(csvEscape).join(",")).join("\n"); const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); };
      const to1=x=>Math.round((Number(x)||0)*10)/10;
      const isTeamLike = name => { const s=(name||'').trim(); return /^(team(\s*\d+)?)$/i.test(s) || /^team average$/i.test(s) || /^stableford$/i.test(s) || /^strokeplay$/i.test(s) || /^players?$/i.test(s) || /^round\s*\d+$/i.test(s) || /^(out|in|total|s\.i\.|par)$/i.test(s); };
      function toast(msg){ try{ const t=document.createElement('div'); t.className='fixed bottom-4 right-4 left-4 md:left-auto md:right-4 px-3 py-2 rounded-lg bg-black text-white text-sm shadow z-50 text-center'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .2s'; setTimeout(()=>t.remove(),220); }, 1400);}catch{}}

      // Handicap maths
      function playingCapByGender(g){ return g==="F"?36:28; }
      function rangeForHcap(h){ if(h<=9)return"0-9"; if(h<=18)return"10-18"; if(h<=28)return"19-28"; return"29-36"; }
      function cutPerPointOver34(h){ const r=rangeForHcap(h); return r==="0-9"?0.5:r==="10-18"?1:r==="19-28"?1:1.5; }
      function winnerBonusCut(h){ const r=rangeForHcap(h); return r==="0-9"?1:r==="10-18"?2:r==="19-28"?2.5:3; }
      function computeNewExactHandicap(start,g,pts,b9,w){
        const startPlay=Math.round(start); let exact=start;
        if(pts>=35){exact-=cutPerPointOver34(startPlay)*(pts-34);}
        else if(pts<=31){ exact+=0.5*(32-pts);}
        if(w) exact-=winnerBonusCut(startPlay);
        const max=playingCapByGender(g);
        const bounded=clamp(exact,0,60);
        const nextPlay=clamp(Math.round(bounded),0,max);
        return {nextExact:bounded,nextPlaying:nextPlay};
      }
      // Countback
      function compareByCountback(a,b){
        const pa=(a.perHole||[]).slice(0,18), pb=(b.perHole||[]).slice(0,18);
        const sum=(arr,s,e)=>arr.slice(s,e).reduce((x,y)=>x+(Number(y)||0),0);
        const aB9=sum(pa,9,18), bB9=sum(pb,9,18); if(aB9!==bB9) return bB9-aB9;
        const aL6=sum(pa,12,18), bL6=sum(pb,12,18); if(aL6!==bL6) return bL6-aL6;
        const aL3=sum(pa,15,18), bL3=sum(pb,15,18); if(aL3!==bL3) return bL3-aL3;
        for(let i=17;i>=0;i--){ const ai=Number(pa[i])||0, bi=Number(pb[i])||0; if(ai!==bi) return bi-ai; }
        return 0;
      }

      // CSV parsing (short version)
      function splitSmart(raw){ const d = raw.includes('\t') ? '\t' : (raw.includes(';') ? ';' : ','); return raw.split(d).map(s => (s||'').replace(/^"|"$/g,'').trim()); }
      function toNum(x){ const v=parseFloat(String(x == null ? '' : x).replace(/[^0-9.\-]/g,'')); return Number.isFinite(v)?v:NaN; }
      function readStablefordPerHole(row){
        let start=-1; for(let i=0;i<row.length;i++){ if(String(row[i]).trim().toLowerCase()==='stableford'){ start=i; break; } }
        if(start<0) return null;
        const vals=[]; for(let j=start+1;j<row.length && vals.length<18;j++){
          const raw=String(row[j]||'').trim(); if(raw==='') continue;
          if(raw==='P'||raw==='p'||raw==='\\'){ vals.push(0); continue; }
          const n=parseFloat(raw.replace(/[^0-9.\-]/g,'')); if(Number.isFinite(n)&&n>=0&&n<=6) vals.push(n);
        }
        while(vals.length<18) vals.push(0); return vals.slice(0,18);
      }
      function parseSquabbitCSV(text){
        const rows=text.replace(/\r/g,'').split('\n'); const lines=rows.map(splitSmart);
        // Optional roster (Name/Hdcp)
        let playerHeaderRow=-1; for(let i=0;i<lines.length;i++){ if((lines[i][0]||'')==='Name' && (lines[i][1]||'')==='Hdcp'){ playerHeaderRow=i; break; } }
        const players=[];
        if(playerHeaderRow>=0){ for(let i=playerHeaderRow+1;i<lines.length;i++){ const name=(lines[i][0]||'').trim(); if(!name) break; if(isTeamLike(name)) continue; const hcap=parseFloat((lines[i][1]||'').trim()); if(!Number.isNaN(hcap)) players.push({name:name,handicap:hcap,gender:'M'}); } }
        // Gender hints
        const genderMap={}; for(let r=0;r<lines.length;r++){ const row=lines[r]; const nm=(row[0]||'').trim(); if(!nm) continue; const tee=String(row[1]||'').toLowerCase(); if(/women|ladies|red tee/.test(tee)) genderMap[nm]='F'; else if(genderMap[nm]==null) genderMap[nm]='M'; }
        for(let p=0;p<players.length;p++){ const pl=players[p]; if(genderMap[pl.name]) pl.gender=genderMap[pl.name]; }
        // Totals under a "Stableford" header
        let totalsStart=-1; for(let i=0;i<lines.length;i++){ if(/^stableford$/i.test((lines[i][0]||'').trim())) { totalsStart=i; break; } }
        const totals={};
        if(totalsStart>=0){
          for(let i=totalsStart+1;i<lines.length;i++){
            const row=lines[i]; const a=(row[0]||'').trim(); const b=toNum(row[1]); const c=toNum(row[2]);
            if(!a){ if(i>totalsStart+1) break; else continue; }
            if(!/[A-Za-z]/.test(a) || a.length<3) continue;
            const pts=Number.isFinite(c)?c:(Number.isFinite(b)?b:NaN);
            if(Number.isFinite(pts)) totals[a]=pts;
            if(!players.some(p=>p.name===a)){ players.push({name:a,handicap:0,gender:(genderMap[a]||'M')}); }
          }
        }
        // Per-hole from cards
        const holeData={};
        for(let pi=0;pi<players.length;pi++){
          const p=players[pi];
          for(let i=0;i<lines.length-1;i++){
            if((lines[i][0]||'').trim()===p.name){
              const stRow=lines[i+1]||[]; let hasStable=false; for(let j=0;j<stRow.length;j++){ if(String(stRow[j]).trim().toLowerCase()==='stableford'){ hasStable=true; break; } }
              if(!hasStable) continue;
              const perHole=readStablefordPerHole(stRow);
              const back9=perHole.slice(9).reduce((a,b)=>a+(Number(b)||0),0);
              holeData[p.name]={perHole:perHole, back9:back9};
              break;
            }
          }
          if(!holeData[p.name]) holeData[p.name]={perHole:Array(18).fill(0), back9:0};
        }
        return {
          players: players.map(function(p){
            return { name:p.name, gender:p.gender, handicap:p.handicap, points: totals[p.name] || 0, back9: (holeData[p.name] && holeData[p.name].back9) || 0, perHole: (holeData[p.name] && holeData[p.name].perHole) || [] };
          })
        };
      }

      // ---------- Help component (accordion) ----------
      function HelpSection({title, children, defaultOpen=false}) {
        const [open, setOpen] = React.useState(defaultOpen);
        return (
          <div className="border border-squab-300 rounded-xl bg-white">
            <button
              className="w-full flex items-center justify-between px-4 py-3 text-left"
              onClick={()=>setOpen(v=>!v)}
              aria-expanded={open}
            >
              <span className="font-semibold">{title}</span>
              <span className={`transition-transform ${open?'rotate-180':''}`}>▾</span>
            </button>
            <div className={`px-4 pb-4 overflow-hidden transition-all ${open?'max-h-[4000px]':'max-h-0'}`}>
              <div className="pt-1 text-sm text-neutral-800">{children}</div>
            </div>
          </div>
        );
      }
      function Badge({label, className}) {
        return <span className={`px-2 py-0.5 rounded-lg text-xs font-medium ${className}`}>{label}</span>;
      }
      function Help(){
        useEffect(()=>{
          const holder = document.getElementById("help-qr");
          if(holder && holder.childNodes.length===0){
            new QRCode(holder, {
              text: "https://kevanojb.github.io/Den-Society/",
              width: 128, height: 128,
              colorDark: "#12663b", colorLight: "#ffffff",
              correctLevel: QRCode.CorrectLevel.M
            });
          }
        },[]);
        return (
          <section className="rounded-2xl p-4 md:p-6 panel-mint shadow-sm">
            <div className="flex items-center gap-3 mb-3">
              <img src="https://squabbitgolf.com/assets/icon_transparent.png" alt="Squabbit" className="w-10 h-10"/>
              <h2 className="text-xl font-bold text-squab-900">Den Society — Help & Guide</h2>
            </div>
            <p className="text-sm text-neutral-700 mb-4">Tap a section to expand. This mirrors the PDF, with the Geek Appendix at the end.</p>
            <div className="grid gap-2">
              <HelpSection title="✅ What the System Does" defaultOpen={true}>
                <ul className="list-disc pl-6 space-y-1">
                  <li>Load &amp; view past events</li>
                  <li>Calculate points, handicaps, season results</li>
                  <li>Show player ratings with colour badges</li>
                  <li>Maintain eclectic leaderboard</li>
                  <li>Produce season standings</li>
                  <li>Export or import CSV event files</li>
                  <li>Members can analyse their own Squabbit rounds</li>
                </ul>
              </HelpSection>

              <HelpSection title="✅ Home Menu (8 Items)">
                <ol className="list-decimal pl-6 space-y-1">
                  <li>View Past Golf Events</li>
                  <li>View Player Ratings</li>
                  <li>Check Season Standings</li>
                  <li>Check Eclectic Leaderboard</li>
                  <li>Import CSV</li>
                  <li>Add Event → Season <span className="text-[11px] text-neutral-500">(Admin only)</span></li>
                  <li>Reset Season Standings <span className="text-[11px] text-neutral-500">(Admin only)</span></li>
                  <li>Download CSV</li>
                </ol>
              </HelpSection>

              <HelpSection title="✅ View Past Golf Events">
                Loads events from Supabase (grouped by year). Choose one to make it the <b>Current Event</b>. Once loaded, Ratings / Standings / Eclectic / Export are available.
              </HelpSection>

              <HelpSection title="✅ View Player Ratings">
                Works only when an event is loaded. If not, the app prompts you to import or load one and returns to Menu.
                <div className="mt-3">
                  <div className="font-medium mb-1">Colour badges</div>
                  <div className="grid sm:grid-cols-2 gap-x-4 gap-y-2 text-[13px]">
                    <div><Badge label="Excellent" className="bg-emerald-100 text-emerald-800" /> — Average ≥ 3.0</div>
                    <div><Badge label="Good" className="bg-emerald-50 text-emerald-700" /> — Average ≥ 2.5</div>
                    <div><Badge label="Solid" className="bg-neutral-100 text-neutral-800" /> — Average ≥ 2.0</div>
                    <div><Badge label="Needs work" className="bg-amber-100 text-amber-800" /> — Average ≥ 1.5</div>
                    <div><Badge label="Struggle" className="bg-red-100 text-red-800" /> — Average &lt; 1.5</div>
                  </div>
                  <p className="mt-2 text-neutral-700">Badges show where players gain/lose strokes vs the field — great for targeted practice.</p>
                </div>
              </HelpSection>

              <HelpSection title="✅ Season Standings">
                Shows Total points, Events played, Best event, Best hole score, Eclectic total. Updates only when an admin adds an event to the season.
              </HelpSection>

              <HelpSection title="✅ Eclectic Leaderboard">
                Tracks a player’s <b>best Stableford for each hole</b> across all season events. Example: 2 points on H7 in Event 1, 3 points in Event 2 → Eclectic H7 = 3.
              </HelpSection>

              <HelpSection title="✅ Import CSV">
                Import Squabbit or other event CSVs for analysis. Imported events <b>do not</b> affect the season until an admin adds them.
              </HelpSection>

              <HelpSection title="✅ Add Event → Season (Admin)">
                You’ll be asked “Are you admin?” If Yes, the Current Event updates Season totals, Eclectic, Best event & Best hole, and league points. If No, you’re returned to Menu.
              </HelpSection>

              <HelpSection title="✅ Reset Season Standings (Admin)">
                Clears season totals and the eclectic leaderboard. Does <b>not</b> delete Supabase-stored event CSVs (safe reset for new season).
              </HelpSection>

              <HelpSection title="✅ Calculations — Stableford, Countback, Handicaps">
                <div className="mt-2">
                  <div className="font-medium">Stableford</div>
                  <p>Read directly from the Squabbit CSV.</p>

                  <div className="font-medium mt-2">Countback</div>
                  <p>Applied <b>only</b> to the top-score tie. Others share league points equally.</p>
                  <p className="text-[13px]">Order: Back 9 → Last 6 → Last 3 → 18 → 17 → … → 1. Still tied? Joint winners (all get winner’s cut & 20 pts).</p>

                  <div className="font-medium mt-2">Handicap Bands (cuts & winners)</div>
                  <table className="w-full text-[13px] mt-1 border border-squab-300 rounded">
                    <thead className="bg-squab-100">
                      <tr className="text-left">
                        <th className="px-2 py-1">Band (Exact)</th>
                        <th className="px-2 py-1">Cut / point over 34</th>
                        <th className="px-2 py-1">Winner bonus cut</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr className="[&>*]:px-2 [&>*]:py-1 border-t"><td>0–9</td><td>0.5</td><td>1.0</td></tr>
                      <tr className="[&>*]:px-2 [&>*]:py-1 border-t"><td>10–18</td><td>1.0</td><td>2.0</td></tr>
                      <tr className="[&>*]:px-2 [&>*]:py-1 border-t"><td>19–28</td><td>1.0</td><td>2.5</td></tr>
                      <tr className="[&>*]:px-2 [&>*]:py-1 border-t"><td>29–36</td><td>1.5</td><td>3.0</td></tr>
                    </tbody>
                  </table>
                  <p className="text-[13px] mt-1"><b>Increases:</b> ≤31 points → +0.5 per point below 32. <b>Gender caps:</b> Men max playing 28; Women max playing 36.</p>
                  <p className="text-[13px]"><b>New handicap:</b> Start exact → apply cut/increase → clamp → round to playing (respect caps).</p>

                  <div className="font-medium mt-2">Examples</div>
                  <ul className="list-disc pl-6 text-[13px]">
                    <li>Exact 7.4, score 38 &amp; winner → 4 over 34 → 4×0.5=2.0 &amp; +1.0 winner cut → 7.4 − 3.0 = <b>4.4</b> → playing 4.</li>
                    <li>Exact 22.1, score 30 → 2 below 32 → +1.0 → <b>23.1</b> → playing 23 (cap not reached).</li>
                  </ul>
                </div>
              </HelpSection>

              <HelpSection title="✅ CSVs & Storage">
                <p><b>What is a CSV?</b> A simple text format for table data — each line is a row, commas separate values.</p>
                <p><b>How the app uses CSVs:</b> Import a CSV to analyse locally. Past events are permanently stored in Supabase Storage and listed under “View Past Golf Events”.</p>
              </HelpSection>

              <HelpSection title="✅ Geek Appendix — Supabase & GitHub">
                <p><b>Supabase</b><br/>Bucket: <b>den-events</b> (event CSVs). Table: <b>season_standings</b> (league totals, eclectic, best hole, events count).</p>
                <p><b>GitHub</b><br/>Hosted on GitHub Pages. Repo has: index.html (React + Tailwind + Supabase), CSV parser, handicap & countback logic. Pushing to main deploys automatically.</p>
              </HelpSection>

              <HelpSection title="✅ QR Code">
                <p>Scan to open Den Society</p>
                <div id="help-qr" className="mt-2 inline-block p-2 bg-white rounded border border-squab-300"></div>
              </HelpSection>
            </div>

            <div className="mt-4 text-sm">
              Prefer a full-page manual? <a className="text-squab-700 underline" href="./help.html" target="_blank" rel="noopener">Open the standalone Help</a>.
            </div>
          </section>
        );
      }

      // ---------- App ----------
      function App(){
        const [view,setView] = useState('home'); // home | past | event | ratings | standings | eclectic | help
        const defaultURL="https://mqknahdfpqxrpgpxqtus.supabase.co";
        const defaultKEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xa25haGRmcHF4cnBncHhxdHVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTU3MDYsImV4cCI6MjA3ODAzMTcwNn0.GTUVsrRJ-MClMg96vuHZpUtAnUFtCsJvuLiiE0D-fCc";
        const [client,setClient] = useState(null);
        const [statusMsg,setStatusMsg] = useState('Connecting…');

        const BUCKET='den-events';
        const PREFIX='events';
        const [shared,setShared]=useState([]);
        const [sharedGroups,setSharedGroups]=useState([]);

        const [eventName,setEventName]=useState('Den Society Meeting');
        const [players,setPlayers]=useState([]);
        const [season,setSeason]=useState({});
        const fileInputRef = useRef(null);

        useEffect(()=>{ // init supabase + fetch
          let cancelled=false;
          async function boot(){
            try{
              if(!(window.supabase && window.supabase.createClient)){ setTimeout(boot,250); return; }
              const c = window.supabase.createClient(defaultURL, defaultKEY, { auth:{ persistSession:false }});
              if(cancelled) return; setClient(c);
              const probe = await c.from('season_standings').select('name').limit(1);
              if(cancelled) return;
              if(probe.error){ setStatusMsg('Error: '+probe.error.message); }
              else{ setStatusMsg('Connected'); await refreshShared(c); await fetchSeasonWith(c); }
            }catch(e){ if(!cancelled) setStatusMsg('Error: '+(e?.message||e)); }
          }
          boot();
          return ()=>{cancelled=true};
        },[]);

        async function refreshShared(c){
          c=c||client; if(!c) return;
          const r = await c.storage.from(BUCKET).list(PREFIX, { limit:1000, sortBy:{column:'name', order:'asc'} });
          if(r.error) return;
          const data=(r.data||[])
            .filter(x=>!x.name.startsWith('.') && /\.csv$/i.test(x.name))
            .map(x=>({ name:x.name.replace(/\.csv$/i,''), file:x.name, path: PREFIX+'/'+x.name }));
          setShared(data);
          setSharedGroups(groupByYear(data));
        }
        function groupByYear(files){
          const groups={};
          for(const f of files){ const m=f.name.match(/(20\d{2})/); const year=m?m[1]:'Unknown'; (groups[year]=groups[year]||[]).push(f); }
          return Object.keys(groups).sort((a,b)=>b.localeCompare(a)).map(y=>({year:y, events:groups[y].sort((a,b)=>a.name.localeCompare(b.name))}));
        }
        async function loadShared(item){
          if(!client) return;
          const r=await client.storage.from(BUCKET).download(item.path);
          if(r.error){ alert('Download failed: '+r.error.message); return; }
          const text=await r.data.text();
          const parsed=parseSquabbitCSV(text);
          setPlayers(parsed.players||[]);
          setEventName(item.name);
          setView('event');
          toast('Event loaded');
        }

        // computed event outcomes
        const computed = useMemo(()=>{
          const rows=players.map((p,i)=>({idx:i,name:p.name,gender:p.gender,startExact:p.handicap,points:p.points,back9:p.back9,perHole:p.perHole}));
          const base=[...rows].sort((a,b)=>(b.points-a.points)||(compareByCountback(a,b)));
          if(!base.length) return [];
          const groups=[]; const used=new Set();
          for(const r of base){ if(used.has(r.idx)) continue; const grpIdxs=base.filter(x=>x.points===r.points).map(x=>x.idx); grpIdxs.forEach(id=>used.add(id)); groups.push(grpIdxs); }
          const topGroup=groups[0].map(i=>rows.find(r=>r.idx===i));
          let best=[topGroup[0]];
          for(let k=1;k<topGroup.length;k++){ const cmp=compareByCountback(topGroup[k],best[0]); if(cmp>0) best=[topGroup[k]]; else if(cmp===0) best.push(topGroup[k]); }
          const winnerIdxSet=new Set(best.map(r=>r.idx));

          let pos=1; const out=[];
          for(let gIdx=0; gIdx<groups.length; gIdx++){
            const g=groups[gIdx]; const start=pos; const ptsValue=POINTS_TABLE[start-1]||0;
            for(const i of g){
              const r=rows.find(x=>x.idx===i);
              const isWinner=winnerIdxSet.has(i) && (gIdx===0);
              const res=computeNewExactHandicap(r.startExact,r.gender,r.points,r.back9,isWinner);
              out.push({...r, position:start, leaguePoints:ptsValue, isWinner, nextExact:res.nextExact, nextPlaying:res.nextPlaying});
            }
            pos+=g.length;
          }
          return out.sort((a,b)=>a.position-b.position);
        },[players]);

        async function fetchSeasonWith(c){
          const r = await c.from('season_standings').select('name,total_points,events,best_event_points,best_hole_points,eclectic_total,best_per_hole');
          if(r.error){ setStatusMsg('Error: '+r.error.message); return; }
          const data=r.data||[]; const map={};
          for(const rec of data){
            if(isTeamLike(rec.name)) continue;
            let bph=[];
            if(Array.isArray(rec.best_per_hole)) bph=rec.best_per_hole;
            else if(typeof rec.best_per_hole==='string'){ try{ bph=JSON.parse(rec.best_per_hole||'[]')||[]; }catch(e){ bph=[]; } }
            map[rec.name]={ name:rec.name, totalPoints:rec.total_points||0, events:rec.events||0, bestEventPoints:rec.best_event_points??0, bestHolePoints:rec.best_hole_points??0, eclecticTotal:rec.eclectic_total??0, bestPerHole:(bph||[]).map(n=>Number(n)||0) };
          }
          setSeason(map);
        }

        async function addEventToSeason(){
          if(!computed.length){ toast('Load an event first'); return; }
          const next={ ...season };
          for(const r of computed){
            if(isTeamLike(r.name)) continue;
            const prev=next[r.name]||{name:r.name,totalPoints:0,events:0,bestPerHole:Array(18).fill(0),eclecticTotal:0,bestEventPoints:0,bestHolePoints:0};
            const eventPerHole=(r.perHole||[]).map(v=>Math.max(0,Math.min(6,Number(v)||0)));
            const bestPerHole=Array.from({length:18},(_,idx)=>Math.max(prev.bestPerHole[idx]||0,eventPerHole[idx]||0));
            const eclecticTotal=bestPerHole.reduce((s,v)=>s+(Number(v)||0),0);
            const nextBestEvent=Math.max(prev.bestEventPoints||0,r.points||0);
            const nextBestHole=Math.max(prev.bestHolePoints||0,Math.max.apply(null,[0].concat(eventPerHole)));
            next[r.name]={ name:r.name, totalPoints:(prev.totalPoints||0)+(r.leaguePoints||0), events:(prev.events||0)+1, bestEventPoints:nextBestEvent, bestHolePoints:nextBestHole, eclecticTotal, bestPerHole };
          }
          setSeason(next);
          if(client){
            const rows=[]; const vals=Object.values(next).filter(r=>!isTeamLike(r.name));
            for(const r of vals){
              rows.push({ name:r.name, total_points:r.totalPoints|0, events:r.events|0, best_event_points:(r.bestEventPoints??0)|0, best_hole_points:(r.bestHolePoints??0)|0, eclectic_total:(r.eclecticTotal??0)|0, best_per_hole:Array.isArray(r.bestPerHole)?r.bestPerHole.map(n=>Number(n)||0):Array(18).fill(0) });
            }
            const u = await client.from('season_standings').upsert(rows,{onConflict:'name'});
            if(u.error){ toast('Error: '+u.error.message); } else { toast('Event added to season ✓'); }
          }
        }
        async function addEventToSeasonGuarded(){
          if(!computed.length){ toast('Load an event first'); return; }
          const ok = window.confirm('Only Admin should add events.\n\nAre you admin?');
          if(!ok){ toast('Action cancelled'); setView('home'); return; }
          await addEventToSeason();
        }
        async function resetSeasonStandings(){
          const ok = window.confirm('This will CLEAR Season Standings and Eclectic totals.\nEvent CSVs in Supabase storage are kept.\n\nAre you admin and sure?');
          if(!ok){ toast('Reset cancelled'); setView('home'); return; }
          setSeason({});
          if(client){
            const del = await client.from('season_standings').delete().neq('name','');
            if(del.error){ toast('Error: '+del.error.message); }
            else{ toast('Season standings reset ✓'); }
          } else { toast('Season cleared locally'); }
        }
        function exportEventCSV(){
          if(!computed.length){ toast('Load an event first'); return; }
          const rows=[["Name","Gender","Exact","Stableford","Back9","Pos","Pts","NextExact","NextPlay"]];
          computed.forEach(r=>rows.push([r.name,r.gender,Math.round(r.startExact),r.points,r.back9,r.position,r.leaguePoints,r.nextExact.toFixed(1),r.nextPlaying]));
          downloadCSV(`DenSociety_${(eventName||'Event').replace(/[^a-z0-9]+/gi,'_')}.csv`,rows);
        }

        // Views UI
        function Header(){
          return (
            <header className="hide-print rounded-2xl p-4 border border-squab-900 bg-squab-800 text-white">
              <div className="flex items-center justify-between gap-2">
                <div>
                  <h1 className="text-xl md:text-2xl font-bold tracking-tight">Den Society — League & Eclectic</h1>
                  <p className="text-xs/5 text-white/90">Supabase: {statusMsg}</p>
                </div>
                <span className="hidden sm:inline-flex chip border-white/30 bg-white/10 text-white">{eventName||'Untitled Event'}</span>
              </div>
            </header>
          );
        }
        function Home(){
          const [open,setOpen]=useState(true);
          const canAct = computed.length>0;
          return (
            <section className="rounded-2xl p-3 md:p-4 panel-mint shadow-sm">
              <button
                type="button"
                className="w-full bg-white text-neutral-900 border border-squab-300 rounded-xl px-4 py-3 flex items-center justify-between"
                onClick={()=>setOpen(v=>!v)}
                aria-expanded={open?'true':'false'}
              >
                <span className="font-semibold">Menu</span>
                <span className={`transition-transform ${open?'rotate-180':''}`}>▾</span>
              </button>
              <div className={`overflow-hidden transition-all ${open?'max-h-[2200px]':'max-h-0'}`}>
                <div className="mt-3 grid gap-2">
                  <button className="w-full text-left rounded-xl border border-squab-300 bg-white px-3 py-2" onClick={()=>setView('past')}>View Past Golf Events</button>
                  <button className="w-full text-left rounded-xl border border-squab-300 bg-white px-3 py-2" onClick={()=>{
                    if (!computed || computed.length === 0) { toast('Load a past event or import a CSV first'); setView('home'); return; }
                    setView('ratings');
                  }}>View Player Ratings</button>
                  <button className="w-full text-left rounded-xl border border-squab-300 bg-white px-3 py-2" onClick={()=>setView('standings')}>Check Season Standings</button>
                  <button className="w-full text-left rounded-xl border border-squab-300 bg-white px-3 py-2" onClick={()=>setView('eclectic')}>Check Eclectic Leaderboard</button>
                  <button className="w-full text-left rounded-xl border border-squab-300 bg-white px-3 py-2" onClick={()=>{ fileInputRef.current && fileInputRef.current.click(); }}>Import CSV</button>
                  <input ref={fileInputRef} type="file" accept=".csv" className="hidden" onChange={async e=>{
                      try{ const f=e.target.files&&e.target.files[0]; if(!f) return; const text=await f.text(); const parsed=parseSquabbitCSV(text); setPlayers(parsed.players||[]); setEventName((f.name||'').replace(/\.[^.]+$/,'')); setView('event'); e.target.value=''; }catch(err){ toast('Bad CSV'); console.error(err); }
                  }}/>
                  <button className={`w-full text-left rounded-xl border px-3 py-2 ${canAct?'border-squab-300 bg-white':'border-neutral-200 bg-neutral-50 text-neutral-400 cursor-not-allowed'}`} onClick={addEventToSeasonGuarded} disabled={!canAct}>Add Event → Season</button>
                  <button className="w-full text-left rounded-xl border border-red-200 bg-white px-3 py-2 text-red-700" onClick={resetSeasonStandings}>Reset Season Standings</button>
                  <button className={`w-full text-left rounded-xl border px-3 py-2 ${canAct?'border-squab-300 bg-white':'border-neutral-200 bg-neutral-50 text-neutral-400 cursor-not-allowed'}`} onClick={exportEventCSV} disabled={!canAct}>Download CSV</button>

                  {/* Link to full standalone Help page */}
                  <a href="./help.html" className="w-full block text-left rounded-xl border border-squab-300 bg-white px-3 py-2" target="_blank" rel="noopener">
                    Help / How it works (full page)
                  </a>
                  {/* In-app Help view */}
                  <button className="w-full text-left rounded-xl border border-squab-300 bg-white px-3 py-2" onClick={()=>setView('help')}>Help / How it works (in-app)</button>
                </div>
              </div>
            </section>
          );
        }

        // Past events
        function PastEvents(){
          return (
            <section className="rounded-2xl p-3 md:p-4 bg-white border border-squab-300 shadow-sm">
              <div className="flex items-center justify-between mb-2">
                <h2 className="text-lg font-semibold text-squab-900">Past Den Society Golf Games</h2>
                <button className="btn border border-squab-300" onClick={()=>setView('home')}>Back</button>
              </div>
              {sharedGroups.length===0 && <div className="text-sm text-neutral-600 p-2">No shared CSVs yet.</div>}
              {sharedGroups.map(group=> (
                <div key={group.year} className="mb-3">
                  <div className="text-xs text-neutral-600 mb-1">{group.year}</div>
                  <select className="w-full rounded-xl border border-squab-300 px-3 py-2 bg-white" onChange={async e=>{ const idx=e.target.value; if(idx==='') return; const item=group.events[Number(idx)]; await loadShared(item); }} >
                    <option value="">Select an event…</option>
                    {group.events.map((item,i)=> (<option key={item.path} value={i}>{item.name}</option>))}
                  </select>
                </div>
              ))}
            </section>
          );
        }
        function EventScreen(){
          return (
            <section className="rounded-2xl p-4 md:p-6 bg-white border border-squab-300 shadow-sm">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-semibold text-squab-900">Event — {eventName || 'Selected Event'}</h2>
                <button className="btn border border-squab-300" onClick={()=>setView('past')}>Back</button>
              </div>
              <div className="overflow-auto">
                <table className="min-w-full text-sm">
                  <thead className="sticky top-0 bg-white z-10">
                    <tr className="border-b border-squab-300 text-left">
                      <th>#</th><th>Name</th><th>Handicap</th><th>Stableford</th><th>Back9</th><th>Pts</th><th>New Handicap</th>
                    </tr>
                  </thead>
                  <tbody className="[&_tr:nth-child(even)]:bg-squab-50">
                    {computed.length===0 && (<tr><td colSpan="7" className="py-3 text-neutral-600">Pick an event to see players.</td></tr>)}
                    {computed.map((r,i)=>(
                      <tr key={i} className="border-b border-squab-300">
                        <td>{r.position}</td>
                        <td className="whitespace-nowrap">{r.name}</td>
                        <td>{Math.round(r.startExact)}</td>
                        <td>{r.points}</td>
                        <td>{r.back9}</td>
                        <td>{r.leaguePoints}</td>
                        <td>{r.nextPlaying}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <p className="text-xs text-neutral-600 mt-2">Ties share the highest slot. Winner by countback: Back 9 → Last 6 → Last 3 → 18th → 17th … 1st.</p>
            </section>
          );
        }
        function Ratings(){
          const defaultMen=[4,4,3,4,5,4,3,4,4, 4,5,4,3,4,4,5,3,4];
          const defaultWomen=[4,4,3,4,5,4,3,4,4, 4,4,5,3,4,4,5,3,4];
          const ratingLabel = avg => avg>=3?'Excellent':avg>=2.5?'Good':avg>=2?'Solid':avg>=1.5?'Needs work':'Struggle';
          const badgeClass = avg => avg>=3?'bg-emerald-100 text-emerald-800':avg>=2.5?'bg-emerald-50 text-emerald-700':avg>=2?'bg-neutral-100 text-neutral-800':avg>=1.5?'bg-amber-100 text-amber-800':'bg-red-100 text-red-800';
          const eventParAverages=(perHole,pars)=>{ const sums={3:{s:0,c:0},4:{s:0,c:0},5:{s:0,c:0}}; for(let i=0;i<Math.min(18,perHole.length);i++){ const pts=Number(perHole[i])||0; const par=Number(pars[i])||4; if(sums[par]){ sums[par].s+=pts; sums[par].c++; }} const avg=t=>sums[t].c?(sums[t].s/sums[t].c):0; return {p3:avg(3),p4:avg(4),p5:avg(5)}; };

          useEffect(()=>{ if (!Array.isArray(computed) || computed.length === 0) { toast('Load a past event or import a CSV first'); setView('home'); } }, [computed.length]);

          const ratings = React.useMemo(()=>{
            const out=[];
            for(const r of computed){
              const pars=(r.gender==='F')?defaultWomen:defaultMen;
              const av=eventParAverages(r.perHole||[],pars);
              out.push({name:r.name,p3:to1(av.p3),p4:to1(av.p4),p5:to1(av.p5),total:to1(av.p3+av.p4+av.p5)});
            }
            return out.sort((a,b)=> b.total-a.total || a.name.localeCompare(b.name));
          },[computed]);

          return (
            <section className="rounded-2xl p-3 md:p-5 bg-white border border-squab-300 shadow-sm">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-semibold text-squab-900">Player Ratings — {eventName||'This Event'}</h2>
                <button className="btn border border-squab-300" onClick={()=>setView('home')}>Back</button>
              </div>
              <div className="overflow-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="border-b border-squab-300 text-left">
                      <th>Name</th>
                      <th>Par-3 avg</th><th>Par-3 rating</th>
                      <th>Par-4 avg</th><th>Par-4 rating</th>
                      <th>Par-5 avg</th><th>Par-5 rating</th>
                    </tr>
                  </thead>
                  <tbody>
                    {ratings.length===0 && (<tr><td colSpan="7" className="py-3 text-neutral-600">Import a CSV or pick one from Past Events to see ratings.</td></tr>)}
                    {ratings.map(r=> (
                      <tr key={r.name} className="border-b border-squab-300">
                        <td className="font-medium">{r.name}</td>
                        <td>{r.p3.toFixed(1)}</td>
                        <td><span className={`px-2 py-0.5 rounded-lg text-xs font-medium ${badgeClass(r.p3)}`}>{ratingLabel(r.p3)}</span></td>
                        <td>{r.p4.toFixed(1)}</td>
                        <td><span className={`px-2 py-0.5 rounded-lg text-xs font-medium ${badgeClass(r.p4)}`}>{ratingLabel(r.p4)}</span></td>
                        <td>{r.p5.toFixed(1)}</td>
                        <td><span className={`px-2 py-0.5 rounded-lg text-xs font-medium ${badgeClass(r.p5)}`}>{ratingLabel(r.p5)}</span></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>
          );
        }
        function Standings(){
          const list = Object.values(season).filter(r=>!isTeamLike(r.name)).sort((a,b)=>(b.totalPoints-a.totalPoints)||a.name.localeCompare(b.name));
          return (
            <section className="rounded-2xl p-3 md:p-5 bg-white border border-squab-300 shadow-sm">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-semibold text-squab-900">Season Standings</h2>
                <button className="btn border border-squab-300" onClick={()=>setView('home')}>Back</button>
              </div>
              <div className="overflow-auto">
                <table className="min-w-full text-sm"><thead><tr className="border-b border-squab-300 text-left"><th>Rank</th><th>Name</th><th>Events</th><th>Total</th><th>Best Event</th><th>Best Hole</th><th>Eclectic</th></tr></thead>
                  <tbody>
                    {list.length===0 && <tr><td colSpan="7" className="py-3 text-neutral-600">No season data found.</td></tr>}
                    {list.map((r,i)=>(<tr key={r.name} className="border-b border-squab-300"><td>{i+1}</td><td>{r.name}</td><td>{r.events}</td><td>{r.totalPoints}</td><td>{r.bestEventPoints??0}</td><td>{r.bestHolePoints??0}</td><td>{r.eclecticTotal??0}</td></tr>))}
                  </tbody>
                </table>
              </div>
            </section>
          );
        }
        function Eclectic(){
          const list = Object.values(season).filter(r=>!isTeamLike(r.name)).sort((a,b)=>((b.eclecticTotal??0)-(a.eclecticTotal??0))||a.name.localeCompare(b.name));
          return (
            <section className="rounded-2xl p-3 md:p-5 bg-white border border-squab-300 shadow-sm">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-semibold text-squab-900">Eclectic Leaderboard</h2>
                <button className="btn border border-squab-300" onClick={()=>setView('home')}>Back</button>
              </div>
              <div className="overflow-auto">
                <table className="min-w-full text-sm">
                  <thead><tr className="border-b border-squab-300 text-left"><th>Rank</th><th>Name</th><th>Eclectic Total</th>{Array.from({length:18},(_,i)=>(<th key={i}>H{i+1}</th>))}</tr></thead>
                  <tbody>
                    {list.length===0 && <tr><td colSpan="21" className="py-3 text-neutral-600">No eclectic yet.</td></tr>}
                    {list.map((r,i)=>(<tr key={r.name} className="border-b border-squab-300"><td>{i+1}</td><td>{r.name}</td><td>{r.eclecticTotal??0}</td>{(Array.isArray(r.bestPerHole)?r.bestPerHole:Array(18).fill(0)).map((v,ix)=>(<td key={ix}>{v}</td>))}</tr>))}
                  </tbody>
                </table>
              </div>
            </section>
          );
        }

        return (
          <div className="min-h-screen p-4 sm:p-6">
            <div className="max-w-4xl mx-auto space-y-4">
              <Header />
              {view==='home' && <Home />}
              {view==='past' && <PastEvents />}
              {view==='event' && <EventScreen />}
              {view==='ratings' && <Ratings />}
              {view==='standings' && <Standings />}
              {view==='eclectic' && <Eclectic />}
              {view==='help' && <Help />}
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
  </body>
</html>
