<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Den Society — League, Eclectic & Event Ratings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
    <style>
      body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
      .owner-only{display:none;}
      .owner-on .owner-only{display:block;}
      .mono{font-variant-numeric:tabular-nums}
    </style>
  </head>
  <body class="bg-neutral-50 text-neutral-900">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
      /* global React, ReactDOM, supabase */
      const { useMemo, useState, useEffect, useRef } = React;

      // ---------- Small utils ----------
      const POINTS_TABLE = [20,17,15,13,11,9,8,7,6,5,4,3,2,1];
      const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));
      const csvEscape = s => { if (s==null) return ""; const str=String(s); return /[",\n]/.test(str) ? '"' + str.replace(/"/g,'""') + '"' : str; };
      const downloadCSV = (filename, rows) => { const csv = rows.map(r=>r.map(csvEscape).join(",")).join("\n"); const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); };
      const to1 = x => Math.round((Number(x)||0)*10)/10;

      // ---------- Handicap maths ----------
      function playingCapByGender(g){ return g==="F"?36:28; }
      function rangeForHcap(h){ if(h<=9)return"0-9"; if(h<=18)return"10-18"; if(h<=28)return"19-28"; return"29-36"; }
      function cutPerPointOver34(h){ const r=rangeForHcap(h); return r==="0-9"?0.5:r==="10-18"?1:r==="19-28"?1:1.5; }
      function winnerBonusCut(h){ const r=rangeForHcap(h); return r==="0-9"?1:r==="10-18"?2:r==="19-28"?2.5:3; }
      function computeNewExactHandicap(start,g,pts,b9,w){
        const startPlay=Math.round(start); let exact=start;
        if(pts>=35){exact-=cutPerPointOver34(startPlay)*(pts-34);}
        else if(pts<=31){ exact+=0.5*(32-pts);}
        if(w) exact-=winnerBonusCut(startPlay);
        const max=playingCapByGender(g);
        const bounded=clamp(exact,0,60);
        const nextPlay=clamp(Math.round(bounded),0,max);
        return {nextExact:bounded,nextPlaying:nextPlay};
      }

      // Name filter
      const isTeamLike = name => /^(team(\s*\d+)?)$/i.test(name||'') || /^team average$/i.test(name||'') || /^stableford$/i.test(name||'');

      // Supabase helpers
      function normalizeUrl(u){
        if(!u) return '';
        let s = String(u).trim().replace(/\/+$/,'');
        if(!/^https?:\/\//i.test(s)) s = 'https://' + s;
        try{ const url = new URL(s); return `https://${url.host}`; }catch{ return ''; }
      }
      function cleanKey(k){ return (k||'').replace(/[^\x20-\x7E]/g,'').trim(); }
      function makeSupabaseClient(url, key){
        const u = normalizeUrl(url), k = cleanKey(key);
        if(!u || !k) return null;
        if(!(window.supabase && window.supabase.createClient)) throw new Error('supabase-js SDK did not load');
        return window.supabase.createClient(u, k, { auth:{ persistSession:false }});
      }
      async function probe(client){
        try{
          const { error, status } = await client.from('season_standings').select('*').limit(1);
          if(error) return { ok:false, status, msg:error.message };
          return { ok:true, status:200, msg:'Connected' };
        }catch(e){ return { ok:false, status:0, msg:String(e?.message||e) }; }
      }
      const mask = (s, a=6, b=4)=>!s?'':(s.length<=a+b?s:(s.slice(0,a)+'…'+s.slice(-b)));

      // CSV parsing & improved auto-par detection
      function splitSmart(raw){
        const d = raw.includes('\t')? '\t' : ',';
        return raw.split(d).map(s => (s||'').replace(/^"|"$/g,'').trim());
      }
      function asNums(arr){
        return arr.map(x => {
          const v = parseFloat(String(x||'').replace(/[^0-9.\-]/g,''));
          return Number.isFinite(v) ? v : null;
        });
      }
      // Improved detectPars
      function detectParsFromLines(lines){
        const only345 = arr => arr.filter(n => n===3 || n===4 || n===5);
        const candidates = [];
        for (let i=0;i<lines.length;i++){
          const row = lines[i];
          const hasPar = row.some(c => String(c).trim().toLowerCase()==='par');
          if(!hasPar) continue;
          const nums = only345(asNums(row));
          if (nums.length >= 18) { candidates.push(nums.slice(0,18)); continue; }
          if (nums.length >= 8 && nums.length <= 10) {
            for (let j=i+1;j<Math.min(lines.length,i+7);j++){
              const row2 = lines[j]; 
              const hasPar2 = row2.some(c => String(c).trim().toLowerCase()==='par');
              if(!hasPar2) continue;
              const nums2 = only345(asNums(row2));
              if (nums2.length>=8 && nums2.length<=10){
                const joined = only345([...nums,...nums2]).slice(0,18);
                if(joined.length===18) candidates.push(joined);
              }
            }
          }
        }
        if(!candidates.length) return null;
        function score(arr){
          const sum = arr.reduce((a,b)=>a+b,0);
          const c3 = arr.filter(x=>x===3).length;
          const c4 = arr.filter(x=>x===4).length;
          const c5 = arr.filter(x=>x===5).length;
          const compBonus = (c3===4 && c4===10 && c5===4) ? 1000 : 0;
          const lenPen = (arr.length===18)?0:100;
          const sumPen = Math.abs(sum-72);
          return compBonus - lenPen - sumPen;
        }
        candidates.sort((a,b)=>score(b)-score(a));
        return candidates[0].slice(0,18);
      }

      function parseSquabbitCSV(text){
        const rows = text.replace(/\r/g,'').split('\n').filter(Boolean);
        const lines = rows.map(splitSmart);

        const detectedPars = detectParsFromLines(lines);

        const playerHeaderRow = lines.findIndex(r=>(r[0]||'')==='Name' && (r[1]||'')==='Hdcp');
        const byName = new Map();

        if(playerHeaderRow >= 0){
          for(let i=playerHeaderRow+1;i<lines.length;i++){
            const name=(lines[i][0]||'').trim();
            if(!name) break;
            if(isTeamLike(name)) continue;
            const hcap=parseFloat((lines[i][1]||'').trim());
            if(!Number.isNaN(hcap)){
              if(!byName.has(name)){
                byName.set(name,{ name, handicap:hcap, gender:'M', points:0, perHole:[] });
              } else {
                const prev = byName.get(name);
                if(!Number.isFinite(prev.handicap) && Number.isFinite(hcap)) prev.handicap = hcap;
              }
            }
          }
        }

        const stablefordSectionRow=lines.findIndex(r=>(r[0]||'')==='Stableford');
        if(stablefordSectionRow >= 0){
          for(let i=stablefordSectionRow+2;i<lines.length;i++){
            const name=(lines[i][0]||'').trim();
            if(!name) break;
            if(isTeamLike(name)) continue;
            const r1=parseFloat((lines[i][1]||'').trim());
            if(!Number.isNaN(r1)){
              if(!byName.has(name)){
                byName.set(name,{ name, handicap:NaN, gender:'M', points:r1, perHole:[] });
              } else {
                byName.get(name).points = r1;
              }
            }
          }
        }

        const getNum = x => { const v=parseFloat(String(x||'').replace(/[^0-9.\-]/g,'')); return Number.isFinite(v)?v:0; };
        for(const [name, rec] of byName){
          for(let i=0;i<lines.length-1;i++){
            if((lines[i]?.[0]||'').trim()===name && (lines[i+1]?.[1]||'').trim()==='Stableford'){
              const st = lines[i+1]||[];
              const perHole = [...st.slice(3,12).map(getNum), ...st.slice(13,22).map(getNum)];
              rec.perHole = perHole;
              break;
            }
          }
        }

        const outPlayers = Array.from(byName.values()).filter(p=>!isTeamLike(p.name));
        return { players: outPlayers, detectedPars };
      }

      // Ratings per-event
      const ratingLabel = avg => avg>=3?'Excellent':avg>=2.5?'Good':avg>=2?'Solid':avg>=1.5?'Needs work':'Struggle';
      const ratingColor = avg => avg>=3?'text-emerald-700':avg>=2.5?'text-emerald-600':avg>=2?'text-neutral-700':avg>=1.5?'text-amber-700':'text-red-700';

      function eventParAverages(perHole, pars){
        let sums={3:{s:0,c:0},4:{s:0,c:0},5:{s:0,c:0}};
        for(let i=0;i<Math.min(18,perHole.length);i++){
          const pts = Number(perHole[i])||0;
          const par = Number(pars[i])||4;
          if(sums[par]){ sums[par].s+=pts; sums[par].c++; }
        }
        const avg=t => sums[t].c ? (sums[t].s/sums[t].c) : 0;
        return { p3:avg(3), p4:avg(4), p5:avg(5) };
      }

      // ---------- App ----------
      function App(){
        const [ownerMode,setOwnerMode] = useState(sessionStorage.getItem('den_owner_mode')==='1');
        const pressTimer = useRef(null);
        const startPress = ()=>{ pressTimer.current=setTimeout(()=>{ const next=!ownerMode; setOwnerMode(next); if(next) sessionStorage.setItem('den_owner_mode','1'); else sessionStorage.removeItem('den_owner_mode'); }, 1400); };
        const cancelPress = ()=>{ if(pressTimer.current){ clearTimeout(pressTimer.current); pressTimer.current=null; } };
        useEffect(()=>{ if(ownerMode) document.documentElement.classList.add('owner-on'); else document.documentElement.classList.remove('owner-on'); }, [ownerMode]);
        useEffect(()=>{
          const onKey = e=>{ if(e.ctrlKey&&e.altKey&&(e.key==='o'||e.key==='O')){ e.preventDefault(); const next=!ownerMode; setOwnerMode(next); if(next) sessionStorage.setItem('den_owner_mode','1'); else sessionStorage.removeItem('den_owner_mode'); }};
          window.addEventListener('keydown', onKey);
          return ()=>window.removeEventListener('keydown', onKey);
        }, [ownerMode]);

        // Supabase defaults
        const defaultURL = "https://mqknahdfpqxrpgpxqtus.supabase.co";
        const defaultKEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xa25haGRmcHF4cnBncHhxdHVzIiwicm9sZSI6IjIwNzgwMzE3MDYifQ.GTUVsrRJ-MClMg96vuHZpUtAnUFtCsJvuLiiE0D-fCc";

        const [supaURL,setSupaURL] = useState(localStorage.getItem('supa_url')||defaultURL);
        const [supaKEY,setSupaKEY] = useState(localStorage.getItem('supa_key')||defaultKEY);
        const [client,setClient] = useState(null);
        const [statusMsg,setStatusMsg] = useState('Not connected');

        useEffect(()=>{
          let cancelled=false;
          async function boot(){
            try{
              if(!(window.supabase && window.supabase.createClient)){ setTimeout(boot, 600); return; }
              const u = normalizeUrl(localStorage.getItem('supa_url')||defaultURL);
              const k = cleanKey(localStorage.getItem('supa_key')||defaultKEY);
              const c = makeSupabaseClient(u,k);
              if(!c){ setStatusMsg('Invalid URL or key'); return; }
              if(cancelled) return;
              setClient(c);
              const res = await probe(c);
              if(cancelled) return;
              setStatusMsg(res.ok?'Connected':`Error ${res.status}: ${res.msg}`);
              if(res.ok) await fetchSeasonWith(c);
            }catch(e){
              if(!cancelled) setStatusMsg(`Error: ${String(e?.message||e)}`);
            }
          }
          boot();
          return ()=>{ cancelled=true; };
        }, []);

        async function saveSupa(){
          const u = normalizeUrl(supaURL||defaultURL);
          const k = cleanKey(supaKEY||defaultKEY);
          localStorage.setItem('supa_url', u);
          localStorage.setItem('supa_key', k);
          setStatusMsg('Checking connection …');
          try{
            const c = makeSupabaseClient(u,k);
            setClient(c);
            const res = await probe(c);
            setStatusMsg(res.ok?'Connected':`Error ${res.status}: ${res.msg}`);
            if(res.ok) await fetchSeasonWith(c);
          }catch(e){
            setStatusMsg(`Error: ${String(e?.message||e)}`);
          }
        }

        const [eventName,setEventName]=useState("Den Society Meeting");
        const [dateStr,setDateStr]=useState(()=>new Date().toISOString().slice(0,10));
        const [players,setPlayers]=useState([]);
        const [season,setSeason]=useState({});

        const [autoPars,setAutoPars]=useState(null);
        const [overridePars,setOverridePars]=useState('');
        const coursePars = useMemo(()=>{
          if(overridePars){
            try{
              const arr = overridePars.split(',').map(s=>parseInt(s.trim(),10)).filter(Number.isFinite);
              if(arr.length===18) return arr;
            }catch{}
          }
          return autoPars || [4,4,3,4,5,4,3,4,4, 4,5,4,3,4,4,5,3,4];
        }, [autoPars, overridePars]);

        const holeDebug = useMemo(()=>{
          const holes={3:[],4:[],5:[]};
          (coursePars||[]).forEach((p,i)=>{ if([3,4,5].includes(p)) holes[p].push(i+1); });
          return holes;
        }, [coursePars]);

        async function importCSV(file){
          const text = await file.text();
          const parsed = parseSquabbitCSV(text);
          setPlayers(parsed.players||[]);
          setAutoPars(parsed.detectedPars||null);
        }

        function resetEvent(){
          setPlayers([]);
          setAutoPars(null);
          setOverridePars('');
        }
        function resetSeasonLocal(){
          setSeason({});
        }

        const computed = useMemo(()=>{
          const rows = players.map((p,i)=>({ idx:i, name:p.name, gender:p.gender, startExact:p.handicap, points:p.points, perHole:p.perHole }));
          const base = [...rows].sort((a,b)=>(b.points - a.points));
          if(!base.length) return [];
          const groups=[]; const used=new Set();
          for(let i=0;i<base.length;i++){
            if(used.has(base[i].idx)) continue;
            const grp = base.filter(r=>r.points === base[i].points).map(r=>r.idx);
            grp.forEach(id=>used.add(id));
            groups.push(grp);
          }
          let pos=1; const out=[]; const winnerIdx=base[0].idx;
          for(const g of groups){
            const start=pos;
            const pts = POINTS_TABLE[start-1]||0;
            for(const i of g){
              const r = rows.find(x=>x.idx===i);
              const back9 = (r.perHole||[]).slice(9,18).reduce((a,b)=>a + (Number(b)||0),0);
              const res = computeNewExactHandicap(r.startExact, r.gender, r.points, back9, i===winnerIdx);
              out.push({...r, back9, position:start, leaguePoints:pts, isWinner:(i===winnerIdx), ...res});
            }
            pos += g.length;
          }
          out.sort((a,b)=> (a.position - b.position) || (b.back9 - a.back9));
          return out;
        }, [players]);

        async function fetchSeasonWith(c){
          const { data, error } = await c.from('season_standings')
            .select('name,total_points,events,best_event_points,best_hole_points,eclectic_total,best_per_hole');
          if(error){ setStatusMsg(`Error: ${error.message}`); return; }
          const map = {};
          (data||[]).forEach(r=>{
            if(isTeamLike(r.name)) return;
            const bph = Array.isArray(r.best_per_hole)
              ? r.best_per_hole
              : (typeof r.best_per_hole==='string'? (JSON.parse(r.best_per_hole||'[]')||[]) : []);
            map[r.name]={
              name:r.name,
              totalPoints:r.total_points||0,
              events:r.events||0,
              bestEventPoints:r.best_event_points??0,
              bestHolePoints:r.best_hole_points??0,
              eclecticTotal:r.eclectic_total??0,
              bestPerHole:(bph||[]).map(n=>Number(n)||0)
            };
          });
          setSeason(map);
        }

        async function addEventToSeason(){
          const next={...season};
          for(const r of computed){
            if(isTeamLike(r.name)) continue;
            const prev = next[r.name] || {name:r.name,totalPoints:0,events:0,bestPerHole:Array(18).fill(0),eclecticTotal:0,bestEventPoints:0,bestHolePoints:0};
            const bestPerHole = Array.from({length:18},(_,i)=>Math.max(prev.bestPerHole[i]||0, (r.perHole||[])[i]||0));
            const eTotal = bestPerHole.reduce((s,v)=>s+(Number(v)||0),0);
            const neEv = Math.max(prev.bestEventPoints||0, r.points||0);
            const neH = Math.max(prev.bestHolePoints||0, Math.max(0, ...(r.perHole||[])));
            next[r.name] = {
              name:r.name,
              totalPoints:(prev.totalPoints||0)+(r.leaguePoints||0),
              events:(prev.events||0)+1,
              bestEventPoints:neEv,
              bestHolePoints:neH,
              eclecticTotal:eTotal,
              bestPerHole
            };
          }
          setSeason(next);

          if(client){
            const rows = Object.values(next)
              .filter(r=>!isTeamLike(r.name))
              .map(r=>({
                name:r.name,
                total_points:r.totalPoints|0,
                events:r.events|0,
                best_event_points:r.bestEventPoints|0,
                best_hole_points:r.bestHolePoints|0,
                eclectic_total:r.eclecticTotal|0,
                best_per_hole: Array.isArray(r.bestPerHole) ? r.bestPerHole.map(n=>Number(n)||0) : Array(18).fill(0)
              }));
            const { error } = await client.from('season_standings').upsert(rows,{onConflict:'name'});
            if(error){ setStatusMsg(`Error: ${error.message}`); }
            else { setStatusMsg('Connected'); }
          }
        }

        const ratings = useMemo(()=>{
          const out=[];
          for(const p of players){
            if(isTeamLike(p.name)) continue;
            const {p3,p4,p5} = eventParAverages(p.perHole||[], coursePars);
            out.push({
              name:p.name,
              p3: to1(p3), p4: to1(p4), p5: to1(p5),
              r3: ratingLabel(p3), r4: ratingLabel(p4), r5: ratingLabel(p5),
              c3: ratingColor(p3), c4: ratingColor(p4), c5: ratingColor(p5),
              total: (p3+p4+p5)
            });
          }
          out.sort((a,b)=> b.total - a.total || a.name.localeCompare(b.name));
          return out;
        }, [players, coursePars]);

        const fieldAvg = useMemo(()=>{
          let s3=0,c3=0,s4=0,c4=0,s5=0,c5=0;
          for(const p of players){
            if(isTeamLike(p.name)) continue;
            const ph = p.perHole||[];
            for(let i=0;i<Math.min(18, ph.length); i++){
              const pts=Number(ph[i])||0;
              const par=Number(coursePars[i])||4;
              if(par===3){s3+=pts; c3++;} else if(par===4){s4+=pts; c4++;} else if(par===5){s5+=pts; c5++;}
            }
          }
          const a3 = c3?s3/c3:0, a4=c4?s4/c4:0, a5=c5?s5/c5:0;
          return {
            p3:to1(a3), p4:to1(a4), p5:to1(a5),
            r3: ratingLabel(a3), r4: ratingLabel(a4), r5: ratingLabel(a5),
            c3: ratingColor(a3), c4: ratingColor(a4), c5: ratingColor(a5)
          };
        }, [players, coursePars]);

        return (
          <div className={"min-h-screen p-4 sm:p-6 md:p-8 "+(ownerMode?"owner-on":"")}>
            <div className="max-w-6xl mx-auto space-y-6">

              {/* Header */}
              <header className="flex flex-col md:flex-row md:items-end gap-3 justify-between"
                onMouseDown={startPress} onMouseUp={cancelPress} onMouseLeave={cancelPress}
                onTouchStart={startPress} onTouchEnd={cancelPress}>
                <div>
                  <h1 className="text-2xl md:text-3xl font-bold tracking-tight">Den Society — League, Eclectic & Event Ratings</h1>
                  <p className="text-sm owner-only" style={{color: statusMsg.startsWith('Connected')? '#059669':'#dc2626'}}>Supabase: {statusMsg}</p>
                  <p className="text-xs text-neutral-500 owner-only">Using URL: <code>{localStorage.getItem('supa_url')||''}</code> · Key: <code>{mask(localStorage.getItem('supa_key')||'')}</code></p>
                </div>
                <div className="flex gap-2 items-center">
                  <input className="px-3 py-2 rounded-xl border border-neutral-300 bg-white" value={eventName} onChange={e=>setEventName(e.target.value)} />
                  <input type="date" className="px-3 py-2 rounded-xl border border-neutral-300 bg-white" value={dateStr} onChange={e=>setDateStr(e.target.value)} />
                </div>
              </header>

              {/* Owner Settings */}
              <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6 owner-only">
                <h2 className="text-lg font-semibold mb-2">Settings</h2>
                <div className="grid md:grid-cols-2 gap-3">
                  <div>
                    <label className="text-sm block mb-1">Supabase URL</label>
                    <input className="w-full px-3 py-2 rounded-xl border border-neutral-300 bg-white" value={supaURL} onChange={e=>setSupaURL(e.target.value)} />
                  </div>
                  <div>
                    <label className="text-sm block mb-1">Supabase anon (public) key</label>
                    <input className="w-full px-3 py-2 rounded-xl border border-neutral-300 bg-white" value={supaKEY} onChange={e=>setSupaKEY(e.target.value)} />
                  </div>
                </div>
                <div className="mt-3 flex gap-2">
                  <button onClick={saveSupa} className="px-3 py-2 rounded-xl bg-emerald-600 text-white">Save & Connect</button>
                  <button onClick={()=>client && fetchSeasonWith(client)} className="px-3 py-2 rounded-xl border border-neutral-300">Reload Season</button>
                </div>
              </section>

              {/* Import + Event table */}
              <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6">
                <div className="flex justify-between mb-4">
                  <h2 className="text-lg font-semibold">Event Players</h2>
                  <div className="flex flex-wrap gap-2">
                    <label className="px-3 py-2 rounded-xl border border-neutral-300 bg-white cursor-pointer">Import Squabbit CSV
                      <input type="file" accept=".csv" className="hidden" onChange={e=>{const f=e.target.files?.[0]; if(f) importCSV(f);}} />
                    </label>
                    <button onClick={addEventToSeason} disabled={!players.length} className="px-3 py-2 rounded-xl bg-emerald-600 text-white disabled:opacity-40">Add Event → Season</button>
                    <button onClick={resetEvent} className="px-3 py-2 rounded-xl border border-red-300 text-red-700">Reset Event</button>
                  </div>
                </div>
                <div className="overflow-auto">
                  <table className="min-w-full text-sm">
                    <thead><tr className="border-b text-left"><th>#</th><th>Name</th><th>Handicap</th><th>Stableford</th><th>Back9</th><th>Pts</th><th>Next PH</th></tr></thead>
                    <tbody>
                      {computed.length===0 && (<tr><td colSpan="7" className="py-3 text-neutral-500">Import a Squabbit CSV to see the event.</td></tr>)}
                      {computed.map((r,i)=>(<tr key={i} className="border-b"><td>{r.position}</td><td>{r.name}</td><td>{Math.round(r.startExact)}</td><td>{r.points}</td><td>{r.back9}</td><td>{r.leaguePoints}</td><td>{r.nextPlaying}</td></tr>))}
                    </tbody>
                  </table>
                </div>
                <p className="text-xs text-neutral-500 mt-2">Ties share the highest available slot. Countback uses Back-9 from the detailed card.</p>
              </section>

              {/* Season standings */}
              <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6">
                <div className="flex justify-between mb-4">
                  <h2 className="text-lg font-semibold">Season Standings</h2>
                  <div className="flex gap-2">
                    <button onClick={()=>{const list=Object.values(season).filter(r=>!isTeamLike(r.name)).sort((a,b)=>(b.totalPoints-a.totalPoints)||a.name.localeCompare(b.name)); const rows=[["Rank","Name","Events","Total Points","Best Event","Best Hole","Eclectic Total"], ...list.map((r,i)=>[i+1,r.name,r.events,r.totalPoints,r.bestEventPoints??0,r.bestHolePoints??0,r.eclecticTotal??0])]; downloadCSV(`DenSociety_Standings_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.csv`, rows);} } className="px-3 py-2 rounded-2xl bg-black text-white">Export Standings</button>
                    <button onClick={resetSeasonLocal} className="px-3 py-2 rounded-2xl border border-red-300 text-red-700" title="Clears local season table only (does not touch Supabase)">Reset Season (local)</button>
                  </div>
                </div>
                <div className="overflow-auto">
                  <table className="min-w-full text-sm">
                    <thead><tr className="border-b text-left"><th>Rank</th><th>Name</th><th>Events</th><th>Total Points</th><th>Best Event</th><th>Best Hole</th><th>Eclectic Total</th></tr></thead>
                    <tbody>
                      {Object.values(season).filter(r=>!isTeamLike(r.name)).sort((a,b)=> (b.totalPoints-a.totalPoints)||a.name.localeCompare(b.name)).map((r,i)=>(<tr key={r.name} className="border-b"><td>{i+1}</td><td>{r.name}</td><td>{r.events}</td><td>{r.totalPoints}</td><td>{r.bestEventPoints??0}</td><td>{r.bestHolePoints??0}</td><td>{r.eclecticTotal??0}</td></tr>))}
                    </tbody>
                  </table>
                </div>
              </section>

              {/* Eclectic leaderboard */}
              <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6">
                <div className="flex justify-between mb-4">
                  <h2 className="text-lg font-semibold">Eclectic Leaderboard</h2>
                  <div className="flex gap-2">
                    <button onClick={()=>{const list=Object.values(season).filter(r=>!isTeamLike(r.name)).sort((a,b)=>(b.eclecticTotal??0)-(a.eclecticTotal??0)||a.name.localeCompare(b.name)); const header=["Rank","Name","Eclectic Total",...Array.from({length:18},(_,i)=>`H${i+1}`)]; const rows=[header, ...list.map((r,i)=>[i+1,r.name,r.eclecticTotal??0,...(r.bestPerHole??Array(18).fill(0))])]; downloadCSV(`DenSociety_Eclectic_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.csv`, rows);} } className="px-3 py-2 rounded-2xl bg-black text-white">Export Eclectic CSV</button>
                  </div>
                </div>
                <div className="overflow-auto">
                  <table className="min-w-full text-sm mono">
                    <thead><tr className="border-b text-left"><th>Rank</th><th>Name</th><th>Eclectic Total</th>{Array.from({length:18},(_,i)=>(<th key={i}>H{i+1}</th>))}</tr></thead>
                    <tbody>{Object.values(season).filter(r=>!isTeamLike(r.name)).sort((a,b)=>( (b.eclecticTotal??0) - (a.eclecticTotal??0) ) || a.name.localeCompare(b.name)).map((r,i)=>(<tr key={r.name} className="border-b"><td>{i+1}</td><td>{r.name}</td><td>{r.eclecticTotal??0}</td>{(r.bestPerHole??Array(18).fill(0)).map((v,ix)=>(<td key={ix}>{v}</td>))}</tr>))}</tbody>
                  </table>
                </div>
              </section>

              {/* Ratings — per event */}
              <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6">
                <div className="flex items-center justify-between mb-2">
                  <h2 className="text-lg font-semibold">Ratings — Par 3 / Par 4 / Par 5 (This Event)</h2>
                  <button className="px-3 py-2 rounded-2xl bg-black text-white disabled:opacity-40" disabled={!ratings.length} onClick={()=>{
                    const rows=[["Name","Par-3 avg","Par-3 rating","Par-4 avg","Par-4 rating","Par-5 avg","Par-5 rating"]];
                    if(ratings.length){ rows.push(["Field Average", fieldAvg.p3, fieldAvg.r3, fieldAvg.p4, fieldAvg.r4, fieldAvg.p5, fieldAvg.r5]); }
                    ratings.forEach(r=>rows.push([r.name, r.p3, r.r3, r.p4, r.r4, r.p5, r.r5]));
                    downloadCSV(`DenSociety_EventRatings_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.csv`, rows);
                  }}>Export Ratings</button>
                </div>
                <p className="text-xs text-neutral-600 mb-3">Pars are auto-detected from the CSV (front/back or full row). You can override in Owner Mode.</p>
                <div className="overflow-auto">
                  <table className="min-w-full text-sm">
                    <thead><tr className="border-b text-left"><th>Name</th><th>Par-3 avg</th><th>Par-3 rating</th><th>Par-4 avg</th><th>Par-4 rating</th><th>Par-5 avg</th><th>Par-5 rating</th></tr></thead>
                    <tbody>
                      {ratings.length>0 && (<tr className="border-b bg-neutral-50 font-semibold"><td>Field Average</td><td>{fieldAvg.p3.toFixed(1)}</td><td className={fieldAvg.c3}>{fieldAvg.r3}</td><td>{fieldAvg.p4.toFixed(1)}</td><td className={fieldAvg.c4}>{fieldAvg.r4}</td><td>{fieldAvg.p5.toFixed(1)}</td><td className={fieldAvg.c5}>{fieldAvg.r5}</td></tr>)}
                      {ratings.map(r=>(<tr key={r.name} className="border-b"><td className="font-medium">{r.name}</td><td>{r.p3.toFixed(1)}</td><td className={r.c3}>{r.r3}</td><td>{r.p4.toFixed(1)}</td><td className={r.c4}>{r.r4}</td><td>{r.p5.toFixed(1)}</td><td className={r.c5}>{r.r5}</td></tr>))}
                      {ratings.length===0 && (<tr><td colSpan="7" className="py-3 text-neutral-500">Import a Squabbit CSV to see event ratings.</td></tr>)}
                    </tbody>
                  </table>
                </div>

                {/* Owner-only debug & override */}
                <div className="owner-only mt-4 rounded-lg border border-neutral-200 p-3 bg-neutral-50">
                  <div className="text-sm font-medium mb-1">Owner Debug — Pars</div>
                  <div className="text-xs mono">
                    <div>Auto-detected pars: {((autoPars && autoPars.length===18)?autoPars.join(', '):'(none)')}</div>
                    <div>Using pars: {coursePars.join(', ')}</div>
                    <div>Par-3 holes: {holeDebug[3].join(', ')||'—'}</div>
                    <div>Par-4 holes: {holeDebug[4].join(', ')||'—'}</div>
                    <div>Par-5 holes: {holeDebug[5].join(', ')||'—'}</div>
                  </div>
                  <div className="mt-2">
                    <label className="text-xs block mb-1">Override pars (comma-separated 18 values; leave blank to use auto)</label>
                    <input className="w-full border rounded-lg p-2 mono bg-white"
                           value={overridePars} onChange={e=>setOverridePars(e.target.value)}
                           placeholder="e.g. 4,4,3,4,5,4,3,4,4,4,5,4,3,4,4,5,3,4" />
                  </div>
                </div>
              </section>

              {/* How-to */}
              <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6">
                <h2 className="text-lg font-semibold mb-2">How to Use</h2>
                <ol className="list-decimal pl-5 space-y-1 text-sm text-neutral-700">
                  <li>Import a Squabbit CSV.</li>
                  <li>Event table + Ratings (this event) appear immediately. Pars are auto-detected.</li>
                  <li>(Optional) Click <strong>Add Event → Season</strong> to update league & eclectic in Supabase.</li>
                  <li>Owner Mode (long-press title or Ctrl+Alt+O) shows Supabase settings and par override/debug.</li>
                </ol>
              </section>

            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
