<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Den Society — League & Eclectic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
    <style>body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}</style>
  </head>
  <body class="bg-neutral-50 text-neutral-900">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
      /* global React, ReactDOM, supabase */
      const { useMemo, useState, useEffect } = React;
      const POINTS_TABLE = [20,17,15,13,11,9,8,7,6,5,4,3,2,1];
      const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));
      const csvEscape = s => { if (s==null) return ""; const str=String(s); return /[",\n]/.test(str) ? '"' + str.replace(/"/g,'""') + '"' : str; };
      const downloadCSV = (filename, rows) => { const csv = rows.map(r=>r.map(csvEscape).join(",")).join("\n"); const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); };

      function playingCapByGender(g){ return g==="F"?36:28; }
      function rangeForHcap(h){ if(h<=9)return"0-9"; if(h<=18)return"10-18"; if(h<=28)return"19-28"; return"29-36"; }
      function cutPerPointOver34(h){ const r=rangeForHcap(h); return r==="0-9"?0.5:r==="10-18"?1:r==="19-28"?1:1.5; }
      function winnerBonusCut(h){ const r=rangeForHcap(h); return r==="0-9"?1:r==="10-18"?2:r==="19-28"?2.5:3; }
      function computeNewExactHandicap(start,g,pts,b9,w){ const startPlay=Math.round(start); let exact=start; if(pts>=35){exact-=cutPerPointOver34(startPlay)*(pts-34);} else if(pts<=31){ exact+=0.5*(32-pts);} if(w) exact-=winnerBonusCut(startPlay); const max=playingCapByGender(g); const bounded=clamp(exact,0,60); const nextPlay=clamp(Math.round(bounded),0,max); return {nextExact:bounded,nextPlaying:nextPlay}; }

      function parseSquabbitCSV(text){
        const rows=text.replace(/\r/g,'').split('\n');
        const lines=rows.map(raw=>{ const d=raw.includes('\t')?'\t':','; return raw.split(d).map(s=>(s||'').replace(/^"|"$/g,'').trim()); });

        // 1) Players table
        const playerHeaderRow=lines.findIndex(r=>(r[0]||'')==='Name'&&(r[1]||'')==='Hdcp');
        const players=[];
        if(playerHeaderRow>=0){
          for(let i=playerHeaderRow+1;i<lines.length;i++){
            const name=(lines[i][0]||'').trim();
            const hcap=parseFloat((lines[i][1]||'').trim());
            if(!name) break;
            if(!Number.isNaN(hcap)) players.push({name,handicap:hcap,gender:'M'});
          }
        }

        // 2) Stableford totals
        const stablefordSectionRow=lines.findIndex(r=>(r[0]||'')==='Stableford');
        const totals={};
        if(stablefordSectionRow>=0){
          for(let i=stablefordSectionRow+2;i<lines.length;i++){
            const name=(lines[i][0]||'').trim();
            if(!name) break;
            const r1=parseFloat((lines[i][1]||'').trim());
            if(!Number.isNaN(r1)) totals[name]=r1;
          }
        }

        // 3) Per-hole Stableford from detailed card
        const holeData={};
        const getNum = (x) => {
          const v = parseFloat(String(x||'').replace(/[^0-9.\-]/g,''));
          return Number.isFinite(v) ? v : 0;
        };

        for(const p of players){
          for(let i=0;i<lines.length-1;i++){
            if((lines[i]?.[0]||'').trim()===p.name && (lines[i+1]?.[1]||'').trim()==='Stableford'){
              const st=lines[i+1]||[];
              const front9 = st.slice(3,12).map(getNum);   // D..L
              const back9H = st.slice(13,22).map(getNum);  // N..V
              const perHole = [...front9, ...back9H];
              const back9 = back9H.reduce((a,b)=>a+b,0);
              const maxHole = perHole.length ? Math.max(...perHole) : 0;
              holeData[p.name]={perHole,back9,maxHole};
              break;
            }
          }
        }

        return players.map(p=>({
          name:p.name,
          gender:p.gender,
          handicap:p.handicap,
          points:totals[p.name]||0,
          back9:holeData[p.name]?.back9||0,
          perHole:holeData[p.name]?.perHole||[],
          eventMaxHole:holeData[p.name]?.maxHole||0
        }));
      }

      function mergeEclectic(prev,currentPerHole){
        const bestPerHole=Array.from({length:18},(_,i)=>Math.max(prev?.[i]??0,currentPerHole?.[i]??0));
        const eclecticTotal=bestPerHole.reduce((s,v)=>s+(isFinite(v)?v:0),0);
        return {bestPerHole,eclecticTotal};
      }

      // ---------- Supabase helpers (robust + forgiving) ----------
      function normalizeUrl(u){
        if(!u) return '';
        let s = String(u).trim();
        s = s.replace(/\/+$/,''); // drop trailing slashes
        // If user typed bare host, add https://
        if(!/^https?:\/\//i.test(s)) s = 'https://' + s;
        try{
          const url = new URL(s);
          return `https://${url.host}`; // ensure no path
        }catch{
          return '';
        }
      }

      function cleanKey(k){
        if(!k) return '';
        // strip non-printable/invisible characters, then trim
        return String(k).replace(/[^\x20-\x7E]/g,'').trim();
      }

      function jwtRefFromKey(k){
        try{
          const parts = k.split('.');
          if(parts.length < 2) return null;
          const b64 = parts[1].replace(/-/g,'+').replace(/_/g,'/');
          const json = atob(b64);
          const payload = JSON.parse(json);
          return payload?.ref || null;
        }catch{ return null; }
      }

      function makeSupabaseClient(url, key){
        try{
          const u = normalizeUrl(url);
          const k = cleanKey(key);
          if(!u || !k) return null; // only reject if empty after cleaning
          return window.supabase.createClient(u, k, { auth: { persistSession:false }});
        }catch(e){
          console.warn("Supabase client failed", e);
          return null;
        }
      }

      async function probe(client){
        try{
          const { data, error, status } = await client
            .from('season_standings')
            .select('*', { head:false })
            .limit(1);
          if(error) return { ok:false, status, msg:error.message };
          return { ok:true, status:200, msg:'Connected' };
        }catch(e){
          return { ok:false, status:0, msg:String(e?.message||e) };
        }
      }

      function mask(s, showStart=6, showEnd=4){
        if(!s) return '';
        if(s.length <= showStart + showEnd) return s;
        return s.slice(0,showStart) + '…' + s.slice(-showEnd);
      }

      function App(){
        const [players,setPlayers]=useState([]);
        const [eventName,setEventName]=useState("Den Society Meeting");
        const [dateStr,setDateStr]=useState(()=>new Date().toISOString().slice(0,10));
        const [season,setSeason]=useState({});
        const [statusMsg,setStatusMsg]=useState('Not connected');

        // Defaults baked in (used when inputs are blank)
        const defaultURL = "https://mqknahdfpqxrpgpxqtus.supabase.co";
        const defaultKEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xa25haGRmcHF4cnBncHhxdHVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTU3MDYsImV4cCI6MjA3ODAzMTcwNn0.GTUVsrRJ-MClMg96vuHZpUtAnUFtCsJvuLiiE0D-fCc";

        const [supaURL,setSupaURL]=useState(localStorage.getItem('supa_url')||defaultURL);
        const [supaKEY,setSupaKEY]=useState(localStorage.getItem('supa_key')||defaultKEY);

        const [client,setClient] = useState(makeSupabaseClient(
          normalizeUrl(localStorage.getItem('supa_url') || defaultURL),
          cleanKey(localStorage.getItem('supa_key') || defaultKEY)
        ));

        const connected = statusMsg.startsWith('Connected');

        async function saveSupa(){
          // if user left inputs empty, fall back to defaults
          const rawU = (supaURL || '').trim();
          const rawK = (supaKEY || '').trim();
          const u = normalizeUrl(rawU || defaultURL);
          const k = cleanKey(rawK || defaultKEY);

          localStorage.setItem('supa_url', u);
          localStorage.setItem('supa_key', k);

          const c = makeSupabaseClient(u, k);
          setClient(c);

          if(!c){
            setStatusMsg('Invalid URL or key (empty after cleaning + defaults)');
            return;
          }

          const ref = jwtRefFromKey(k);
          const subdomain = (u.match(/^https:\/\/([^\.]+)/i) || [,''])[1];
          if(ref && subdomain && ref !== subdomain){
            setStatusMsg(`Warning: key is for "${ref}" but URL is "${subdomain}". Trying anyway…`);
          } else {
            setStatusMsg('Checking connection…');
          }

          const res = await probe(c);
          setStatusMsg(res.ok ? 'Connected' : `Error ${res.status}: ${res.msg}`);
        }

        async function fetchSeason(){
          if(!client){ setStatusMsg('Not connected'); return; }
          const { data, error } = await client.from('season_standings')
            .select('name,total_points,events,best_event_points,best_hole_points,eclectic_total,best_per_hole');
          if(error){ setStatusMsg(`Error: ${error.message}`); console.warn('Supabase fetch error',error); return; }
          setStatusMsg('Connected');
          const map={};
          (data||[]).forEach(r=>{
            const bph = Array.isArray(r.best_per_hole)
              ? r.best_per_hole
              : (typeof r.best_per_hole === 'string'
                  ? (JSON.parse(r.best_per_hole||'[]')||[])
                  : []);
            map[r.name]={
              name:r.name,
              totalPoints:r.total_points||0,
              events:r.events||0,
              bestEventPoints:r.best_event_points??0,
              bestHolePoints:r.best_hole_points??0,
              eclecticTotal:r.eclectic_total??0,
              bestPerHole:Array.isArray(bph)?bph.map(n=>Number(n)||0):Array(18).fill(0)
            };
          });
          setSeason(map);
        }

        useEffect(()=>{ (async()=>{
          if(!client) return;
          const res = await probe(client);
          setStatusMsg(res.ok ? 'Connected' : `Error ${res.status}: ${res.msg}`);
          if(res.ok) await fetchSeason();
        })(); }, [client]);

        async function importCSV(file){ const text=await file.text(); setPlayers(parseSquabbitCSV(text)); }

        const [computed,setComputed]=useState([]);
        useMemo(()=>{
          const rows=players.map((p,i)=>({idx:i,name:p.name,gender:p.gender,startExact:p.handicap,points:p.points,back9:p.back9,perHole:p.perHole}));
          const base=[...rows].sort((a,b)=>(b.points-a.points)||(b.back9-a.back9));
          if(!base.length){setComputed([]);return;}
          // Tie groups by total points; share highest slot points
          const groups=[]; const used=new Set();
          for(let i=0;i<base.length;i++){
            if(used.has(base[i].idx)) continue;
            const grp=base.filter(r=>r.points===base[i].points).map(r=>r.idx);
            grp.forEach(id=>used.add(id)); groups.push(grp);
          }
          let pos=1; const out=[]; const winnerIdx=base[0].idx;
          for(const g of groups){
            const start=pos;
            const ptsValue=POINTS_TABLE[start-1]||0;
            for(const i of g){
              const r=rows.find(x=>x.idx===i);
              const res=computeNewExactHandicap(r.startExact,r.gender,r.points,r.back9,i===winnerIdx);
              out.push({...r,position:start,leaguePoints:ptsValue,isWinner:i===winnerIdx,...res});
            }
            pos+=g.length;
          }
          setComputed(out.sort((a,b)=>a.position-b.position));
        },[players]);

        async function addEventToSeason(){
          const next={...season};
          for(const r of computed){
            const prev=next[r.name]||{name:r.name,totalPoints:0,events:0,bestPerHole:Array(18).fill(0),eclecticTotal:0,bestEventPoints:0,bestHolePoints:0};
            const {bestPerHole,eclecticTotal}=mergeEclectic(prev.bestPerHole,r.perHole||[]);
            const nextBestEvent=Math.max(prev.bestEventPoints||0,r.points||0);
            const nextBestHole=Math.max(prev.bestHolePoints||0,Math.max(0,...(r.perHole||[])));
            next[r.name]={ name:r.name, totalPoints:(prev.totalPoints||0)+(r.leaguePoints||0), events:(prev.events||0)+1, bestEventPoints:nextBestEvent, bestHolePoints:nextBestHole, bestPerHole, eclecticTotal };
          }
          setSeason(next);

          if(client){
            const rows=Object.values(next).map(r=>({
              name:r.name,
              total_points: r.totalPoints|0,
              events: r.events|0,
              best_event_points: r.bestEventPoints|0,
              best_hole_points: r.bestHolePoints|0,
              eclectic_total: r.eclecticTotal|0,
              best_per_hole: Array.isArray(r.bestPerHole) ? r.bestPerHole.map(n=>Number(n)||0) : Array(18).fill(0),
            }));
            const { error } = await client.from('season_standings').upsert(rows, { onConflict:'name' });
            if(error){ setStatusMsg(`Error: ${error.message}`); console.warn('Supabase upsert error', error); }
            else { setStatusMsg('Connected'); }
          }
        }

        function exportEvent(){
          const rows=[["Event",eventName,"Date",dateStr],[],
            ["Name","Gender","Exact","Stableford","Back9","Pos","Pts","NextExact","NextPlay"],
            ...computed.map(r=>[r.name,r.gender,Math.round(r.startExact),r.points,r.back9,r.position,r.leaguePoints,r.nextExact.toFixed(1),r.nextPlaying])
          ];
          downloadCSV(`DenSociety_${dateStr.replace(/-/g,'')}.csv`,rows);
        }

        function exportStandings(){
          const list=Object.values(season).sort((a,b)=>(b.totalPoints-a.totalPoints)||a.name.localeCompare(b.name));
          const rows=[["Rank","Name","Events","Total Points","Best Event","Best Hole","Eclectic Total"],
            ...list.map((r,i)=>[i+1,r.name,r.events,r.totalPoints,r.bestEventPoints??0,r.bestHolePoints??0,r.eclecticTotal??0])
          ];
          downloadCSV(`DenSociety_Standings_${dateStr.replace(/-/g,'')}.csv`,rows);
        }

        function exportEclecticCSV(){
          const list=Object.values(season).sort((a,b)=>(b.eclecticTotal??0)-(a.eclecticTotal??0)||a.name.localeCompare(b.name));
          const header=["Rank","Name","Eclectic Total",...Array.from({length:18},(_,i)=>`H${i+1}`)];
          const rows=[header,
            ...list.map((r,i)=>[i+1,r.name,r.eclecticTotal??0,...(r.bestPerHole??Array(18).fill(0))])
          ];
          downloadCSV(`DenSociety_Eclectic_${dateStr.replace(/-/g,'')}.csv`,rows);
        }

        function resetSeason(){ setSeason({}); }

        // Small debug footer (what values are currently in use)
        function DebugStatus(){
          const u = (localStorage.getItem('supa_url')||'').toString();
          const k = (localStorage.getItem('supa_key')||'').toString();
          return (
            <p className="text-xs text-neutral-500 mt-1">
              Using URL: <code>{u||'(empty)'}</code> · Key: <code>{mask(k)}</code>
            </p>
          );
        }

        return (
          <div className="min-h-screen p-4 sm:p-6 md:p-8">
            <div className="max-w-6xl mx-auto space-y-6">
              <header className="flex flex-col md:flex-row md:items-end gap-3 justify-between">
                <div>
                  <h1 className="text-2xl md:text-3xl font-bold tracking-tight">Den Society — League & Eclectic</h1>
                  <p className="text-sm" style={{color: connected ? '#059669' : '#dc2626'}}>
                    Supabase: {statusMsg}
                  </p>
                  <DebugStatus />
                </div>
                <div className="flex gap-2 items-center">
                  <input className="px-3 py-2 rounded-xl border border-neutral-300 bg-white" value={eventName} onChange={e=>setEventName(e.target.value)} />
                  <input type="date" className="px-3 py-2 rounded-xl border border-neutral-300 bg-white" value={dateStr} onChange={e=>setDateStr(e.target.value)} />
                  <button onClick={exportEvent} className="px-4 py-2 rounded-xl bg-black text-white disabled:opacity-40" disabled={!players.length}>Export Event CSV</button>
                </div>
              </header>

              {/* Settings */}
              <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6">
                <h2 className="text-lg font-semibold mb-2">Settings</h2>
                <div className="grid md:grid-cols-2 gap-3">
                  <div>
                    <label className="text-sm block mb-1">Supabase URL</label>
                    <input className="w-full px-3 py-2 rounded-xl border border-neutral-300 bg-white" placeholder="https://xxxx.supabase.co" value={supaURL} onChange={e=>setSupaURL(e.target.value)} />
                  </div>
                  <div>
                    <label className="text-sm block mb-1">Supabase anon (public) key</label>
                    <input className="w-full px-3 py-2 rounded-xl border border-neutral-300 bg-white" placeholder="eyJ..." value={supaKEY} onChange={e=>setSupaKEY(e.target.value)} />
                  </div>
                </div>
                <div className="mt-3 flex gap-2">
                  <button onClick={saveSupa} className="px-3 py-2 rounded-xl bg-emerald-600 text-white">Save & Connect</button>
                  <button onClick={()=>{ localStorage.removeItem('supa_url'); localStorage.removeItem('supa_key'); setSupaURL(''); setSupaKEY(''); setClient(null); setStatusMsg('Not connected'); }} className="px-3 py-2 rounded-xl border border-red-300 text-red-700">Disconnect</button>
                  <button onClick={fetchSeason} className="px-3 py-2 rounded-xl border border-neutral-300">Reload Season</button>
                </div>
                <p className="text-xs text-neutral-500 mt-2">Tip: You can type just <code>mqknahdfpqxrpgpxqtus.supabase.co</code> — I'll add <code>https://</code> for you.</p>
              </section>

              {/* Import + Event table */}
              <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6">
                <div className="flex justify-between mb-4">
                  <h2 className="text-lg font-semibold">Event Players</h2>
                  <div className="flex flex-wrap gap-2">
                    <label className="px-3 py-2 rounded-xl border border-neutral-300 bg-white cursor-pointer">Import CSV
                      <input type="file" accept=".csv" className="hidden" onChange={e=>{const f=e.target.files?.[0];if(f)importCSV(f);}} />
                    </label>
                    <button onClick={addEventToSeason} disabled={!players.length} className="px-3 py-2 rounded-xl bg-emerald-600 text-white disabled:opacity-40">Add Event → Season</button>
                  </div>
                </div>
                <div className="overflow-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                      <tr className="border-b text-left"><th>#</th><th>Name</th><th>Handicap</th><th>Stableford</th><th>Back9</th><th>Pts</th><th>Next PH</th></tr>
                    </thead>
                    <tbody>
                      {computed.map((r,i)=> (
                        <tr key={i} className="border-b">
                          <td>{r.position}</td>
                          <td>{r.name}</td>
                          <td>{Math.round(r.startExact)}</td>
                          <td>{r.points}</td>
                          <td>{r.back9}</td>
                          <td>{r.leaguePoints}</td>
                          <td>{r.nextPlaying}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                <p className="text-xs text-neutral-500 mt-2">Countback uses Back 9 from the player's detailed "Stableford" row. Ties share the highest available slot.</p>
              </section>

              {/* League standings */}
              <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6">
                <div className="flex justify-between mb-4">
                  <h2 className="text-lg font-semibold">Season Standings</h2>
                  <div className="flex gap-2">
                    <button onClick={exportStandings} className="px-3 py-2 rounded-2xl bg-black text-white">Export Standings</button>
                    <button onClick={resetSeason} className="px-3 py-2 rounded-2xl border border-red-300 text-red-700">Reset Season (local)</button>
                  </div>
                </div>
                <div className="overflow-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                      <tr className="border-b text-left">
                        <th>Rank</th><th>Name</th><th>Events</th><th>Total Points</th><th>Best Event</th><th>Best Hole</th><th>Eclectic Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.values(season).sort((a,b)=> (b.totalPoints - a.totalPoints) || a.name.localeCompare(b.name)).map((r,i)=> (
                        <tr key={r.name} className="border-b">
                          <td>{i+1}</td>
                          <td>{r.name}</td>
                          <td>{r.events}</td>
                          <td>{r.totalPoints}</td>
                          <td>{r.bestEventPoints ?? 0}</td>
                          <td>{r.bestHolePoints ?? 0}</td>
                          <td>{r.eclecticTotal ?? 0}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </section>

              {/* Eclectic leaderboard */}
              <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6">
                <div className="flex justify-between mb-4">
                  <h2 className="text-lg font-semibold">Eclectic Leaderboard</h2>
                  <div className="flex gap-2">
                    <button onClick={exportEclecticCSV} className="px-3 py-2 rounded-2xl bg-black text-white">Export Eclectic CSV</button>
                  </div>
                </div>
                <div className="overflow-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                      <tr className="border-b text-left">
                        <th>Rank</th><th>Name</th><th>Eclectic Total</th>
                        {Array.from({length:18},(_,i)=>(<th key={i}>H{i+1}</th>))}
                      </tr>
                    </thead>
                    <tbody>
                      {Object.values(season)
                        .sort((a,b)=>( (b.eclecticTotal??0) - (a.eclecticTotal??0) ) || a.name.localeCompare(b.name))
                        .map((r,i)=>(
                        <tr key={r.name} className="border-b">
                          <td>{i+1}</td>
                          <td>{r.name}</td>
                          <td>{r.eclecticTotal ?? 0}</td>
                          {(r.bestPerHole??Array(18).fill(0)).map((v,ix)=>(<td key={ix}>{v}</td>))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                <p className="text-xs text-neutral-500 mt-2">Eclectic = best Stableford per hole (H1–H18) across all uploaded events.</p>
              </section>

              {/* How-to */}
              <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6">
                <h2 className="text-lg font-semibold mb-2">How to Use</h2>
                <ol className="list-decimal pl-5 space-y-1 text-sm text-neutral-700">
                  <li>Enter your Supabase URL & anon key in <strong>Settings</strong> and click <strong>Save & Connect</strong>.</li>
                  <li>Click <strong>Import CSV</strong> and choose your Squabbit export.</li>
                  <li>Click <strong>Add Event → Season</strong> to update the league & eclectic.</li>
                  <li>Use the Export buttons for CSVs.</li>
                </ol>
              </section>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
