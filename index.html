<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Den Society — League & Eclectic (Mobile First)</title>
    <link rel="icon" href="./favicon.ico" />
    <meta name="theme-color" content="#199f57" />
    <meta property="og:title" content="Den Society — League & Eclectic" />
    <meta property="og:description" content="Event results, ratings, standings and eclectic leaderboard." />

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              squab: {
                50:'#eefbf2',100:'#d8f5e3',200:'#b4eac9',300:'#86dbab',400:'#55c787',500:'#2fb66a',600:'#199f57',700:'#147f47',800:'#12663b',900:'#0f5232'
              }
            }
          }
        }
      }
    </script>

    <!-- React + Babel + Supabase UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

    <style>
      body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
      .chip{padding:.15rem .5rem;border-radius:.5rem;border:1px solid #e5e5e5;background:#fafafa}
      .btn{padding:.5rem .75rem;border-radius:.75rem;transition:all .15s ease}
      .btn:hover{transform:translateY(-1px);box-shadow:0 1px 2px rgba(0,0,0,.08)}
      .btn-primary{background:#199f57;color:#fff}
      .btn-outline{border:1px solid #d4d4d4;background:#fff}
      @media print{ .hide-print{display:none!important} }
    </style>
  </head>
  <body class="bg-neutral-50 text-neutral-900">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
      /* global React, ReactDOM, supabase */
      const { useState, useMemo, useRef, useEffect } = React;

      // ---------- utilities from your original app ----------
      const POINTS_TABLE = [20,17,15,13,11,9,8,7,6,5,4,3,2,1];
      const clamp=(n,lo,hi)=>Math.max(lo,Math.min(hi,n));
      const csvEscape=s=>{ if(s==null) return ""; const str=String(s); return /[",\n]/.test(str) ? '"'+str.replace(/"/g,'""')+'"' : str; };
      const downloadCSV=(filename, rows)=>{ const csv=rows.map(r=>r.map(csvEscape).join(",")).join("\n"); const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); };
      const to1=x=>Math.round((Number(x)||0)*10)/10;
      function toast(msg){ try{ const t=document.createElement('div'); t.className='fixed bottom-4 right-4 px-3 py-2 rounded-lg bg-black text-white text-sm shadow z-50'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .2s'; setTimeout(()=>t.remove(),220); }, 1400);}catch{}}
      function splitFirstLast(fullName){ const raw=(fullName||'').trim().replace(/\s+/g,' '); if(!raw) return {first:'',last:''}; const parts=raw.split(' '); if(parts.length===1) return {first:parts[0],last:''}; const last=parts.pop(); return {first:parts.join(' '), last}; }

      const isTeamLike = name => {
        const s=(name||'').trim();
        return /^(team(\s*\d+)?)$/i.test(s) || /^team average$/i.test(s) || /^stableford$/i.test(s) || /^strokeplay$/i.test(s) || /^players?$/i.test(s) || /^round\s*\d+$/i.test(s) || /^(out|in|total|s\.i\.|par)$/i.test(s);
      };
      const looksLikePersonName = name => { const s=(name||'').trim(); if(!s) return false; if(isTeamLike(s)) return false; if(!/[A-Za-z]/.test(s)) return false; if(s.length<3) return false; return true; };

      // Handicap maths
      function playingCapByGender(g){ return g==="F"?36:28; }
      function rangeForHcap(h){ if(h<=9)return"0-9"; if(h<=18)return"10-18"; if(h<=28)return"19-28"; return"29-36"; }
      function cutPerPointOver34(h){ const r=rangeForHcap(h); return r==="0-9"?0.5:r==="10-18"?1:r==="19-28"?1:1.5; }
      function winnerBonusCut(h){ const r=rangeForHcap(h); return r==="0-9"?1:r==="10-18"?2:r==="19-28"?2.5:3; }
      function computeNewExactHandicap(start,g,pts,b9,w){ const startPlay=Math.round(start); let exact=start; if(pts>=35){exact-=cutPerPointOver34(startPlay)*(pts-34);} else if(pts<=31){ exact+=0.5*(32-pts);} if(w) exact-=winnerBonusCut(startPlay); const max=playingCapByGender(g); const bounded=clamp(exact,0,60); const nextPlay=clamp(Math.round(bounded),0,max); return {nextExact:bounded,nextPlaying:nextPlay}; }

      // CSV parser (shortened: same behaviour as your original)
      function splitSmart(raw){ const d = raw.includes('\t') ? '\t' : (raw.includes(';') ? ';' : ','); return raw.split(d).map(s => (s||'').replace(/^"|"$/g,'').trim()); }
      function toNum(x){ const v=parseFloat(String(x==null?'':x).replace(/[^0-9.\-]/g,'')); return Number.isFinite(v)?v:NaN; }
      function readStablefordPerHole(row){ let start=-1; for(let i=0;i<row.length;i++){ if(String(row[i]).trim().toLowerCase()==='stableford'){ start=i; break; } } if(start<0) return null; const vals=[]; for(let j=start+1;j<row.length && vals.length<18;j++){ const raw=String(row[j]||'').trim(); if(raw==='') continue; if(raw==='P'||raw==='p'||'\\'===raw){ vals.push(0); continue; } const n=parseFloat(raw.replace(/[^0-9.\-]/g,'')); if(Number.isFinite(n)&&n>=0&&n<=6) vals.push(n);} while(vals.length<18) vals.push(0); return vals.slice(0,18); }
      function parseSquabbitCSV(text){
        const rows=text.replace(/\r/g,'').split('\n'); const lines=rows.map(splitSmart);
        // roster
        let playerHeaderRow=-1; for(let i=0;i<lines.length;i++){ if((lines[i][0]||'')==='Name' && (lines[i][1]||'')==='Hdcp'){ playerHeaderRow=i; break; } }
        const players=[]; if(playerHeaderRow>=0){ for(let i=playerHeaderRow+1;i<lines.length;i++){ const name=(lines[i][0]||'').trim(); if(!name) break; if(isTeamLike(name)) continue; const hcap=parseFloat((lines[i][1]||'').trim()); if(!Number.isNaN(hcap)) players.push({name,handicap:hcap,gender:'M'}); } }
        const totals={};
        for(let i=0;i<lines.length;i++){
          const a=(lines[i][0]||'').trim(); if(!a||!looksLikePersonName(a)) continue;
          const b=toNum(lines[i][1]); const c=toNum(lines[i][2]);
          if(Number.isFinite(b)||Number.isFinite(c)) totals[a]=Number.isFinite(c)?c:b;
        }
        const holeData={};
        for(let pi=0;pi<players.length;pi++){
          const p=players[pi];
          for(let i=0;i<lines.length-1;i++){
            if((lines[i][0]||'').trim()===p.name){ const stRow=lines[i+1]||[]; let hasStable=false; for(let j=0;j<stRow.length;j++){ if(String(stRow[j]).trim().toLowerCase()==='stableford'){ hasStable=true; break; } } if(!hasStable) continue; const perHole=readStablefordPerHole(stRow); const back9=perHole.slice(9).reduce((a,b)=>a+(Number(b)||0),0); holeData[p.name]={perHole,back9}; break; }
          }
          if(!holeData[p.name]) holeData[p.name]={perHole:Array(18).fill(0), back9:0};
        }
        return { players: players.map(p=>({ name:p.name, gender:p.gender, handicap:p.handicap, points: totals[p.name]||0, back9:(holeData[p.name]&&holeData[p.name].back9)||0, perHole:(holeData[p.name]&&holeData[p.name].perHole)||[] })) };
      }

      // Countback
      function compareByCountback(a,b){ const pa=(a.perHole||[]).slice(0,18), pb=(b.perHole||[]).slice(0,18); const sum=(arr,s,e)=>arr.slice(s,e).reduce((x,y)=>x+(Number(y)||0),0); const aB9=sum(pa,9,18), bB9=sum(pb,9,18); if(aB9!==bB9) return bB9-aB9; const aL6=sum(pa,12,18), bL6=sum(pb,12,18); if(aL6!==bL6) return bL6-aL6; const aL3=sum(pa,15,18), bL3=sum(pb,15,18); if(aL3!==bL3) return bL3-aL3; for(let i=17;i>=0;i--){ const ai=Number(pa[i])||0, bi=Number(pb[i])||0; if(ai!==bi) return bi-ai; } return 0; }

      function App(){
        // NAV: one simple dropdown to choose the view; minimal on phones
        const [view,setView] = useState('home'); // home | past | ratings | standings | eclectic

        // Supabase
        const defaultURL="https://mqknahdfpqxrpgpxqtus.supabase.co";
        const defaultKEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xa25haGRmcHF4cnBncHhxdHVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTU3MDYsImV4cCI6MjA3ODAzMTcwNn0.GTUVsrRJ-MClMg96vuHZpUtAnUFtCsJvuLiiE0D-fCc";
        const [client,setClient] = useState(null);
        const [statusMsg,setStatusMsg] = useState('Connecting…');

        const BUCKET='den-events';
        const PREFIX='events';
        const [shared,setShared]=useState([]); // {name, file, path}
        const [sharedGroups,setSharedGroups]=useState([]); // [{year, events:[] }]

        const [eventName,setEventName]=useState('Den Society Meeting');
        const [players,setPlayers]=useState([]);
        const [season,setSeason]=useState({});

        useEffect(()=>{ // init supabase + fetch
          let cancelled=false;
          async function boot(){
            try{
              if(!(window.supabase && window.supabase.createClient)){ setTimeout(boot,250); return; }
              const c = window.supabase.createClient(defaultURL, defaultKEY, { auth:{ persistSession:false }});
              if(cancelled) return; setClient(c);
              const probe = await c.from('season_standings').select('name').limit(1);
              if(cancelled) return;
              if(probe.error){ setStatusMsg('Error: '+probe.error.message); }
              else{ setStatusMsg('Connected'); await refreshShared(c); await fetchSeasonWith(c); }
            }catch(e){ if(!cancelled) setStatusMsg('Error: '+(e?.message||e)); }
          }
          boot();
          return ()=>{cancelled=true};
        },[]);

        async function refreshShared(c){
          c=c||client; if(!c) return;
          const r = await c.storage.from(BUCKET).list(PREFIX, { limit:1000, sortBy:{column:'name', order:'asc'} });
          if(r.error) return;
          const data=(r.data||[])
            .filter(x=>!x.name.startsWith('.') && /\.csv$/i.test(x.name))
            .map(x=>({ name:x.name.replace(/\.csv$/i,''), file:x.name, path: PREFIX+'/'+x.name }));
          setShared(data);
          setSharedGroups(groupByYear(data));
        }
        function groupByYear(files){
          const groups={};
          for(const f of files){ const m=f.name.match(/(20\d{2})/); const year=m?m[1]:'Unknown'; (groups[year]=groups[year]||[]).push(f); }
          return Object.keys(groups).sort((a,b)=>b.localeCompare(a)).map(y=>({year:y, events:groups[y].sort((a,b)=>a.name.localeCompare(b.name))}));
        }

        async function loadShared(item){
          if(!client) return;
          const r=await client.storage.from(BUCKET).download(item.path);
          if(r.error){ alert('Download failed: '+r.error.message); return; }
          const text=await r.data.text();
          const parsed=parseSquabbitCSV(text);
          setPlayers(parsed.players||[]);
          setEventName(item.name);
           // jump user straight to ratings once an event is picked
          toast('Event loaded');
        }

        // Computed standings from current event players (same as original, trimmed)
        const computed = useMemo(()=>{
          const rows=players.map((p,i)=>({idx:i,name:p.name,gender:p.gender,startExact:p.handicap,points:p.points,back9:p.back9,perHole:p.perHole}));
          const base=[...rows].sort((a,b)=>(b.points-a.points)||(compareByCountback(a,b)));
          if(!base.length) return [];
          const groups=[]; const used=new Set();
          for(const r of base){ if(used.has(r.idx)) continue; const grpIdxs=base.filter(x=>x.points===r.points).map(x=>x.idx); grpIdxs.forEach(id=>used.add(id)); groups.push(grpIdxs); }
          // find winner group by countback
          const topGroup=groups[0].map(i=>rows.find(r=>r.idx===i));
          let best=[topGroup[0]]; for(let k=1;k<topGroup.length;k++){ const cmp=compareByCountback(topGroup[k],best[0]); if(cmp>0) best=[topGroup[k]]; else if(cmp===0) best.push(topGroup[k]); }
          const winnerIdxSet=new Set(best.map(r=>r.idx));
          let pos=1; const out=[];
          for(let gIdx=0; gIdx<groups.length; gIdx++){
            const g=groups[gIdx]; const start=pos; const ptsValue=POINTS_TABLE[start-1]||0;
            for(const i of g){ const r=rows.find(x=>x.idx===i); const isWinner=winnerIdxSet.has(i) && (gIdx===0); const res=computeNewExactHandicap(r.startExact,r.gender,r.points,r.back9,isWinner); out.push({...r, position:start, leaguePoints:ptsValue, isWinner, nextExact:res.nextExact, nextPlaying:res.nextPlaying}); }
            pos+=g.length;
          }
          return out.sort((a,b)=>a.position-b.position);
        },[players]);

        async function fetchSeasonWith(c){
          const r = await c.from('season_standings').select('name,total_points,events,best_event_points,best_hole_points,eclectic_total,best_per_hole');
          if(r.error){ setStatusMsg('Error: '+r.error.message); return; }
          const data=r.data||[]; const map={};
          for(const rec of data){ if(isTeamLike(rec.name)) continue; let bph=[]; if(Array.isArray(rec.best_per_hole)) bph=rec.best_per_hole; else if(typeof rec.best_per_hole==='string'){ try{ bph=JSON.parse(rec.best_per_hole||'[]')||[]; }catch(e){ bph=[]; } }
            map[rec.name]={ name:rec.name, totalPoints:rec.total_points||0, events:rec.events||0, bestEventPoints:rec.best_event_points??0, bestHolePoints:rec.best_hole_points??0, eclecticTotal:rec.eclectic_total??0, bestPerHole:(bph||[]).map(n=>Number(n)||0) };
          }
          setSeason(map);
        }

        async function addEventToSeason(){
          const next={ ...season };
          for(const r of computed){ if(isTeamLike(r.name)) continue; const prev=next[r.name]||{name:r.name,totalPoints:0,events:0,bestPerHole:Array(18).fill(0),eclecticTotal:0,bestEventPoints:0,bestHolePoints:0}; const eventPerHole=(r.perHole||[]).map(v=>Math.max(0,Math.min(6,Number(v)||0))); const bestPerHole=Array.from({length:18},(_,idx)=>Math.max(prev.bestPerHole[idx]||0,eventPerHole[idx]||0)); const eclecticTotal=bestPerHole.reduce((s,v)=>s+(Number(v)||0),0); const nextBestEvent=Math.max(prev.bestEventPoints||0,r.points||0); const nextBestHole=Math.max(prev.bestHolePoints||0,Math.max.apply(null,[0].concat(eventPerHole))); next[r.name]={ name:r.name, totalPoints:(prev.totalPoints||0)+(r.leaguePoints||0), events:(prev.events||0)+1, bestEventPoints:nextBestEvent, bestHolePoints:nextBestHole, eclecticTotal, bestPerHole }; }
          setSeason(next);
          if(client){ const rows=[]; const vals=Object.values(next).filter(r=>!isTeamLike(r.name)); for(const r of vals){ rows.push({ name:r.name, total_points:r.totalPoints|0, events:r.events|0, best_event_points:(r.bestEventPoints??0)|0, best_hole_points:(r.bestHolePoints??0)|0, eclectic_total:(r.eclecticTotal??0)|0, best_per_hole:Array.isArray(r.bestPerHole)?r.bestPerHole.map(n=>Number(n)||0):Array(18).fill(0) }); }
            const u = await client.from('season_standings').upsert(rows,{onConflict:'name'}); if(u.error){ toast('Error: '+u.error.message); } else { toast('Event added to season ✓'); }
          }
        }

        // RENDERERS ------------------------------------------------------------
        function Header(){
          return (
            <header className="hide-print rounded-2xl p-4 border border-squab-700 bg-squab-600 text-white">
              <div className="flex items-center justify-between gap-2">
                <div>
                  <h1 className="text-xl md:text-2xl font-bold tracking-tight">Den Society — League & Eclectic</h1>
                  <p className="text-xs/5 opacity-90">Supabase: {statusMsg}</p>
                </div>
                <span className="hidden sm:inline-flex chip border-white/30 bg-white/10 text-white">{eventName||'Untitled Event'}</span>
              </div>
              <div className="mt-3 grid grid-cols-1 gap-2 sm:grid-cols-2">
                <select className="w-full rounded-xl border border-white/30 bg-white/10 text-white px-3 py-2" value={view} onChange={e=>setView(e.target.value)} aria-label="Choose what to view">
                  <option value="home">— Select a view —</option>
                  <option value="past">View Past Golf Events</option>
                  <option value="ratings">View Player Ratings</option>
                  <option value="standings">Check Season Standings</option>
                  <option value="eclectic">Check Eclectic Leaderboard</option>
                </select>
                <div className="flex gap-2">
                  <label className="flex-1 text-center rounded-xl border border-white/30 bg-white/10 px-3 py-2 cursor-pointer" title="Import Squabbit CSV">
                    <input type="file" accept=".csv" className="hidden" onChange={async e=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; const text=await f.text(); const parsed=parseSquabbitCSV(text); setPlayers(parsed.players||[]); setEventName((f.name||'').replace(/\.[^.]+$/,''));  }} />
                    Import CSV
                  </label>
                  <button className="btn btn-outline" onClick={()=>{ if(!computed.length) return; const rows=[["Name","Gender","Exact","Stableford","Back9","Pos","Pts","NextExact","NextPlay"]]; computed.forEach(r=>rows.push([r.name,r.gender,Math.round(r.startExact),r.points,r.back9,r.position,r.leaguePoints,r.nextExact.toFixed(1),r.nextPlaying])); downloadCSV(`DenSociety_${(eventName||'Event').replace(/[^a-z0-9]+/gi,'_')}.csv`,rows); }}>Export Event</button> <button className="btn btn-primary" disabled={!computed.length} onClick={addEventToSeason}>Add Event → Season</button>
                </div>
              </div>
            </header>
          );
        }

        function Home(){
          return (
            <section className="hide-print rounded-2xl p-4 bg-white border shadow-sm">
              <h2 className="text-lg font-semibold mb-3">Quick access</h2>
              <div className="space-y-3">
                <DropdownCard label="View Past Golf Events" onClick={()=>setView('past')} />
                <DropdownCard label="View Player Ratings" onClick={()=>setView('ratings')} />
                <DropdownCard label="Check Season Standings" onClick={()=>setView('standings')} />
                <DropdownCard label="Check Eclectic Leaderboard" onClick={()=>setView('eclectic')} />
              </div>
            </section>
          );
        }

        function DropdownCard({label,onClick}){
          return (
            <button className="w-full text-left px-4 py-3 rounded-xl border bg-neutral-50 hover:bg-neutral-100" onClick={onClick}>
              <div className="flex items-center justify-between">
                <span className="font-medium">{label}</span>
                <span>▾</span>
              </div>
            </button>
          );
        }

        function PastEvents(){
          return (
            <section className="rounded-2xl p-3 md:p-4 bg-white border shadow-sm">
              <div className="flex items-center justify-between mb-2">
                <h2 className="text-lg font-semibold">Past Den Society Golf Games</h2>
                <button className="btn btn-outline" onClick={()=>setView('home')}>Back</button>
              </div>
              {sharedGroups.length===0 && <div className="text-sm text-neutral-500 p-2">No shared CSVs yet.</div>}
              {sharedGroups.map(group=> (
                <div key={group.year} className="mb-3">
                  <div className="text-xs text-neutral-500 mb-1">{group.year}</div>
                  <select className="w-full rounded-xl border px-3 py-2 bg-white" onChange={e=>{ const idx=e.target.value; if(idx==='') return; const item=group.events[Number(idx)]; loadShared(item); }} >
                    <option value="">Select an event…</option>
                    {group.events.map((item,i)=> (<option key={item.path} value={i}>{item.name}</option>))}
                  </select>
                </div>
              ))}
            </section>
          );
        }

        function Ratings(){
          // Pars + ratings logic restored (Par-3/4/5 with badges and explanation)
          const defaultMen=[4,4,3,4,5,4,3,4,4, 4,5,4,3,4,4,5,3,4];
          const defaultWomen=[4,4,3,4,5,4,3,4,4, 4,4,5,3,4,4,5,3,4];
          const ratingLabel = avg => avg>=3?'Excellent':avg>=2.5?'Good':avg>=2?'Solid':avg>=1.5?'Needs work':'Struggle';
          const badgeClass = avg => avg>=3?'bg-emerald-100 text-emerald-800':avg>=2.5?'bg-emerald-50 text-emerald-700':avg>=2?'bg-neutral-100 text-neutral-800':avg>=1.5?'bg-amber-100 text-amber-800':'bg-red-100 text-red-800';
          const eventParAverages=(perHole,pars)=>{ const sums={3:{s:0,c:0},4:{s:0,c:0},5:{s:0,c:0}}; for(let i=0;i<Math.min(18,perHole.length);i++){ const pts=Number(perHole[i])||0; const par=Number(pars[i])||4; if(sums[par]){ sums[par].s+=pts; sums[par].c++; } } const avg=t=>sums[t].c?(sums[t].s/sums[t].c):0; return {p3:avg(3),p4:avg(4),p5:avg(5)}; };
          const effectiveMen=defaultMen, effectiveWomen=defaultWomen;

          const ratings = React.useMemo(()=>{
            const out=[]; for(const r of computed){ const pars=(r.gender==='F')?effectiveWomen:effectiveMen; const av=eventParAverages(r.perHole||[],pars); out.push({name:r.name,p3:to1(av.p3),p4:to1(av.p4),p5:to1(av.p5),total:to1(av.p3+av.p4+av.p5)}); }
            return out.sort((a,b)=> b.total-a.total || a.name.localeCompare(b.name));
          },[computed]);

          const fieldAvg = React.useMemo(()=>{ let s3m=0,c3m=0,s4m=0,c4m=0,s5m=0,c5m=0; let s3f=0,c3f=0,s4f=0,c4f=0,s5f=0,c5f=0; for(const r of computed){ const perHole=r.perHole||[]; const pars=(r.gender==='F')?effectiveWomen:effectiveMen; for(let h=0;h<Math.min(18,perHole.length);h++){ const pts=Number(perHole[h])||0, par=Number(pars[h])||4; if(r.gender==='F'){ if(par===3){s3f+=pts;c3f++;} else if(par===4){s4f+=pts;c4f++;} else if(par===5){s5f+=pts;c5f++;} } else { if(par===3){s3m+=pts;c3m++;} else if(par===4){s4m+=pts;c4m++;} else if(par===5){s5m+=pts;c5m++;} } } } const avg=(s,c)=>c?to1(s/c):0; return { men:{p3:avg(s3m,c3m),p4:avg(s4m,c4m),p5:avg(s5m,c5m)}, women:{p3:avg(s3f,c3f),p4:avg(s4f,c4f),p5:avg(s5f,c5f)} };
          },[computed]);

          return (
            <section className="rounded-2xl p-3 md:p-5 bg-white border shadow-sm">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-semibold">Player Ratings — {eventName||'This Event'}</h2>
                <button className="btn btn-outline" onClick={()=>setView('home')}>Back</button>
              </div>

              <div className="overflow-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="border-b text-left">
                      <th>Name</th>
                      <th>Par-3 avg</th><th>Par-3 rating</th>
                      <th>Par-4 avg</th><th>Par-4 rating</th>
                      <th>Par-5 avg</th><th>Par-5 rating</th>
                    </tr>
                  </thead>
                  <tbody>
                    {ratings.length===0 && (
                      <tr><td colSpan="7" className="py-3 text-neutral-500">Import a Squabbit CSV or pick one from Past Events to see ratings.</td></tr>
                    )}
                    {ratings.map(r=> (
                      <tr key={r.name} className="border-b">
                        <td className="font-medium">{r.name}</td>
                        <td>{r.p3.toFixed(1)}</td>
                        <td><span className={`px-2 py-0.5 rounded-lg text-xs font-medium ${badgeClass(r.p3)}`}>{ratingLabel(r.p3)}</span></td>
                        <td>{r.p4.toFixed(1)}</td>
                        <td><span className={`px-2 py-0.5 rounded-lg text-xs font-medium ${badgeClass(r.p4)}`}>{ratingLabel(r.p4)}</span></td>
                        <td>{r.p5.toFixed(1)}</td>
                        <td><span className={`px-2 py-0.5 rounded-lg text-xs font-medium ${badgeClass(r.p5)}`}>{ratingLabel(r.p5)}</span></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              <div className="mt-3">
                <details className="rounded-xl border border-neutral-200 bg-neutral-50 p-2 text-[11px] leading-snug text-neutral-800">
                  <summary className="cursor-pointer font-medium">How to read this</summary>
                  <ul className="list-disc pl-5 space-y-0.5 mt-2">
                    <li><strong>2 Stableford points = net par</strong> (3 = net birdie, 4 = net eagle, 1 = net bogey, 0 = worse/pick-up).</li>
                    <li>We average per-hole Stableford by par type (<strong>Par-3</strong>, <strong>Par-4</strong>, <strong>Par-5</strong>).</li>
                    <li>Badges: Excellent ≥ 3.0, Good ≥ 2.5, Solid ≥ 2.0, Needs work ≥ 1.5, Struggle &lt; 1.5.</li>
                    <li>Field benchmark — Men: P3 {fieldAvg.men.p3}, P4 {fieldAvg.men.p4}, P5 {fieldAvg.men.p5}. Women: P3 {fieldAvg.women.p3}, P4 {fieldAvg.women.p4}, P5 {fieldAvg.women.p5}.</li>
                  </ul>
                </details>
              </div>
            </section>
          );
        }

        function Standings(){
          const list = Object.values(season).filter(r=>!isTeamLike(r.name)).sort((a,b)=>(b.totalPoints-a.totalPoints)||a.name.localeCompare(b.name));
          return (
            <section className="rounded-2xl p-3 md:p-5 bg-white border shadow-sm">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-semibold">Season Standings</h2>
                <div className="flex gap-2">
                  <button className="btn btn-outline" onClick={()=>setView('home')}>Back</button>
                  <button className="btn btn-primary" onClick={()=>{ const rows=[["Rank","Name","Events","Total Points","Best Event","Best Hole","Eclectic Total"]]; list.forEach((r,i)=>rows.push([i+1,r.name,r.events,r.totalPoints,r.bestEventPoints??0,r.bestHolePoints??0,r.eclecticTotal??0])); downloadCSV('DenSociety_Standings.csv',rows); }}>Export</button>
                </div>
              </div>
              <div className="overflow-auto">
                <table className="min-w-full text-sm"><thead><tr className="border-b text-left"><th>Rank</th><th>Name</th><th>Events</th><th>Total</th><th>Best Event</th><th>Best Hole</th><th>Eclectic</th></tr></thead>
                  <tbody>
                    {list.length===0 && <tr><td colSpan="7" className="py-3 text-neutral-500">No season data found.</td></tr>}
                    {list.map((r,i)=>(<tr key={r.name} className="border-b"><td>{i+1}</td><td>{r.name}</td><td>{r.events}</td><td>{r.totalPoints}</td><td>{r.bestEventPoints??0}</td><td>{r.bestHolePoints??0}</td><td>{r.eclecticTotal??0}</td></tr>))}
                  </tbody>
                </table>
              </div>
            </section>
          );
        }

        function Eclectic(){
          const list = Object.values(season).filter(r=>!isTeamLike(r.name)).sort((a,b)=>((b.eclecticTotal??0)-(a.eclecticTotal??0))||a.name.localeCompare(b.name));
          return (
            <section className="rounded-2xl p-3 md:p-5 bg-white border shadow-sm">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-semibold">Eclectic Leaderboard</h2>
                <div className="flex gap-2">
                  <button className="btn btn-outline" onClick={()=>setView('home')}>Back</button>
                  <button className="btn btn-primary" onClick={()=>{ const header=["Rank","Name","Eclectic Total"].concat(Array.from({length:18},(_,i)=>'H'+(i+1))); const rows=[header]; for(let i=0;i<list.length;i++){ const r=list[i]; const bph=(Array.isArray(r.bestPerHole)?r.bestPerHole:Array(18).fill(0)); rows.push([i+1,r.name,r.eclecticTotal??0].concat(bph)); } downloadCSV('DenSociety_Eclectic.csv',rows); }}>Export</button>
                </div>
              </div>
              <div className="overflow-auto">
                <table className="min-w-full text-sm">
                  <thead><tr className="border-b text-left"><th>Rank</th><th>Name</th><th>Eclectic Total</th>{Array.from({length:18},(_,i)=>(<th key={i}>H{i+1}</th>))}</tr></thead>
                  <tbody>
                    {list.length===0 && <tr><td colSpan="21" className="py-3 text-neutral-500">No eclectic yet.</td></tr>}
                    {list.map((r,i)=>(<tr key={r.name} className="border-b"><td>{i+1}</td><td>{r.name}</td><td>{r.eclecticTotal??0}</td>{(Array.isArray(r.bestPerHole)?r.bestPerHole:Array(18).fill(0)).map((v,ix)=>(<td key={ix}>{v}</td>))}</tr>))}
                  </tbody>
                </table>
              </div>
            </section>
          );
        }

        return (
          <div className="min-h-screen p-4 sm:p-6">
            <div className="max-w-4xl mx-auto space-y-4">
              <Header />
              {view==='home' && <Home />}
              {view==='past' && <PastEvents />}
              {view==='ratings' && <Ratings />}
              {view==='standings' && <Standings />}
              {view==='eclectic' && <Eclectic />}
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
  </body>
</html>
