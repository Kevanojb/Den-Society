<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Den Society — Event Ratings (Auto Par from Squabbit)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
      .owner-only{display:none}
      .owner-on .owner-only{display:block}
      .mono{font-variant-numeric:tabular-nums}
    </style>
  </head>
  <body class="bg-neutral-50 text-neutral-900">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
      const { useMemo, useState, useEffect } = React;

      // ---------- Small utils ----------
      const csvEscape = s => { if (s==null) return ""; const str=String(s); return /[",\n]/.test(str) ? '"' + str.replace(/"/g,'""') + '"' : str; };
      const downloadCSV = (filename, rows) => {
        const csv = rows.map(r=>r.map(csvEscape).join(",")).join("\n");
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"}); const a=document.createElement("a");
        a.href=URL.createObjectURL(blob); a.download=filename; a.click();
      };
      const ratingLabel = avg => avg>=3?'Excellent':avg>=2.5?'Good':avg>=2?'Solid':avg>=1.5?'Needs work':'Struggle';
      const ratingColor = avg => avg>=3?'text-emerald-700':avg>=2.5?'text-emerald-600':avg>=2?'text-neutral-700':avg>=1.5?'text-amber-700':'text-red-700';
      const makeDefaultPars = () => [4,4,3,4,5,4,3,4,4, 4,5,4,3,4,4,5,3,4];
      const isTeamLike = name => /^(team(\s*\d+)?)$/i.test(name||'') || /^team average$/i.test(name||'') || /^stableford$/i.test(name||'');

      // ---------- CSV parsing ----------
      function splitSmart(raw){
        const d = raw.includes('\t')? '\t' : ',';
        return raw.split(d).map(s => (s||'').replace(/^"|"$/g,'').trim());
      }
      function asNums(arr){
        return arr.map(x => {
          const v = parseFloat(String(x||'').replace(/[^0-9.\-]/g,''));
          return Number.isFinite(v) ? v : null;
        });
      }

      // Find "Par" rows anywhere; return best 18-hole candidate (front/back or full)
      function detectParsFromLines(lines){
        const candidates = [];
        for (let i=0;i<lines.length;i++){
          const row = lines[i];
          // any cell exactly "Par" (case-insensitive)
          const hasPar = row.some(c => String(c).toLowerCase() === 'par');
          if(!hasPar) continue;

          // Collect numeric cells from this row
          const nums = asNums(row).filter(n => n!==null);
          if (nums.length >= 18) {
            // take first 18
            candidates.push({ kind:'row18', score:18, arr: nums.slice(0,18) });
            continue;
          }
          if (nums.length >= 8 && nums.length <= 10) {
            // Could be a 9-hole par row (front or back); try to pair with next Par row
            // Look ahead up to 6 rows for another Par row with ~9 numbers
            for (let j=i+1; j<Math.min(lines.length, i+7); j++){
              const row2 = lines[j];
              const hasPar2 = row2.some(c => String(c).toLowerCase() === 'par');
              if(!hasPar2) continue;
              const nums2 = asNums(row2).filter(n=>n!==null);
              if (nums2.length >= 8 && nums2.length <= 10) {
                const joined = [...nums, ...nums2].slice(0,18);
                if (joined.length === 18) {
                  candidates.push({ kind:'row9+9', score:18, arr: joined });
                }
              }
            }
          }
        }
        // Heuristic: prefer any exact-18 candidate, else the first 9+9
        const exact18 = candidates.find(c => c.arr.length===18);
        if (exact18) return exact18.arr.map(n => Math.round(n));
        if (candidates.length) return candidates[0].arr.map(n => Math.round(n));
        return null;
      }

      function parseSquabbitCSV(text){
        const rows = text.replace(/\r/g,'').split('\n').filter(Boolean);
        const lines = rows.map(splitSmart);

        // Detect pars before anything else
        const detectedPars = detectParsFromLines(lines);

        // Players block
        const playerHeaderRow = lines.findIndex(r=>(r[0]||'')==='Name' && (r[1]||'')==='Hdcp');
        const players = [];
        if (playerHeaderRow >= 0){
          for (let i=playerHeaderRow+1; i<lines.length; i++){
            const name = (lines[i][0]||'').trim();
            const hcap = parseFloat((lines[i][1]||'').trim());
            if(!name) break;
            if(!Number.isNaN(hcap)) players.push({name, handicap:hcap, gender:'M'});
          }
        }

        // Stableford summary totals
        const stablefordSectionRow = lines.findIndex(r=>(r[0]||'')==='Stableford');
        const totals = {};
        if (stablefordSectionRow >= 0){
          for(let i=stablefordSectionRow+2;i<lines.length;i++){
            const name=(lines[i][0]||'').trim(); if(!name) break;
            const r1 = parseFloat((lines[i][1]||'').trim());
            if(!Number.isNaN(r1)) totals[name]=r1;
          }
        }

        // Per-hole Stableford from detailed card (row i: name, row i+1 has "Stableford")
        const holeData = {};
        const getNum = x => {
          const v = parseFloat(String(x||'').replace(/[^0-9.\-]/g,''));
          return Number.isFinite(v) ? v : 0;
        };
        for(const p of players){
          for(let i=0;i<lines.length-1;i++){
            if((lines[i]?.[0]||'').trim()===p.name && (lines[i+1]?.[1]||'').trim()==='Stableford'){
              const st = lines[i+1]||[];
              const perHole = [...st.slice(3,12).map(getNum), ...st.slice(13,22).map(getNum)];
              holeData[p.name] = { perHole };
              break;
            }
          }
        }

        const outPlayers = players.map(p=>({
          name:p.name,
          gender:p.gender,
          handicap:p.handicap,
          points: totals[p.name]||0,
          perHole: holeData[p.name]?.perHole || []
        }));

        return { players: outPlayers, detectedPars };
      }

      // Per-event par-type averages (Stableford)
      function eventParAverages(perHole, pars){
        let sums={3:{s:0,c:0}, 4:{s:0,c:0}, 5:{s:0,c:0}};
        for(let i=0;i<Math.min(18, perHole.length); i++){
          const pts = Number(perHole[i])||0;
          const par = Number(pars[i])||4;
          if (sums[par]) { sums[par].s += pts; sums[par].c++; }
        }
        const avg = t => sums[t].c ? (sums[t].s / sums[t].c) : 0;
        return { p3: avg(3), p4: avg(4), p5: avg(5), counts:{p3:sums[3].c,p4:sums[4].c,p5:sums[5].c} };
      }

      function App(){
        const [ownerMode,setOwnerMode] = useState(false);
        const [players,setPlayers] = useState([]);
        const [autoPars,setAutoPars] = useState(null);   // detected from CSV
        const [overridePars,setOverridePars] = useState(''); // owner edit box (optional)

        const coursePars = useMemo(()=>{
          // precedence: override if valid → detected → default
          const fromOverride = (()=> {
            if(!overridePars) return null;
            try{
              const arr = overridePars.split(',').map(s=>parseInt(s.trim(),10)).filter(Number.isFinite);
              return arr.length===18 ? arr : null;
            }catch{ return null; }
          })();
          return fromOverride || autoPars || makeDefaultPars();
        }, [autoPars, overridePars]);

        // Owner debug: which holes are 3/4/5
        const holeDebug = useMemo(()=>{
          const holes={3:[],4:[],5:[]};
          (coursePars||[]).forEach((p,i)=>{ if([3,4,5].includes(p)) holes[p].push(i+1); });
          return holes;
        }, [coursePars]);

        async function importCSV(file){
          const text = await file.text();
          const parsed = parseSquabbitCSV(text);
          setPlayers(parsed.players||[]);
          setAutoPars(parsed.detectedPars || null);
        }

        // Ratings for THIS EVENT ONLY
        const ratings = useMemo(()=>{
          const out=[];
          for(const p of players){
            if(isTeamLike(p.name)) continue;
            const {p3,p4,p5} = eventParAverages(p.perHole||[], coursePars);
            out.push({
              name: p.name,
              p3, p4, p5,
              r3: ratingLabel(p3), r4: ratingLabel(p4), r5: ratingLabel(p5),
              c3: ratingColor(p3), c4: ratingColor(p4), c5: ratingColor(p5),
              total: (p3+p4+p5)
            });
          }
          out.sort((a,b)=> b.total - a.total || a.name.localeCompare(b.name));
          return out;
        }, [players, coursePars]);

        // Field average (THIS EVENT)
        const fieldAvg = useMemo(()=>{
          let s3=0,c3=0,s4=0,c4=0,s5=0,c5=0;
          for(const p of players){
            if(isTeamLike(p.name)) continue;
            const perHole = p.perHole||[];
            for(let i=0;i<Math.min(18, perHole.length); i++){
              const pts = Number(perHole[i])||0;
              const par = Number(coursePars[i])||4;
              if(par===3){ s3+=pts; c3++; } else if(par===4){ s4+=pts; c4++; } else if(par===5){ s5+=pts; c5++; }
            }
          }
          const a3=c3?s3/c3:0, a4=c4?s4/c4:0, a5=c5?s5/c5:0;
          return {
            p3:a3, p4:a4, p5:a5,
            r3: ratingLabel(a3), r4: ratingLabel(a4), r5: ratingLabel(a5),
            c3: ratingColor(a3), c4: ratingColor(a4), c5: ratingColor(a5)
          };
        }, [players, coursePars]);

        return (
          <div className={"min-h-screen p-4 sm:p-6 md:p-8 "+(ownerMode?"owner-on":"")}>
            <div className="max-w-5xl mx-auto space-y-6">
              <header className="flex items-baseline justify-between gap-2">
                <h1 className="text-2xl font-bold cursor-pointer select-none" onClick={()=>setOwnerMode(o=>!o)}>
                  Den Society — Event Ratings
                </h1>
                <span className="text-xs text-neutral-500">Click title for owner debug</span>
              </header>

              {/* Import */}
              <section className="bg-white p-4 rounded-xl shadow-sm">
                <h2 className="font-semibold mb-2">Import Event CSV (Squabbit export)</h2>
                <label className="border rounded-xl px-3 py-2 inline-block cursor-pointer bg-white">
                  Choose CSV
                  <input type="file" accept=".csv" className="hidden"
                         onChange={e=>{const f=e.target.files?.[0]; if(f) importCSV(f);}} />
                </label>
                <p className="text-xs text-neutral-600 mt-2">
                  Pars are auto-detected from the file (front/back or full 18). If detection fails, a default is used.
                </p>

                {/* Owner-only debug + manual override */}
                <div className="owner-only mt-3 rounded-lg border border-neutral-200 p-3 bg-neutral-50">
                  <div className="text-sm font-medium mb-1">Owner Debug</div>
                  <div className="text-xs mono">
                    <div>Detected pars: { (autoPars && autoPars.length===18) ? autoPars.join(', ') : '(none — using default)' }</div>
                    <div>Using pars: { coursePars.join(', ') }</div>
                    <div>Par-3 holes: {holeDebug[3].join(', ')||'—'}</div>
                    <div>Par-4 holes: {holeDebug[4].join(', ')||'—'}</div>
                    <div>Par-5 holes: {holeDebug[5].join(', ')||'—'}</div>
                  </div>
                  <div className="mt-2">
                    <label className="text-xs block mb-1">Override pars (comma-separated 18 values, leave blank to use auto)</label>
                    <input className="w-full border rounded-lg p-2 mono bg-white"
                           value={overridePars}
                           onChange={e=>setOverridePars(e.target.value)} placeholder="e.g. 4,4,3,4,5,4,3,4,4,4,5,4,3,4,4,5,3,4" />
                  </div>
                </div>
              </section>

              {/* Ratings — this event */}
              <section className="bg-white p-4 rounded-xl shadow-sm">
                <div className="flex items-center justify-between mb-2">
                  <h2 className="font-semibold">Ratings — Par 3 / Par 4 / Par 5 (This Event)</h2>
                  <button
                    className="px-3 py-2 rounded-2xl bg-black text-white disabled:opacity-40"
                    disabled={!ratings.length}
                    onClick={()=>{
                      const rows = [["Name","Par-3 avg","Par-3 rating","Par-4 avg","Par-4 rating","Par-5 avg","Par-5 rating"]];
                      if (ratings.length) {
                        rows.push([
                          "Field Average",
                          fieldAvg.p3.toFixed(1), fieldAvg.r3,
                          fieldAvg.p4.toFixed(1), fieldAvg.r4,
                          fieldAvg.p5.toFixed(1), fieldAvg.r5
                        ]);
                      }
                      ratings.forEach(r=>{
                        rows.push([r.name, r.p3.toFixed(1), r.r3, r.p4.toFixed(1), r.r4, r.p5.toFixed(1), r.r5]);
                      });
                      downloadCSV(`DenSociety_EventRatings_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.csv`, rows);
                    }}
                  >Export Ratings</button>
                </div>
                <p className="text-xs text-neutral-600 mb-3">
                  Based on Stableford in the loaded CSV. Pars are read from the file automatically.
                </p>
                <div className="overflow-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                      <tr className="border-b text-left">
                        <th>Name</th>
                        <th>Par-3 avg</th><th>Par-3 rating</th>
                        <th>Par-4 avg</th><th>Par-4 rating</th>
                        <th>Par-5 avg</th><th>Par-5 rating</th>
                      </tr>
                    </thead>
                    <tbody>
                      {ratings.length>0 && (
                        <tr className="border-b bg-neutral-50 font-semibold">
                          <td>Field Average</td>
                          <td>{fieldAvg.p3.toFixed(1)}</td><td className={fieldAvg.c3}>{fieldAvg.r3}</td>
                          <td>{fieldAvg.p4.toFixed(1)}</td><td className={fieldAvg.c4}>{fieldAvg.r4}</td>
                          <td>{fieldAvg.p5.toFixed(1)}</td><td className={fieldAvg.c5}>{fieldAvg.r5}</td>
                        </tr>
                      )}
                      {ratings.map(r=>(
                        <tr key={r.name} className="border-b">
                          <td className="font-medium">{r.name}</td>
                          <td>{r.p3.toFixed(1)}</td><td className={r.c3}>{r.r3}</td>
                          <td>{r.p4.toFixed(1)}</td><td className={r.c4}>{r.r4}</td>
                          <td>{r.p5.toFixed(1)}</td><td className={r.c5}>{r.r5}</td>
                        </tr>
                      ))}
                      {!ratings.length && (
                        <tr><td colSpan="7" className="py-3 text-neutral-500">Import a Squabbit CSV to see ratings for this event.</td></tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </section>

            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>

