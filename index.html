<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Den Society ‚Äî League & Eclectic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
    <style>
      body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
      .mono{font-variant-numeric:tabular-nums}
      .chip{padding:.15rem .5rem;border-radius:.5rem;border:1px solid #e5e5e5;background:#fafafa}
      .btn{padding:0.5rem 0.75rem;border-radius:0.75rem}
      .btn-xs{padding:0.25rem 0.5rem;border-radius:0.5rem;font-size:.75rem;line-height:1rem}
      .btn-primary{background:#111;color:#fff}
      .btn-indigo{background:#4f46e5;color:#fff}
      .btn-emerald{background:#059669;color:#fff}
      .btn-outline{border:1px solid #d4d4d4;background:#fff}
      .btn-danger{border:1px solid #fecaca;color:#b91c1c;background:#fff}

      /* Accordion styles */
      .acc-toggle {
        width: 100%;
        background: #0f172a;
        color: #fff;
        padding: 12px 16px;
        border-radius: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1rem;
        border: 2px solid #1f2937;
      }
      .acc-toggle .left { display:flex; align-items:center; gap:10px; }
      .acc-badge{ font-size:.75rem; padding:2px 8px; border-radius:999px; background:#111827; border:1px solid #374151; }
      .acc-help{ font-size:.8rem; opacity:.85; }
      .chev { transition: transform .25s ease; }
      .chev.open { transform: rotate(180deg); }

      .acc-body { overflow:hidden; max-height:0; transition:max-height .35s ease; }
      .acc-body.open { max-height: 1200px; }

      .year-block { margin-top:10px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:10px; }
      .year-title { margin:0 0 8px; font-size:.95rem; font-weight:700; color:#334155; }
      .event-row { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
      .event-btn { flex:1; background:#fff; padding:10px 12px; border-radius:12px; text-align:left; border:1px solid #e5e7eb; }
      .event-btn:hover { background:#f3f4f6; }
      .back-to-past { margin:8px 0 0; padding:8px 12px; background:#e5e7eb; border-radius:10px; }

      /* Actions accordion style variant */
      .acc-actions { background:#111827; border-color:#334155; }
    </style>
  </head>
  <body class="bg-neutral-50 text-neutral-900">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
      /* global React, ReactDOM, supabase */
      const { useMemo, useState, useEffect, useRef } = React;

      // ---------- Small utils ----------
      const POINTS_TABLE = [20,17,15,13,11,9,8,7,6,5,4,3,2,1];
      const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));
      const csvEscape = s => { if (s==null) return ""; const str=String(s); return /[",\n]/.test(str) ? '"' + str.replace(/"/g,'""') + '"' : str; };
      const downloadCSV = (filename, rows) => { const csv = rows.map(r=>r.map(csvEscape).join(",")).join("\n"); const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); };
      const to1 = x => Math.round((Number(x)||0)*10)/10;
      const prettyDate = (iso) => { try { const d=new Date(iso); return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});} catch { return iso||''; } };
      function splitFirstLast(fullName){ const raw=(fullName||'').trim().replace(/\s+/g,' '); if(!raw) return {first:'',last:''}; const parts=raw.split(' '); if(parts.length===1) return {first:parts[0],last:''}; const last=parts.pop(); return {first:parts.join(' '), last}; }

      // ---------- Handicap maths ----------
      function playingCapByGender(g){ return g==="F"?36:28; }
      function rangeForHcap(h){ if(h<=9)return"0-9"; if(h<=18)return"10-18"; if(h<=28)return"19-28"; return"29-36"; }
      function cutPerPointOver34(h){ const r=rangeForHcap(h); return r==="0-9"?0.5:r==="10-18"?1:r==="19-28"?1:1.5; }
      function winnerBonusCut(h){ const r=rangeForHcap(h); return r==="0-9"?1:r==="10-18"?2:r==="19-28"?2.5:3; }
      function computeNewExactHandicap(start,g,pts,b9,w){
        const startPlay=Math.round(start); let exact=start;
        if(pts>=35){exact-=cutPerPointOver34(startPlay)*(pts-34);} else if(pts<=31){ exact+=0.5*(32-pts);} 
        if(w) exact-=winnerBonusCut(startPlay);
        const max=playingCapByGender(g);
        const bounded=clamp(exact,0,60);
        const nextPlay=clamp(Math.round(bounded),0,max);
        return {nextExact:bounded,nextPlaying:nextPlay};
      }

      // ---------- Name filters ----------
      const isTeamLike = name => {
        const s = (name||'').trim();
        return (
          /^(team(\s*\d+)?)$/i.test(s) ||
          /^team average$/i.test(s) ||
          /^stableford$/i.test(s) ||
          /^strokeplay$/i.test(s) ||
          /^players?$/i.test(s) ||
          /^round\s*\d+$/i.test(s) ||
          /^out$/i.test(s) ||
          /^in$/i.test(s) ||
          /^total$/i.test(s) ||
          /^s\.i\.$/i.test(s) ||
          /^par$/i.test(s)
        );
      };
      const looksLikePersonName = name => {
        const s = (name||'').trim();
        if (!s) return false;
        if (isTeamLike(s)) return false;
        if (!/[A-Za-z]/.test(s)) return false;
        if (s.length < 3) return false;
        return true;
      };

      // ---------- Supabase (embedded config; no UI controls) ----------
      function normalizeUrl(u){ if(!u) return ''; let s=String(u).trim().replace(/\/+$/,''); if(!/^https?:\/\//i.test(s)) s='https://'+s; try{ const url=new URL(s); return `https://${url.host}`; }catch{ return ''; } }
      function cleanKey(k){ return (k||'').replace(/[^ -~]/g,'').trim(); }
      function makeSupabaseClient(url, key){
        const u=normalizeUrl(url), k=cleanKey(key);
        if(!u||!k) return null;
        if(!(window.supabase && window.supabase.createClient)) throw new Error('supabase-js SDK did not load');
        return window.supabase.createClient(u, k, { auth:{ persistSession:false }});
      }
      async function probe(client){
        try{
          const res = await client.from('season_standings').select('name').limit(1);
          if (res.error) return { ok:false, status:res.status, msg:res.error.message };
          return { ok:true, status:200, msg:'Connected' };
        } catch(e){
          return { ok:false, status:0, msg:String(e && e.message ? e.message : e) };
        }
      }

      // ---------- CSV parsing ----------
      function splitSmart(raw){
        const d = raw.includes('\t') ? '\t' : (raw.includes(';') ? ';' : ',');
        return raw.split(d).map(s => (s||'').replace(/^"|"$/g,'').trim());
      }
      function toNum(x){ const v=parseFloat(String(x == null ? '' : x).replace(/[^0-9.\-]/g,'')); return Number.isFinite(v)?v:NaN; }
      function detectBothParsFromLines(lines){
        function scanParRow(row){
          const pars=[];
          for(let i=0;i<row.length;i++){
            const s=String(row[i]||'').trim();
            if(/^(par|pars|out|in|total)$/i.test(s)) continue;
            const r=Math.round(toNum(s));
            if(r===3||r===4||r===5){ pars.push(r); if(pars.length===18) break; }
          }
          return pars.length===18?pars:null;
        }
        const parRows = lines.filter(r => r.some(c => /^pars?$/i.test(String(c).trim())));
        let detected = null;
        for(let i=0;i<parRows.length;i++){ const cand=scanParRow(parRows[i]); if(cand){ detected=cand; break; } }
        if(!detected && parRows.length>=2){
          const nines=[];
          for(let i=0;i<parRows.length;i++){
            const row=parRows[i];
            const nums=row.map(toNum).map(n=>Math.round(n)).filter(r=>r===3||r===4||r===5);
            if(nums.length>=9) nines.push(nums.slice(0,9));
          }
          if(nines.length>=2) detected=[].concat(nines[0], nines[1]).slice(0,18);
        }
        if(!detected){
          for(let i=0;i<lines.length;i++){
            const row=lines[i];
            const nums=row.map(toNum).map(n=>Math.round(n)).filter(v=>v===3||v===4||v===5);
            if(nums.length>=18){ detected=nums.slice(0,18); break; }
          }
        }
        return { men: detected||null, women: detected||null };
      }
      function readStablefordPerHole(row){
        let start=-1;
        for(let i=0;i<row.length;i++){ if(String(row[i]).trim().toLowerCase()==='stableford'){ start=i; break; } }
        if(start<0) return null;
        const vals=[];
        for(let j=start+1;j<row.length && vals.length<18;j++){
          const raw=String(row[j]||'').trim();
          if(raw==='') continue;
          if(raw==='P'||raw==='p'||'\\'===raw){ vals.push(0); continue; }
          const n=parseFloat(raw.replace(/[^0-9.\-]/g,''));
          if(Number.isFinite(n) && n>=0 && n<=6) vals.push(n);
        }
        while(vals.length<18) vals.push(0);
        return vals.slice(0,18);
      }
      function parseSquabbitCSV(text){
        const rows=text.replace(/\r/g,'').split('\n');
        const lines=rows.map(splitSmart);
        const detectedBoth=detectBothParsFromLines(lines);

        // Optional roster (Name/Hdcp)
        let playerHeaderRow=-1;
        for(let i=0;i<lines.length;i++){
          if((lines[i][0]||'')==='Name' && (lines[i][1]||'')==='Hdcp'){ playerHeaderRow=i; break; }
        }
        const players=[];
        if(playerHeaderRow>=0){
          for(let i=playerHeaderRow+1;i<lines.length;i++){
            const name=(lines[i][0]||'').trim();
            if(!name) break;
            if(isTeamLike(name)) continue;
            const hcap=parseFloat((lines[i][1]||'').trim());
            if(!Number.isNaN(hcap)) players.push({name:name,handicap:hcap,gender:'M'});
          }
        }

        // Gender hints
        const genderMap={};
        for(let r=0;r<lines.length;r++){
          const row=lines[r];
          const nm=(row[0]||'').trim(); if(!nm) continue;
          const tee=String(row[1]||'').toLowerCase();
          if(/women|ladies|red tee/.test(tee)) genderMap[nm]='F';
          else if(genderMap[nm]==null) genderMap[nm]='M';
        }
        for(let p=0;p<players.length;p++){ const pl=players[p]; if(genderMap[pl.name]) pl.gender=genderMap[pl.name]; }

        // Totals under a "Stableford" header
        let totalsStart=-1;
        for(let i=0;i<lines.length;i++){ if(/^stableford$/i.test((lines[i][0]||'').trim())) { totalsStart=i; break; } }
        const totals={};
        if(totalsStart>=0){
          for(let i=totalsStart+1;i<lines.length;i++){
            const row=lines[i];
            const a=(row[0]||'').trim();
            const b=toNum(row[1]);
            const c=toNum(row[2]);
            if(!a){ if(i>totalsStart+1) break; else continue; }
            if(!looksLikePersonName(a)) continue;
            const pts=Number.isFinite(c)?c:(Number.isFinite(b)?b:NaN);
            if(Number.isFinite(pts)) totals[a]=pts;
            if(!players.some(p=>p.name===a)){
              players.push({name:a,handicap:0,gender:(genderMap[a]||'M')});
            }
          }
        }

        // Per-hole from cards
        const holeData={};
        for(let pi=0;pi<players.length;pi++){
          const p=players[pi];
          for(let i=0;i<lines.length-1;i++){
            if((lines[i][0]||'').trim()===p.name){
              const stRow=lines[i+1]||[];
              let hasStable=false;
              for(let j=0;j<stRow.length;j++){ if(String(stRow[j]).trim().toLowerCase()==='stableford'){ hasStable=true; break; } }
              if(!hasStable) continue;
              const perHole=readStablefordPerHole(stRow);
              const back9=perHole.slice(9).reduce((a,b)=>a+(Number(b)||0),0);
              holeData[p.name]={perHole:perHole, back9:back9};
              break;
            }
          }
          if(!holeData[p.name]) holeData[p.name]={perHole:Array(18).fill(0), back9:0};
        }

        return {
          detectedMen: detectedBoth.men,
          detectedWomen: detectedBoth.women,
          players: players.map(function(p){
            return {
              name:p.name,
              gender:p.gender,
              handicap:p.handicap,
              points: totals[p.name] || 0,
              back9: (holeData[p.name] && holeData[p.name].back9) || 0,
              perHole: (holeData[p.name] && holeData[p.name].perHole) || []
            };
          })
        };
      }

      // ---------- Ratings ----------
      const ratingLabel = avg => avg>=3?'Excellent':avg>=2.5?'Good':avg>=2?'Solid':avg>=1.5?'Needs work':'Struggle';
      const badgeClass = avg =>
        avg>=3   ? 'bg-emerald-100 text-emerald-800' :
        avg>=2.5 ? 'bg-emerald-50  text-emerald-700' :
        avg>=2   ? 'bg-neutral-100 text-neutral-800' :
        avg>=1.5 ? 'bg-amber-100  text-amber-800' :
                   'bg-red-100    text-red-800';
      const defaultMen=[4,4,3,4,5,4,3,4,4, 4,5,4,3,4,4,5,3,4];
      const defaultWomen=[4,4,3,4,5,4,3,4,4, 4,4,5,3,4,4,5,3,4];

      function eventParAverages(perHole, pars){
        const sums={3:{s:0,c:0},4:{s:0,c:0},5:{s:0,c:0}};
        for(let i=0;i<Math.min(18,perHole.length);i++){
          const pts=Number(perHole[i])||0;
          const par=Number(pars[i])||4;
          if(sums[par]){ sums[par].s+=pts; sums[par].c++; }
        }
        const avg=t=>sums[t].c?(sums[t].s/sums[t].c):0;
        return {p3:avg(3),p4:avg(4),p5:avg(5)};
      }

      // ---------- Countback ----------
      function compareByCountback(a, b){
        const pa=(a.perHole||[]).slice(0,18), pb=(b.perHole||[]).slice(0,18);
        const sum=(arr,s,e)=>arr.slice(s,e).reduce((x,y)=>x+(Number(y)||0),0);
        const aB9=sum(pa,9,18), bB9=sum(pb,9,18); if(aB9!==bB9) return bB9-aB9;
        const aL6=sum(pa,12,18), bL6=sum(pb,12,18); if(aL6!==bL6) return bL6-aL6;
        const aL3=sum(pa,15,18), bL3=sum(pb,15,18); if(aL3!==bL3) return bL3-aL3;
        for(let i=17;i>=0;i--){ const ai=Number(pa[i])||0, bi=Number(pb[i])||0; if(ai!==bi) return bi-ai; }
        return 0;
      }

      // ---------- App ----------
      function App(){
        // Supabase client (embedded)
        const defaultURL="https://mqknahdfpqxrpgpxqtus.supabase.co";
        const defaultKEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xa25haGRmcHF4cnBncHhxdHVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTU3MDYsImV4cCI6MjA3ODAzMTcwNn0.GTUVsrRJ-MClMg96vuHZpUtAnUFtCsJvuLiiE0D-fCc"; // consider moving to server if bucket isn't fully public
        const [client,setClient]=useState(null);
        const [statusMsg,setStatusMsg]=useState('Not connected');

        const BUCKET='den-events';
        const PREFIX='events';
        const [shared,setShared]=useState([]);
        const [sharedGroups,setSharedGroups]=useState([]);
        const [pastOpen,setPastOpen]=useState(false);
        const [showBackBtn,setShowBackBtn]=useState(false);

        const eventPlayersTopRef=useRef(null);

        useEffect(()=>{
          let cancelled=false;
          async function boot(){
            try{
              if(!(window.supabase && window.supabase.createClient)){ setTimeout(boot,500); return; }
              const c=makeSupabaseClient(defaultURL, defaultKEY);
              if(!c){ setStatusMsg('Invalid Supabase config'); return; }
              if(cancelled) return;
              setClient(c);
              const res=await probe(c);
              if(cancelled) return;
              setStatusMsg(res.ok?'Connected':('Error '+res.status+': '+res.msg));
              if(res.ok){ await fetchSeasonWith(c); await refreshShared(c); }
            }catch(e){ if(!cancelled) setStatusMsg('Error: '+String(e && e.message ? e.message : e)); }
          }
          boot();
          return()=>{cancelled=true;};
        },[]);

        async function refreshShared(c){
          c = c || client;
          if(!c) return;
          const r = await c.storage.from(BUCKET).list(PREFIX, { limit: 1000, sortBy: { column:'name', order:'asc' }});
          if(r.error){ console.warn(r.error); return; }
          const data = r.data || [];
          const items=data
            .filter(x=>!x.name.startsWith('.') && /\.csv$/i.test(x.name))
            .map(x=>({ name: x.name.replace(/\.csv$/i,''), file: x.name, path: PREFIX+'/'+x.name }));
          setShared(items);
          setSharedGroups(groupByYear(items));
        }

        function groupByYear(files){
          const groups={};
          for(let i=0;i<files.length;i++){
            const f=files[i];
            const m = f.name.match(/(20\d{2})/);
            const year = m ? m[1] : 'Unknown';
            if(!groups[year]) groups[year]=[];
            groups[year].push(f);
          }
          const years = Object.keys(groups).sort((a,b)=>b.localeCompare(a));
          return years.map(function(yr){
            return { year: yr, events: groups[yr].sort((a,b)=>a.name.localeCompare(b.name)) };
          });
        }

        async function loadShared(item){
          if(!client) return;
          const r = await client.storage.from(BUCKET).download(item.path);
          if(r.error){ alert('Download failed: '+r.error.message); return; }
          const text = await r.data.text();
          const parsed = parseSquabbitCSV(text);
          setPlayers(parsed.players||[]);
          setDetectedMen(parsed.detectedMen||null);
          setDetectedWomen(parsed.detectedWomen||null);
          setUseDetected(true);
          setEventName(item.name);

          // collapse past list + show back button
          setPastOpen(false);
          setShowBackBtn(true);

          // scroll to the top of the Event Players section
          requestAnimationFrame(()=>{
            const el = eventPlayersTopRef.current;
            if(el){ el.scrollIntoView({ behavior:'smooth', block:'start' }); }
          });
        }

        async function downloadShared(item){
          if(!client) return;
          const r = await client.storage.from(BUCKET).download(item.path);
          if(r.error){ alert('Download failed: '+r.error.message); return; }
          const a=document.createElement('a');
          a.href=URL.createObjectURL(r.data);
          a.download=item.file;
          a.click();
        }

        // Event + season data
        const [eventName,setEventName]=useState("Den Society Meeting");
        const [dateStr,setDateStr]=useState(()=>new Date().toISOString().slice(0,10));
        const [players,setPlayers]=useState([]);
        const [season,setSeason]=useState({});

        // Pars state
        const [detectedMen,setDetectedMen]=useState(null);
        const [detectedWomen,setDetectedWomen]=useState(null);
        const [useDetected,setUseDetected]=useState(true);
        const [parsMenStr,setParsMenStr]=useState(defaultMen.join(','));
        const [parsWomenStr,setParsWomenStr]=useState(defaultWomen.join(','));
        const manualMen=useMemo(()=>{ try{ const arr=parsMenStr.split(',').map(s=>parseInt(s.trim(),10)).filter(Number.isFinite); return arr.length===18?arr:defaultMen; }catch(e){ return defaultMen; }},[parsMenStr]);
        const manualWomen=useMemo(()=>{ try{ const arr=parsWomenStr.split(',').map(s=>parseInt(s.trim(),10)).filter(Number.isFinite); return arr.length===18?arr:defaultWomen; }catch(e){ return defaultWomen; }},[parsWomenStr]);
        const effectiveMen=useMemo(()=> (useDetected && Array.isArray(detectedMen) && detectedMen.length===18) ? detectedMen : manualMen, [useDetected, detectedMen, manualMen]);
        const effectiveWomen=useMemo(()=> (useDetected && Array.isArray(detectedWomen) && detectedWomen.length===18) ? detectedWomen : manualWomen, [useDetected, detectedWomen, manualWomen]);

        async function importCSV(file){
          try{
            const text=await file.text();
            const parsed=parseSquabbitCSV(text);
            setPlayers(parsed.players||[]);
            setDetectedMen(parsed.detectedMen||null);
            setDetectedWomen(parsed.detectedWomen||null);
            if(parsed.detectedMen){ setUseDetected(true); }
            if(file && file.name){ const base=file.name.replace(/\.[^.]+$/,''); if(base) setEventName(base); }
          }catch(e){
            alert("Couldn't read CSV: "+(e && e.message ? e.message : e));
          }
        }

        function resetSeasonLocal(){ setSeason({}); }

        // Winners via countback (ties after all checks share winners‚Äô cut & 20 pts)
        function compareByCountbackLocal(a,b){ return compareByCountback(a,b); }
        const computed=useMemo(()=>{
          const rows=players.map((p,i)=>({idx:i,name:p.name,gender:p.gender,startExact:p.handicap,points:p.points,back9:p.back9,perHole:p.perHole}));
          const base=[].concat(rows).sort((a,b)=>(b.points-a.points)||(compareByCountbackLocal(a,b)));
          if(!base.length) return [];
          const groups=[]; const used=new Set();
          for(let gi=0;gi<base.length;gi++){
            const r=base[gi];
            if(used.has(r.idx)) continue;
            const grpIdxs=base.filter(x=>x.points===r.points).map(x=>x.idx);
            grpIdxs.forEach(id=>used.add(id));
            groups.push(grpIdxs);
          }
          const topGroup=groups[0].map(i=>rows.find(r=>r.idx===i));
          let best=[topGroup[0]];
          for(let k=1;k<topGroup.length;k++){
            const cmp=compareByCountbackLocal(topGroup[k],best[0]);
            if(cmp>0) best=[topGroup[k]]; else if(cmp===0) best.push(topGroup[k]);
          }
          const winnerIdxSet=new Set(best.map(r=>r.idx));

          let pos=1; const out=[];
          for(let gIdx=0; gIdx<groups.length; gIdx++){
            const g=groups[gIdx];
            const start=pos; const ptsValue=POINTS_TABLE[start-1]||0;
            for(let ii=0; ii<g.length; ii++){
              const i=g[ii];
              const r=rows.find(x=>x.idx===i);
              const isWinner=winnerIdxSet.has(i) && (gIdx===0);
              const res=computeNewExactHandicap(r.startExact,r.gender,r.points,r.back9,isWinner);
              out.push({
                idx:r.idx,name:r.name,gender:r.gender,startExact:r.startExact,points:r.points,back9:r.back9,perHole:r.perHole,
                position:start,leaguePoints:ptsValue,isWinner:isWinner,nextExact:res.nextExact,nextPlaying:res.nextPlaying
              });
            }
            pos+=g.length;
          }
          return out.sort((a,b)=>a.position-b.position);
        },[players]);

        // Supabase season I/O
        async function fetchSeasonWith(c){
          const r = await c.from('season_standings').select('name,total_points,events,best_event_points,best_hole_points,eclectic_total,best_per_hole');
          if(r.error){ setStatusMsg('Error: '+r.error.message); return; }
          const data=r.data||[];
          const map={};
          for(let i=0;i<data.length;i++){
            const rec=data[i];
            if(isTeamLike(rec.name)) continue;
            let bph = [];
            if(Array.isArray(rec.best_per_hole)) bph=rec.best_per_hole;
            else if(typeof rec.best_per_hole==='string'){ try{ bph=JSON.parse(rec.best_per_hole||'[]')||[]; }catch(e){ bph=[]; } }
            map[rec.name]={
              name:rec.name,
              totalPoints: rec.total_points || 0,
              events: rec.events || 0,
              bestEventPoints: (rec.best_event_points!=null ? rec.best_event_points : 0),
              bestHolePoints: (rec.best_hole_points!=null ? rec.best_hole_points : 0),
              eclecticTotal: (rec.eclectic_total!=null ? rec.eclectic_total : 0),
              bestPerHole: (bph||[]).map(n=>Number(n)||0)
            };
          }
          setSeason(map);
        }

        async function addEventToSeason(){
          const next={};
          const keys=Object.keys(season);
          for(let i=0;i<keys.length;i++){ next[keys[i]]=season[keys[i]]; }

          for(let i=0;i<computed.length;i++){
            const r=computed[i];
            if(isTeamLike(r.name)) continue;
            const prev=next[r.name]||{name:r.name,totalPoints:0,events:0,bestPerHole:Array(18).fill(0),eclecticTotal:0,bestEventPoints:0,bestHolePoints:0};
            const eventPerHole=(r.perHole||[]).map(v=>Math.max(0,Math.min(6,Number(v)||0)));
            const bestPerHole=Array.from({length:18},(_,idx)=>Math.max(prev.bestPerHole[idx]||0,eventPerHole[idx]||0));
            const eclecticTotal=bestPerHole.reduce((s,v)=>s+(Number(v)||0),0);
            const nextBestEvent=Math.max(prev.bestEventPoints||0,r.points||0);
            const nextBestHole=Math.max(prev.bestHolePoints||0,Math.max.apply(null,[0].concat(eventPerHole)));
            next[r.name]={
              name:r.name,
              totalPoints:(prev.totalPoints||0)+(r.leaguePoints||0),
              events:(prev.events||0)+1,
              bestEventPoints:nextBestEvent,
              bestHolePoints:nextBestHole,
              eclecticTotal:eclecticTotal,
              bestPerHole:bestPerHole
            };
          }
          setSeason(next);
          if(client){
            const rows=[];
            const vals=Object.values(next).filter(r=>!isTeamLike(r.name));
            for(let i=0;i<vals.length;i++){
              const r=vals[i];
              rows.push({
                name:r.name,
                total_points:r.totalPoints|0,
                events:r.events|0,
                best_event_points:(r.bestEventPoints!=null?r.bestEventPoints:0)|0,
                best_hole_points:(r.bestHolePoints!=null?r.bestHolePoints:0)|0,
                eclectic_total:(r.eclecticTotal!=null?r.eclecticTotal:0)|0,
                best_per_hole:Array.isArray(r.bestPerHole)?r.bestPerHole.map(n=>Number(n)||0):Array(18).fill(0),
              });
            }
            const u = await client.from('season_standings').upsert(rows,{onConflict:'name'});
            if(u.error) setStatusMsg('Error: '+u.error.message); else setStatusMsg('Connected');
          }
        }

        // Ratings (this event)
        const ratings=useMemo(()=>{
          const out=[];
          for(let i=0;i<players.length;i++){
            const p=players[i];
            if(isTeamLike(p.name)) continue;
            const pars=(p.gender==='F')?effectiveWomen:effectiveMen;
            const av=eventParAverages(p.perHole||[],pars);
            out.push({name:p.name,p3:to1(av.p3),p4:to1(av.p4),p5:to1(av.p5),total:(av.p3+av.p4+av.p5)});
          }
          return out.sort((a,b)=> b.total-a.total || a.name.localeCompare(b.name));
        },[players,effectiveMen,effectiveWomen]);

        const fieldAvg=useMemo(()=>{
          let s3m=0,c3m=0,s4m=0,c4m=0,s5m=0,c5m=0;
          let s3f=0,c3f=0,s4f=0,c4f=0,s5f=0,c5f=0;
          for(let i=0;i<players.length;i++){
            const p=players[i];
            if(isTeamLike(p.name)) continue;
            const perHole=p.perHole||[];
            const pars=(p.gender==='F')?effectiveWomen:effectiveMen;
            for(let h=0;h<Math.min(18,perHole.length);h++){
              const pts=Number(perHole[h])||0, par=Number(pars[h])||4;
              if(p.gender==='F'){ if(par===3){s3f+=pts;c3f++;} else if(par===4){s4f+=pts;c4f++;} else if(par===5){s5f+=pts;c5f++;} }
              else{ if(par===3){s3m+=pts;c3m++;} else if(par===4){s4m+=pts;c4m++;} else if(par===5){s5m+=pts;c5m++;} }
            }
          }
          const avg=(s,c)=>c?to1(s/c):0;
          return {men:{p3:avg(s3m,c3m),p4:avg(s4m,c4m),p5:avg(s5m,c5m)}, women:{p3:avg(s3f,c3f),p4:avg(s4f,c4f),p5:avg(s5f,c5f)}};
        },[players,effectiveMen,effectiveWomen]);

        // ---------- UI ----------
        return (
          <div className="min-h-screen p-4 sm:p-6 md:p-8">
            <div className="max-w-6xl mx-auto space-y-6">

              {/* Header */}
              <header className="flex flex-col md:flex-row md:items-end gap-3 justify-between">
                <div className="flex-1">
                  <h1 className="text-2xl md:text-3xl font-bold tracking-tight">Den Society ‚Äî League & Eclectic</h1>
                  <p className="text-xs text-neutral-500">Supabase: {statusMsg}</p>
                </div>
                <div className="flex gap-2 items-center w-full md:w-auto md:min-w-[520px]">
                  <input className="flex-1 min-w-0 px-3 py-2 rounded-xl border border-neutral-300 bg-white" value={eventName} onChange={e=>setEventName(e.target.value)} placeholder="Event name" />
                  <input type="date" className="w-[200px] px-3 py-2 rounded-xl border border-neutral-300 bg-white" value={dateStr} onChange={e=>setDateStr(e.target.value)} />
                </div>
              </header>

              {/* Past Games (dropdown) */}
              <section className="bg-white rounded-2xl shadow-sm p-3 md:p-4">
                <div id="pastEventsTop"></div>
                <button type="button" className="acc-toggle" id="past-events-button" aria-controls="past-events-panel" aria-expanded={pastOpen ? 'true':'false'} onClick={()=>setPastOpen(v=>!v)}>
                  <div className="left">
                    <span className="text-base font-semibold">Past Den Society Golf Games</span>
                    <span className="acc-badge">{shared.length} file{shared.length===1?'':'s'}</span>
                    <span className="acc-help hidden sm:inline">Tap to {pastOpen?'close':'open'}</span>
                  </div>
                  <span className={`chev ${pastOpen?'open':''}`}>‚ñæ</span>
                </button>

                <div id="past-events-panel" role="region" aria-labelledby="past-events-button" className={`acc-body ${pastOpen?'open':''}`}>
                  {sharedGroups.length===0 && <div className="text-sm text-neutral-500 p-2">No shared CSVs yet.</div>}
                  {sharedGroups.map(group=>
                    (<div key={group.year} className="year-block">
                      <h4 className="year-title">{group.year}</h4>
                      {group.events.map(item=>
                        (<div key={item.path} className="event-row">
                          <button type="button" className="event-btn" onClick={()=>loadShared(item)}>{item.name}</button>
                          <button type="button" className="btn btn-xs btn-outline" onClick={()=>downloadShared(item)}>Download</button>
                        </div>)
                      )}
                    </div>)
                  )}
                </div>
              </section>

              {/* Back to Past Events (appears after loading) */}
              {showBackBtn && (
                <div className="flex">
                  <button
                    type="button"
                    className="back-to-past"
                    onClick={()=>{
                      setPastOpen(true);
                      const p = document.getElementById('pastEventsTop');
                      if(p){ p.scrollIntoView({ behavior:'smooth', block:'start' }); }
                      setShowBackBtn(false);
                    }}
                  >
                    ‚Üê Back to Past Events
                  </button>
                </div>
              )}

              {/* Event Players */}
              <section ref={eventPlayersTopRef} id="eventPlayersSection" className="bg-white rounded-2xl shadow-sm p-4 md:p-6">
                <div className="flex items-center justify-between mb-2">
                  <h2 className="text-lg font-semibold">Event Players</h2>
                </div>

                {/* Event Actions dropdown */}
                <EventActions
                  onImport={(file)=>importCSV(file)}
                  onAddEvent={addEventToSeason}
                  canAct={!!players.length}
                  exportEvent={()=>{
                    const rows = [];
                    rows.push(["Event",eventName,"Date",dateStr]);
                    rows.push([]);
                    rows.push(["Name","Gender","Exact","Stableford","Back9","Pos","Pts","NextExact","NextPlay"]);
                    computed.forEach(r=>{
                      rows.push([r.name,r.gender,Math.round(r.startExact),r.points,r.back9,r.position,r.leaguePoints,r.nextExact.toFixed(1),r.nextPlaying]);
                    });
                    downloadCSV(`DenSociety_${dateStr.replace(/-/g,'')}.csv`, rows);
                  }}
                  exportSquabbit={()=>{
                    if(!computed.length) return;
                    const rows=[["First","Last","Handicap"]];
                    computed.filter(r=>r && r.name && !isTeamLike(r.name)).forEach(r=>{
                      const nm=splitFirstLast(r.name);
                      const h=Number.isFinite(r.nextPlaying)?r.nextPlaying.toFixed(1):(Number.isFinite(r.startExact)?Number(r.startExact).toFixed(1):"0.0");
                      rows.push([nm.first,nm.last,h]);
                    });
                    downloadCSV(`DenSociety_SquabbitUpdate_${dateStr.replace(/-/g,'')}.csv`, rows);
                  }}
                />

                <div className="flex items-center gap-2 mb-4">
                  <span className="chip mono">{eventName || "Untitled Event"}</span>
                  <span className="chip mono">{prettyDate(dateStr)}</span>
                </div>

                <div className="overflow-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                      {/* Gender removed; Next PH -> New Handicap */}
                      <tr className="border-b text-left"><th>#</th><th>Name</th><th>Handicap</th><th>Stableford</th><th>Back9</th><th>Pts</th><th>New Handicap</th></tr>
                    </thead>
                    <tbody>
                      {computed.length===0 && (<tr><td colSpan="7" className="py-3 text-neutral-500">Import a Squabbit CSV or Load from Past Games.</td></tr>)}
                      {computed.map((r,i)=>(
                        <tr key={i} className="border-b">
                          <td>{r.position}</td>
                          <td className="whitespace-nowrap">
                            {r.name}
                            {r.isWinner && (
                              <span className="ml-1 align-middle" title="Event winner" aria-label="Event winner" role="img">üèÜ</span>
                            )}
                          </td>
                          <td>{Math.round(r.startExact)}</td>
                          <td>{r.points}</td>
                          <td>{r.back9}</td>
                          <td>{r.leaguePoints}</td>
                          <td>{r.nextPlaying}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                <p className="text-xs text-neutral-500 mt-2">Ties share the highest available slot. Winner(s) by countback: Back 9 ‚Üí Last 6 ‚Üí Last 3 ‚Üí 18th ‚Üí 17th ‚Ä¶ 1st. If still tied, both are winners and both receive the winner‚Äôs cut.</p>
              </section>

              {/* Ratings */}
              <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-lg font-semibold">
                    {`Ratings ‚Äî Par 3 / Par 4 / Par 5 ‚Äî ${eventName || "This Event"}`}
                  </h2>
                  <button type="button" className="btn btn-primary disabled:opacity-40" disabled={!ratings.length}
                    onClick={()=>{
                      const rows=[["Name","Par-3 avg","Par-3 rating","Par-4 avg","Par-4 rating","Par-5 avg","Par-5 rating"]];
                      rows.push(["FIELD (Men)", fieldAvg.men.p3, ratingLabel(fieldAvg.men.p3), fieldAvg.men.p4, ratingLabel(fieldAvg.men.p4), fieldAvg.men.p5, ratingLabel(fieldAvg.men.p5)]);
                      rows.push(["FIELD (Women)", fieldAvg.women.p3, ratingLabel(fieldAvg.women.p3), fieldAvg.women.p4, ratingLabel(fieldAvg.women.p4), fieldAvg.women.p5, ratingLabel(fieldAvg.women.p5)]);
                      ratings.forEach(r=>rows.push([r.name, r.p3, ratingLabel(r.p3), r.p4, ratingLabel(r.p4), r.p5, ratingLabel(r.p5)]));
                      downloadCSV(`DenSociety_EventRatings_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.csv`, rows);
                    }}>Export Ratings</button>
                </div>

                {/* Make ‚ÄúHow to read this‚Äù smaller / tighter */}
                <div className="rounded-xl border border-neutral-200 bg-neutral-50 p-2 text-[11px] leading-snug text-neutral-800 mb-3">
                  <div className="font-medium mb-1">How to read this</div>
                  <ul className="list-disc pl-5 space-y-0.5">
                    <li><strong>2 Stableford points = net par</strong> (3 = net birdie, 4 = net eagle, 1 = net bogey, 0 = worse/pick-up).</li>
                    <li>We average your per-hole Stableford by par type (<strong>Par-3</strong>, <strong>Par-4</strong>, <strong>Par-5</strong>) for this event.</li>
                    <li>Colour badges:
                      <span className="ml-1 rounded px-1 py-0.5 text-[10px] bg-emerald-100 text-emerald-800">Excellent ‚â• 3.0</span>,
                      <span className="ml-1 rounded px-1 py-0.5 text-[10px] bg-emerald-50 text-emerald-700">Good ‚â• 2.5</span>,
                      <span className="ml-1 rounded px-1 py-0.5 text-[10px] bg-neutral-100 text-neutral-800">Solid ‚â• 2.0</span>,
                      <span className="ml-1 rounded px-1 py-0.5 text-[10px] bg-amber-100 text-amber-800">Needs work ‚â• 1.5</span>,
                      <span className="ml-1 rounded px-1 py-0.5 text-[10px] bg-red-100 text-red-800">Struggle &lt; 1.5</span>.
                    </li>
                  </ul>
                </div>

                <div className="mb-3">
                  <div className="text-xs text-neutral-600 mb-1">H1‚ÄìH18 Pars in use:</div>
                  <div className="mono text-sm overflow-auto">
                    <div className="flex items-center gap-2 mb-1"><span className="chip mono">Men</span> <span>{effectiveMen.join(', ')}</span></div>
                    <div className="flex items-center gap-2"><span className="chip mono">Women</span> <span>{effectiveWomen.join(', ')}</span></div>
                  </div>
                </div>
                <div className="overflow-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                      <tr className="border-b text-left">
                        <th>Name</th>
                        <th>Par-3 avg</th><th>Par-3 rating</th>
                        <th>Par-4 avg</th><th>Par-4 rating</th>
                        <th>Par-5 avg</th><th>Par-5 rating</th>
                      </tr>
                    </thead>
                    <tbody>
                      {ratings.map(r=>
                        (<tr key={r.name} className="border-b">
                          <td className="font-medium">{r.name}</td>
                          <td>{r.p3.toFixed(1)}</td>
                          <td><span className={`px-2 py-0.5 rounded-lg text-xs font-medium ${badgeClass(r.p3)}`}>{ratingLabel(r.p3)}</span></td>
                          <td>{r.p4.toFixed(1)}</td>
                          <td><span className={`px-2 py-0.5 rounded-lg text-xs font-medium ${badgeClass(r.p4)}`}>{ratingLabel(r.p4)}</span></td>
                          <td>{r.p5.toFixed(1)}</td>
                          <td><span className={`px-2 py-0.5 rounded-lg text-xs font-medium ${badgeClass(r.p5)}`}>{ratingLabel(r.p5)}</span></td>
                        </tr>)
                      )}
                      {!ratings.length && (<tr><td colSpan="7" className="py-3 text-neutral-500">Import or Load a CSV to see ratings.</td></tr>)}
                    </tbody>
                  </table>
                </div>
              </section>

              {/* Season standings */}
              <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6">
                <div className="flex justify-between mb-4">
                  <h2 className="text-lg font-semibold">Season Standings</h2>
                  <div className="flex gap-2">
                    <button type="button" onClick={()=>{
                      const sorted=Object.values(season).filter(r=>!isTeamLike(r.name)).sort((a,b)=>(b.totalPoints-a.totalPoints)||a.name.localeCompare(b.name));
                      const rows=[["Rank","Name","Events","Total Points","Best Event","Best Hole","Eclectic Total"]];
                      sorted.forEach((r,i)=>rows.push([i+1,r.name,r.events,r.totalPoints,(r.bestEventPoints!=null?r.bestEventPoints:0),(r.bestHolePoints!=null?r.bestHolePoints:0),(r.eclecticTotal!=null?r.eclecticTotal:0)]));
                      downloadCSV(`DenSociety_Standings_${dateStr.replace(/-/g,'')}.csv`,rows);
                    }} className="btn btn-primary">Export Standings</button>
                    <button type="button" onClick={resetSeasonLocal} className="btn btn-danger" title="Clears local season table only (does not touch Supabase)">Reset Season (local)</button>
                  </div>
                </div>
                <div className="overflow-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                      <tr className="border-b text-left">
                        <th>Rank</th><th>Name</th><th>Events</th><th>Total Points</th><th>Best Event</th><th>Best Hole</th><th>Eclectic Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.values(season).filter(r=>!isTeamLike(r.name))
                        .sort((a,b)=>(b.totalPoints-a.totalPoints)||a.name.localeCompare(b.name))
                        .map((r,i)=>(
                        <tr key={r.name} className="border-b">
                          <td>{i+1}</td><td>{r.name}</td><td>{r.events}</td><td>{r.totalPoints}</td>
                          <td>{r.bestEventPoints != null ? r.bestEventPoints : 0}</td><td>{r.bestHolePoints != null ? r.bestHolePoints : 0}</td><td>{r.eclecticTotal != null ? r.eclecticTotal : 0}</td>
                        </tr>
                      ))}
                      {Object.values(season).filter(r=>!isTeamLike(r.name)).length===0 && <tr><td colSpan="7" className="py-3 text-neutral-500">No season data yet.</td></tr>}
                    </tbody>
                  </table>
                </div>
              </section>

              {/* Eclectic leaderboard */}
              <section className="bg-white rounded-2xl shadow-sm p-4 md:p-6">
                <div className="flex justify-between mb-4">
                  <h2 className="text-lg font-semibold">Eclectic Leaderboard</h2>
                  <div className="flex gap-2">
                    <button type="button" onClick={()=>{
                      const list=Object.values(season).filter(r=>!isTeamLike(r.name))
                        .sort((a,b)=>(((b.eclecticTotal!=null?b.eclecticTotal:0))-((a.eclecticTotal!=null?a.eclecticTotal:0)))||a.name.localeCompare(b.name));
                      const header=["Rank","Name","Eclectic Total"].concat(Array.from({length:18},(_,i)=> 'H'+(i+1)));
                      const rows=[header];
                      for(let i=0;i<list.length;i++){
                        const r=list[i];
                        const bph=(Array.isArray(r.bestPerHole)?r.bestPerHole:Array(18).fill(0));
                        rows.push([i+1,r.name,(r.eclecticTotal!=null?r.eclecticTotal:0)].concat(bph));
                      }
                      downloadCSV(`DenSociety_Eclectic_${dateStr.replace(/-/g,'')}.csv`,rows);
                    }} className="btn btn-primary" disabled={Object.values(season).filter(r=>!isTeamLike(r.name)).length===0}>Export Eclectic CSV</button>
                  </div>
                </div>
                <div className="overflow-auto">
                  <table className="min-w-full text-sm mono">
                    <thead>
                      <tr className="border-b text-left">
                        <th>Rank</th><th>Name</th><th>Eclectic Total</th>
                        {Array.from({length:18},(_,i)=>(<th key={i}>H{i+1}</th>))}
                      </tr>
                    </thead>
                    <tbody>
                      {Object.values(season).filter(r=>!isTeamLike(r.name))
                        .sort((a,b)=>(((b.eclecticTotal!=null?b.eclecticTotal:0))-((a.eclecticTotal!=null?a.eclecticTotal:0)))||a.name.localeCompare(b.name))
                        .map((r,i)=>(
                        <tr key={r.name} className="border-b">
                          <td>{i+1}</td><td>{r.name}</td><td>{r.eclecticTotal != null ? r.eclecticTotal : 0}</td>
                          {(Array.isArray(r.bestPerHole)?r.bestPerHole:Array(18).fill(0)).map((v,ix)=>(<td key={ix}>{v}</td>))}
                        </tr>
                      ))}
                      {Object.values(season).filter(r=>!isTeamLike(r.name)).length===0 && <tr><td colSpan="21" className="py-3 text-neutral-500">No eclectic yet ‚Äî add an event to season.</td></tr>}
                    </tbody>
                  </table>
                </div>
                <p className="text-xs text-neutral-500 mt-2">Eclectic = best Stableford per hole (H1‚ÄìH18) across all uploaded events.</p>
              </section>

            </div>
          </div>
        );
      }

      // Separate component: Event Actions accordion
      function EventActions({ onImport, onAddEvent, canAct, exportEvent, exportSquabbit }){
        const [open,setOpen]=React.useState(false);
        const fileInputRef=React.useRef(null);

        return (
          <div className="mb-4">
            <button type="button" className="acc-toggle acc-actions" id="event-actions-button" aria-controls="event-actions-panel" aria-expanded={open ? 'true':'false'} onClick={()=>setOpen(v=>!v)}>
              <div className="left">
                <span className="text-base font-semibold">Event Actions</span>
                <span className="acc-help hidden sm:inline">Tap to {open?'hide':'show'}</span>
              </div>
              <span className={`chev ${open?'open':''}`}>‚ñæ</span>
            </button>
            <div id="event-actions-panel" role="region" aria-labelledby="event-actions-button" className={`acc-body ${open?'open':''}`}>
              <div className="p-3 grid sm:grid-cols-2 lg:grid-cols-3 gap-2">
                <label className="px-3 py-2 rounded-xl border border-neutral-300 bg-white cursor-pointer text-center">
                  Import Squabbit CSV
                  <input
                    ref={fileInputRef}
                    type="file" accept=".csv" className="hidden"
                    onChange={e=>{ const f=e.target.files&&e.target.files[0]; if(f && onImport) onImport(f); e.target.value=''; }}
                  />
                </label>
                <button type="button" onClick={onAddEvent} disabled={!canAct} className="px-3 py-2 rounded-xl bg-emerald-600 text-white disabled:opacity-40">Add Event ‚Üí Season</button>
                <button type="button" onClick={exportEvent} disabled={!canAct} className="btn btn-primary disabled:opacity-40">Export Event CSV</button>
                <button type="button" onClick={exportSquabbit} disabled={!canAct} className="btn btn-indigo disabled:opacity-40" title="Exports First, Last, Handicap for Squabbit">Export to Squabbit (Handicaps)</button>
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
